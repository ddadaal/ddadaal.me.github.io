<!DOCTYPE html><html lang="zh-CN" class="scroll-smooth"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/54c4c90f0e4aaa79.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/fe1e54f11bde7158.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/0e452e629ebb050b.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/550cc6711c036586.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/84af3e6cc7365e2a.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-1304466d85e75d46.js"/><script src="/_next/static/chunks/79b3e8d8-3ee8badaaf61aebc.js" async=""></script><script src="/_next/static/chunks/919-686fd648ee068a73.js" async=""></script><script src="/_next/static/chunks/main-app-1f8d22ea4bb2d2c3.js" async=""></script><script src="/_next/static/chunks/c556396d-6bde9789d0a41114.js" async=""></script><script src="/_next/static/chunks/845-a0203995fac91684.js" async=""></script><script src="/_next/static/chunks/57-3951d65188499c8f.js" async=""></script><script src="/_next/static/chunks/325-924239ad7bda233c.js" async=""></script><script src="/_next/static/chunks/app/layout-7026065b75b2b00f.js" async=""></script><script src="/_next/static/chunks/app/page-6cd03741a79daf91.js" async=""></script><script src="/_next/static/chunks/7a1bdfe6-8f7609c25899d936.js" async=""></script><script src="/_next/static/chunks/c4aeae87-2a85323a0275cbf9.js" async=""></script><script src="/_next/static/chunks/1b3e99d6-50521588821d44ca.js" async=""></script><script src="/_next/static/chunks/826-c44bffd752ec02cd.js" async=""></script><script src="/_next/static/chunks/467-ff6f7f0e9f0462a7.js" async=""></script><script src="/_next/static/chunks/app/articles/%5B%5B...params%5D%5D/page-59c8401fd7fff2e0.js" async=""></script><link rel="preload" href="https://services.ddadaal.me/monitor/script.js" as="script"/><title>从调库到翻源代码：给wakapi增加SQL Server支持 - ddadaal.me</title><meta name="description" content="ddadaal&#x27;s personal website"/><link rel="manifest" href="/site.webmanifest"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><link rel="icon" href="/icon.svg?35be8e76be1c3618" type="image/svg+xml" sizes="any"/><link rel="apple-touch-icon" href="/apple-icon.png?5334a64f42000bb0" type="image/png" sizes="180x180"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="w-full"><div class="items-center sticky z-50 w-full h-13 transition -top-[1px] bg-base-200 text-base-content"><div class="flex justify-between items-center max-w-7xl mx-auto px-4"><a class="flex items-center justify-center space-x-1" href="/"><img alt="logo" loading="lazy" width="42" height="42" decoding="async" data-nimg="1" style="color:transparent" src="/_next/static/media/logo.8f2bd5ec.svg"/><h1 class="text-sm font-bold">ddadaal.me</h1></a><div class="flex items-center gap-1"><div class="hidden lg:flex"><ul class="menu menu-horizontal"><li><a class="" href="/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>主页</a></li><li><a class="active" href="/articles"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M542.22 32.05c-54.8 3.11-163.72 14.43-230.96 55.59-4.64 2.84-7.27 7.89-7.27 13.17v363.87c0 11.55 12.63 18.85 23.28 13.49 69.18-34.82 169.23-44.32 218.7-46.92 16.89-.89 30.02-14.43 30.02-30.66V62.75c.01-17.71-15.35-31.74-33.77-30.7zM264.73 87.64C197.5 46.48 88.58 35.17 33.78 32.05 15.36 31.01 0 45.04 0 62.75V400.6c0 16.24 13.13 29.78 30.02 30.66 49.49 2.6 149.59 12.11 218.77 46.95 10.62 5.35 23.21-1.94 23.21-13.46V100.63c0-5.29-2.62-10.14-7.27-12.99z"></path></svg>文章</a></li><li><details><summary class=""><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm160-14.1v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 98c4.5 4.5 7 10.6 7 16.9z"></path></svg>简历</summary><ul class="shadow bg-base-200 text-base-content min-w-max"><li><a class="" href="/resume/cn">🇨🇳 <!-- -->简体中文</a></li><li><a class="" href="/resume/en">🇺🇸 <!-- -->English</a></li></ul></details></li><li><a class="" href="/slides"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M187.7 153.7c-34 0-61.7 25.7-61.7 57.7 0 31.7 27.7 57.7 61.7 57.7s61.7-26 61.7-57.7c0-32-27.7-57.7-61.7-57.7zm143.4 0c-34 0-61.7 25.7-61.7 57.7 0 31.7 27.7 57.7 61.7 57.7 34.3 0 61.7-26 61.7-57.7.1-32-27.4-57.7-61.7-57.7zm156.6 90l-6 4.3V49.7c0-27.4-20.6-49.7-46-49.7H76.6c-25.4 0-46 22.3-46 49.7V248c-2-1.4-4.3-2.9-6.3-4.3-15.1-10.6-25.1 4-16 17.7 18.3 22.6 53.1 50.3 106.3 72C58.3 525.1 252 555.7 248.9 457.5c0-.7.3-56.6.3-96.6 5.1 1.1 9.4 2.3 13.7 3.1 0 39.7.3 92.8.3 93.5-3.1 98.3 190.6 67.7 134.3-124 53.1-21.7 88-49.4 106.3-72 9.1-13.8-.9-28.3-16.1-17.8zm-30.5 19.2c-68.9 37.4-128.3 31.1-160.6 29.7-23.7-.9-32.6 9.1-33.7 24.9-10.3-7.7-18.6-15.5-20.3-17.1-5.1-5.4-13.7-8-27.1-7.7-31.7 1.1-89.7 7.4-157.4-28V72.3c0-34.9 8.9-45.7 40.6-45.7h317.7c30.3 0 40.9 12.9 40.9 45.7v190.6z"></path></svg>幻灯片</a></li><li><details><summary class=""><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 192 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M20 424.229h20V279.771H20c-11.046 0-20-8.954-20-20V212c0-11.046 8.954-20 20-20h112c11.046 0 20 8.954 20 20v212.229h20c11.046 0 20 8.954 20 20V492c0 11.046-8.954 20-20 20H20c-11.046 0-20-8.954-20-20v-47.771c0-11.046 8.954-20 20-20zM96 0C56.235 0 24 32.235 24 72s32.235 72 72 72 72-32.235 72-72S135.764 0 96 0z"></path></svg>关于</summary><ul class="shadow bg-base-200 text-base-content min-w-max"><li><a class="" href="/about/odyssey"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M542.22 32.05c-54.8 3.11-163.72 14.43-230.96 55.59-4.64 2.84-7.27 7.89-7.27 13.17v363.87c0 11.55 12.63 18.85 23.28 13.49 69.18-34.82 169.23-44.32 218.7-46.92 16.89-.89 30.02-14.43 30.02-30.66V62.75c.01-17.71-15.35-31.74-33.77-30.7zM264.73 87.64C197.5 46.48 88.58 35.17 33.78 32.05 15.36 31.01 0 45.04 0 62.75V400.6c0 16.24 13.13 29.78 30.02 30.66 49.49 2.6 149.59 12.11 218.77 46.95 10.62 5.35 23.21-1.94 23.21-13.46V100.63c0-5.29-2.62-10.14-7.27-12.99z"></path></svg>一个个人博客的史诗</a></li><li><a class="" href="/about/project"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M336.5 160C322 70.7 287.8 8 248 8s-74 62.7-88.5 152h177zM152 256c0 22.2 1.2 43.5 3.3 64h185.3c2.1-20.5 3.3-41.8 3.3-64s-1.2-43.5-3.3-64H155.3c-2.1 20.5-3.3 41.8-3.3 64zm324.7-96c-28.6-67.9-86.5-120.4-158-141.6 24.4 33.8 41.2 84.7 50 141.6h108zM177.2 18.4C105.8 39.6 47.8 92.1 19.3 160h108c8.7-56.9 25.5-107.8 49.9-141.6zM487.4 192H372.7c2.1 21 3.3 42.5 3.3 64s-1.2 43-3.3 64h114.6c5.5-20.5 8.6-41.8 8.6-64s-3.1-43.5-8.5-64zM120 256c0-21.5 1.2-43 3.3-64H8.6C3.2 212.5 0 233.8 0 256s3.2 43.5 8.6 64h114.6c-2-21-3.2-42.5-3.2-64zm39.5 96c14.5 89.3 48.7 152 88.5 152s74-62.7 88.5-152h-177zm159.3 141.6c71.4-21.2 129.4-73.7 158-141.6h-108c-8.8 56.9-25.6 107.8-50 141.6zM19.3 352c28.6 67.9 86.5 120.4 158 141.6-24.4-33.8-41.2-84.7-50-141.6h-108z"></path></svg>关于网站</a></li><li><a class="" href="/about/me"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 192 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M96 0c35.346 0 64 28.654 64 64s-28.654 64-64 64-64-28.654-64-64S60.654 0 96 0m48 144h-11.36c-22.711 10.443-49.59 10.894-73.28 0H48c-26.51 0-48 21.49-48 48v136c0 13.255 10.745 24 24 24h16v136c0 13.255 10.745 24 24 24h64c13.255 0 24-10.745 24-24V352h16c13.255 0 24-10.745 24-24V192c0-26.51-21.49-48-48-48z"></path></svg>关于我</a></li></ul></details></li></ul></div><div class="dropdown dropdown-end"><label tabindex="0" class="btn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705 0 184 82.311 184 184 0 101.705-82.311 184-184 184z"></path></svg><span class="hidden sm:block">自动</span></label><ul tabindex="0" class="dropdown-content menu p-2 bg-base-200 text-base-content shadow rounded-box min-w-max"><li><a class="justify-between">自动</a></li><li><a class="justify-between">明亮</a></li><li><a class="justify-between">暗色</a></li><li><a class="justify-between">杯子蛋糕</a></li><li><a class="justify-between">大黄蜂</a></li><li><a class="justify-between">白色商务</a></li><li><a class="justify-between">黑色商务</a></li><li><a class="justify-between">金色奢华</a></li><li><a class="justify-between">夏日柠檬</a></li><li><a class="justify-between">绿野仙踪</a></li><li><a class="justify-between">复古</a></li><li><a class="justify-between">粉色浪漫</a></li><li><a class="justify-between">赛博朋克</a></li></ul></div><div class="dropdown dropdown-end"><label tabindex="0" class="btn">🇨🇳 <span class="hidden sm:block">简体中文</span></label><ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-200 rounded-box min-w-max text-base-content"><li><a class="justify-between">🇨🇳 <!-- -->简体中文</a></li><li><a class="justify-between">🇺🇸 <!-- -->English</a></li></ul></div><div class="dropdown dropdown-end lg:hidden"><label tabindex="0" class="btn btn-ghost"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"></path></svg></label><ul tabindex="0" class="menu menu-compact dropdown-content min-w-max mt-3 p-2 shadow rounded-box bg-base-200 text-base-content"><li><a class="" href="/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>主页</a></li><li><a class="active" href="/articles"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M542.22 32.05c-54.8 3.11-163.72 14.43-230.96 55.59-4.64 2.84-7.27 7.89-7.27 13.17v363.87c0 11.55 12.63 18.85 23.28 13.49 69.18-34.82 169.23-44.32 218.7-46.92 16.89-.89 30.02-14.43 30.02-30.66V62.75c.01-17.71-15.35-31.74-33.77-30.7zM264.73 87.64C197.5 46.48 88.58 35.17 33.78 32.05 15.36 31.01 0 45.04 0 62.75V400.6c0 16.24 13.13 29.78 30.02 30.66 49.49 2.6 149.59 12.11 218.77 46.95 10.62 5.35 23.21-1.94 23.21-13.46V100.63c0-5.29-2.62-10.14-7.27-12.99z"></path></svg>文章</a></li><li><a><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm160-14.1v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 98c4.5 4.5 7 10.6 7 16.9z"></path></svg>简历</a><ul><li><a class="" href="/resume/cn">🇨🇳 <!-- -->简体中文</a></li><li><a class="" href="/resume/en">🇺🇸 <!-- -->English</a></li></ul></li><li><a class="" href="/slides"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M187.7 153.7c-34 0-61.7 25.7-61.7 57.7 0 31.7 27.7 57.7 61.7 57.7s61.7-26 61.7-57.7c0-32-27.7-57.7-61.7-57.7zm143.4 0c-34 0-61.7 25.7-61.7 57.7 0 31.7 27.7 57.7 61.7 57.7 34.3 0 61.7-26 61.7-57.7.1-32-27.4-57.7-61.7-57.7zm156.6 90l-6 4.3V49.7c0-27.4-20.6-49.7-46-49.7H76.6c-25.4 0-46 22.3-46 49.7V248c-2-1.4-4.3-2.9-6.3-4.3-15.1-10.6-25.1 4-16 17.7 18.3 22.6 53.1 50.3 106.3 72C58.3 525.1 252 555.7 248.9 457.5c0-.7.3-56.6.3-96.6 5.1 1.1 9.4 2.3 13.7 3.1 0 39.7.3 92.8.3 93.5-3.1 98.3 190.6 67.7 134.3-124 53.1-21.7 88-49.4 106.3-72 9.1-13.8-.9-28.3-16.1-17.8zm-30.5 19.2c-68.9 37.4-128.3 31.1-160.6 29.7-23.7-.9-32.6 9.1-33.7 24.9-10.3-7.7-18.6-15.5-20.3-17.1-5.1-5.4-13.7-8-27.1-7.7-31.7 1.1-89.7 7.4-157.4-28V72.3c0-34.9 8.9-45.7 40.6-45.7h317.7c30.3 0 40.9 12.9 40.9 45.7v190.6z"></path></svg>幻灯片</a></li><li><a><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 192 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M20 424.229h20V279.771H20c-11.046 0-20-8.954-20-20V212c0-11.046 8.954-20 20-20h112c11.046 0 20 8.954 20 20v212.229h20c11.046 0 20 8.954 20 20V492c0 11.046-8.954 20-20 20H20c-11.046 0-20-8.954-20-20v-47.771c0-11.046 8.954-20 20-20zM96 0C56.235 0 24 32.235 24 72s32.235 72 72 72 72-32.235 72-72S135.764 0 96 0z"></path></svg>关于</a><ul><li><a class="" href="/about/odyssey"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M542.22 32.05c-54.8 3.11-163.72 14.43-230.96 55.59-4.64 2.84-7.27 7.89-7.27 13.17v363.87c0 11.55 12.63 18.85 23.28 13.49 69.18-34.82 169.23-44.32 218.7-46.92 16.89-.89 30.02-14.43 30.02-30.66V62.75c.01-17.71-15.35-31.74-33.77-30.7zM264.73 87.64C197.5 46.48 88.58 35.17 33.78 32.05 15.36 31.01 0 45.04 0 62.75V400.6c0 16.24 13.13 29.78 30.02 30.66 49.49 2.6 149.59 12.11 218.77 46.95 10.62 5.35 23.21-1.94 23.21-13.46V100.63c0-5.29-2.62-10.14-7.27-12.99z"></path></svg>一个个人博客的史诗</a></li><li><a class="" href="/about/project"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M336.5 160C322 70.7 287.8 8 248 8s-74 62.7-88.5 152h177zM152 256c0 22.2 1.2 43.5 3.3 64h185.3c2.1-20.5 3.3-41.8 3.3-64s-1.2-43.5-3.3-64H155.3c-2.1 20.5-3.3 41.8-3.3 64zm324.7-96c-28.6-67.9-86.5-120.4-158-141.6 24.4 33.8 41.2 84.7 50 141.6h108zM177.2 18.4C105.8 39.6 47.8 92.1 19.3 160h108c8.7-56.9 25.5-107.8 49.9-141.6zM487.4 192H372.7c2.1 21 3.3 42.5 3.3 64s-1.2 43-3.3 64h114.6c5.5-20.5 8.6-41.8 8.6-64s-3.1-43.5-8.5-64zM120 256c0-21.5 1.2-43 3.3-64H8.6C3.2 212.5 0 233.8 0 256s3.2 43.5 8.6 64h114.6c-2-21-3.2-42.5-3.2-64zm39.5 96c14.5 89.3 48.7 152 88.5 152s74-62.7 88.5-152h-177zm159.3 141.6c71.4-21.2 129.4-73.7 158-141.6h-108c-8.8 56.9-25.6 107.8-50 141.6zM19.3 352c28.6 67.9 86.5 120.4 158 141.6-24.4-33.8-41.2-84.7-50-141.6h-108z"></path></svg>关于网站</a></li><li><a class="" href="/about/me"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 192 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M96 0c35.346 0 64 28.654 64 64s-28.654 64-64 64-64-28.654-64-64S60.654 0 96 0m48 144h-11.36c-22.711 10.443-49.59 10.894-73.28 0H48c-26.51 0-48 21.49-48 48v136c0 13.255 10.745 24 24 24h16v136c0 13.255 10.745 24 24 24h64c13.255 0 24-10.745 24-24V352h16c13.255 0 24-10.745 24-24V192c0-26.51-21.49-48-48-48z"></path></svg>关于我</a></li></ul></li></ul></div></div></div></div><div><article><div class="bg-neutral px-4 py-8"><div class="max-w-7xl mx-auto min-h-[256px] flex justify-center text-center text-neutral-content"><div class="flex flex-col justify-center animate-slide-up"><h1 class="text-4xl my-2">从调库到翻源代码：给wakapi增加SQL Server支持</h1><div class="flex flex-wrap gap-3 my-2 text-sm justify-center"><div class="flex flex-wrap gap-1 items-center"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"></path></svg><a class="badge badge-accent mx-0.5 text-accent-content" href="/articles/search?query=project">我的项目</a><a class="badge badge-accent mx-0.5 text-accent-content" href="/articles/search?query=problem-investigation">问题探究</a></div><div class="flex items-center" title="发表时间"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm436-44v-36c0-26.5-21.5-48-48-48h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v36c0 6.6 5.4 12 12 12h424c6.6 0 12-5.4 12-12z"></path></svg><span class="mx-0.5">2024-01-17 22:58:00 UTC+8</span></div><div class="flex items-center"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm57.1 120H305c7.7 0 13.4 7.1 11.7 14.7l-38 168c-1.2 5.5-6.1 9.3-11.7 9.3h-38c-5.5 0-10.3-3.8-11.6-9.1-25.8-103.5-20.8-81.2-25.6-110.5h-.5c-1.1 14.3-2.4 17.4-25.6 110.5-1.3 5.3-6.1 9.1-11.6 9.1H117c-5.6 0-10.5-3.9-11.7-9.4l-37.8-168c-1.7-7.5 4-14.6 11.7-14.6h24.5c5.7 0 10.7 4 11.8 9.7 15.6 78 20.1 109.5 21 122.2 1.6-10.2 7.3-32.7 29.4-122.7 1.3-5.4 6.1-9.1 11.7-9.1h29.1c5.6 0 10.4 3.8 11.7 9.2 24 100.4 28.8 124 29.6 129.4-.2-11.2-2.6-17.8 21.6-129.2 1-5.6 5.9-9.5 11.5-9.5zM384 121.9v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 98c4.5 4.5 7 10.6 7 16.9z"></path></svg><span class="mx-0.5">6636<!-- --> 字</span></div><div class="flex items-center"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z"></path></svg><span class="mx-0.5">34<!-- --> 分钟阅读</span></div><div class="flex items-center"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M336.5 160C322 70.7 287.8 8 248 8s-74 62.7-88.5 152h177zM152 256c0 22.2 1.2 43.5 3.3 64h185.3c2.1-20.5 3.3-41.8 3.3-64s-1.2-43.5-3.3-64H155.3c-2.1 20.5-3.3 41.8-3.3 64zm324.7-96c-28.6-67.9-86.5-120.4-158-141.6 24.4 33.8 41.2 84.7 50 141.6h108zM177.2 18.4C105.8 39.6 47.8 92.1 19.3 160h108c8.7-56.9 25.5-107.8 49.9-141.6zM487.4 192H372.7c2.1 21 3.3 42.5 3.3 64s-1.2 43-3.3 64h114.6c5.5-20.5 8.6-41.8 8.6-64s-3.1-43.5-8.5-64zM120 256c0-21.5 1.2-43 3.3-64H8.6C3.2 212.5 0 233.8 0 256s3.2 43.5 8.6 64h114.6c-2-21-3.2-42.5-3.2-64zm39.5 96c14.5 89.3 48.7 152 88.5 152s74-62.7 88.5-152h-177zm159.3 141.6c71.4-21.2 129.4-73.7 158-141.6h-108c-8.8 56.9-25.6 107.8-50 141.6zM19.3 352c28.6 67.9 86.5 120.4 158 141.6-24.4-33.8-41.2-84.7-50-141.6h-108z"></path></svg><span class="mx-0.5 space-x-1"><a class="link link-hover" href="/articles/support-sqlserver-in-wakapi/cn">简体中文</a></span></div></div></div></div></div><div class="animate-slide-up"><div class="max-w-7xl mx-auto p-4"><div class="flex flex-row space-x-4"><div class="prose max-w-full lg:w-[75%]"><div class="p-4 my-4 bg-neutral rounded shadow"><h1 id="summary" class="text-neutral-content mb-3"><a href="#summary" class="mr-1 text-neutral-content"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="inline-block opacity-20 hover:opacity-60" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>✨AI全文摘要</h1><div><div role="tablist" class="tabs-boxed"><a role="tab" class="tab no-underline tab-active">DeepSeek R1</a><a role="tab" class="tab no-underline">DeepSeek R1 8B</a><div role="tabpanel" class="p-3"><div class="prose max-h-80 overflow-auto max-w-full prose-p:m-0 prose-li:m-0 prose-ul:m-0 prose-ol:m-0"><p>作者在尝试将Wakapi项目迁移至SQL Server时，遇到一系列数据库适配问题。包括SQL语法差异、ORM框架配置、外键约束冲突及GORM库的Upsert功能缺陷。通过修改原生SQL语句、动态调整时间字段类型映射、重构外键关系、手动处理唯一索引冲突，最终解决兼容性问题并成功合并代码。此次实践深入了解了SQL Server特性与GORM内部机制，验证了通过实际项目攻坚学习技术的有效性。</p></div><p class="text-sm justify-end flex m-2 italic">由<a target="_blank" href="https://ai.azure.com">Azure AI</a>部署的DeepSeek-R1模型推理</p></div></div></div></div><h1 id="不就是调库嘛"><a href="#不就是调库嘛" class="mr-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="inline-block opacity-20 hover:opacity-60" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>不就是调库嘛……</h1>
<p>在<a href="/articles/added-blog-page-click-monitoring">上一篇文章</a>中，我给博客增加了点击量监测，并将这个服务部署到了Azure，数据库采用了使用SQL Server的Azure的SQL服务。由于SQL Server有免费的订阅，微软的Azure Data Studio也还算好用，于是我觉得可以重用一下刚才学习的这个技能，将其他的服务也使用SQL Server部署。</p>
<p>我之前在用<a href="https://wakatime.com/">wakatime</a>来记录我的编程的数据（例如每天的编程时间、所使用的编程语言等），但是wakatime免费用户只能保存14天的数据，而且wakatime没有提供官方的可自己部署的后端，所以我也一直在寻找wakatime的替代品。之前尝试使用了一段时间的<a href="https://codetime.dev/">codetime</a>。这个软件的功能和wakatime类似，但是它当前只支持VSCode客户端，虽然免费保存数据，但是仍然没有提供可自己部署的后端。我在很早之前也尝试找过wakatime的后端替代品，但是当时并没有找到一个能用的。但前不久，同学给我推荐了<a href="https://www.wakapi.com/">wakapi</a>项目，这个项目重新实现了wakatime的后端API，这样wakatime的丰富的客户端插件可以直接使用，并且完全可以自己部署，不用担心数据并存放在别人的服务器上。</p>
<p>它就是我一直寻找的wakatime替代品！</p>
<p>很激动地浏览了一下项目，看到wakapi当时并没有原生支持SQL Server，但是在README中提到，wakatime使用了<a href="https://gorm.io">gorm</a>作为数据库访问框架，而gorm本身是<a href="https://github.com/go-gorm/sqlserver">支持SQL Server</a>的。</p>
<p>我想，既然库都支持了，SQL Server支持有什么难的？引入<code>gorm.io/sqlserver</code>包，引入创建一个<code>Dialector</code>，用gorm的API编写的绝大多数数据库操作就完成了。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#E06C75">sqlserver</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Open</span><span style="color:#ABB2BF">(</span><span style="color:#61AFEF">mssqlConnectionString</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75">c</span><span style="color:#ABB2BF">))</span></span></code></pre></figure>
<p>这有什么难的，开跑！结果遇到了一大堆报错。</p>
<h1 id="遇到并解决一个一个一个的问题"><a href="#遇到并解决一个一个一个的问题" class="mr-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="inline-block opacity-20 hover:opacity-60" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>遇到并解决一个一个一个的问题</h1>
<h2 id="sql语句"><a href="#sql语句" class="mr-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="inline-block opacity-20 hover:opacity-60" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>SQL语句</h2>
<p>仔细一看，这些报错主要是来自于数据库migration中的原生SQL语句和片段。</p>
<p>程序启动的时候，会运行数据库migration脚本。随着软件开发更多的新功能，其使用的数据库的结构总会发生变化，而migration是指一些代码，这些代码的作用是修改数据库schema、让schema满足当前版本的要求。当软件功能越来越多，对数据库的变化也就越来越多，所以在一个成熟的软件中，你常常会看到有很多的数据库migration的代码。在程序启动的时候，这些migration将会被一个一个地执行，使得程序正式开始时，数据库的schema也更新到最新。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="bash" data-theme="one-dark-pro"><code data-language="bash" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#ABB2BF">&gt; tree migrations</span></span>
<span data-line=""><span style="color:#61AFEF">migrations</span></span>
<span data-line=""><span style="color:#61AFEF">├──</span><span style="color:#98C379"> 20201103_rename_language_mappings_table.go</span></span>
<span data-line=""><span style="color:#61AFEF">├──</span><span style="color:#98C379"> 20201106_migration_cascade_constraints.go</span></span>
<span data-line=""><span style="color:#61AFEF">├──</span><span style="color:#98C379"> 20210202_fix_cascade_for_alias_user_constraint.go</span></span>
<span data-line=""><span style="color:#61AFEF">├──</span><span style="color:#98C379"> 20210206_drop_badges_column_add_sharing_flags.go</span></span>
<span data-line=""><span style="color:#61AFEF">├──</span><span style="color:#98C379"> 20210213_add_has_data_field.go</span></span>
<span data-line=""><span style="color:#61AFEF">├──</span><span style="color:#98C379"> 20210221_add_created_date_column.go</span></span>
<span data-line=""><span style="color:#61AFEF">├──</span><span style="color:#98C379"> 20210411_add_imprint_content.go</span></span>
<span data-line=""><span style="color:#61AFEF">├──</span><span style="color:#98C379"> 20210411_drop_migrations_table.go</span></span>
<span data-line=""><span style="color:#61AFEF">├──</span><span style="color:#98C379"> 20210806_remove_persisted_project_labels.go</span></span>
<span data-line=""> </span></code></pre></figure>
<p>而有的migration（尤其是自动生成的migration）很可能包含了一些原生SQL。同时，由于ORM是对数据库操作的抽象，而再强大的抽象也不如原生的SQL来得强大和方便，所以很多时候，开发者仍然会选择在一些地方使用原生SQL语句的片段或者语句来实现一些功能。虽然SQL本身是有标准的，但是各个数据库厂商实际上自己实现了很多新功能，很多时候我们本以为理所当然的功能，实际上并不在标准中，而是数据库厂商自己实现的，一旦手写SQL而没有意识到有的SQL实际上只在部分数据库中兼容，就可能会在不兼容的数据库中遇到问题。</p>
<p>举个例子，wakapi的某个版本需要在数据库的<code>users</code>表中新增一个<code>has_data</code>列，而对于已经存在的<code>users</code>表中的数据，这个列需要被设置为<code>TRUE</code>。代码中用于执行此次migration的代码使用如下SQL语句实现了这个功能：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sql" data-theme="one-dark-pro"><code data-language="sql" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#C678DD">UPDATE</span><span style="color:#ABB2BF"> users </span><span style="color:#C678DD">SET</span><span style="color:#ABB2BF"> has_data </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> TRUE </span><span style="color:#C678DD">WHERE</span><span style="color:#ABB2BF"> TRUE;</span></span></code></pre></figure>
<p>看上去是个很简单的人畜无害的SQL语句，对吧？但是这个SQL语句在mssql中中是非法的，因为mssql中并没有<code>TRUE</code>, <code>FALSE</code>常量！sqlserver中没有<code>boolean</code>类型，所有这些类型都是使用一个字节的<code>tinyint</code>来表示的，而<code>TRUE</code>和<code>FALSE</code>就对应使用<code>1</code>和<code>0</code>来表示。但是，<code>1</code>和<code>0</code>在sql server中并不是一个合法的<code>boolean</code>表达式，所以它们并不能直接用在<code>WHERE</code>中。所以，在MSSQL中，以上SQL语句就必须重新成以下的样子：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sql" data-theme="one-dark-pro"><code data-language="sql" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#C678DD">UPDATE</span><span style="color:#ABB2BF"> users </span><span style="color:#C678DD">SET</span><span style="color:#ABB2BF"> has_data </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span></span></code></pre></figure>
<h2 id="sql语句片段"><a href="#sql语句片段" class="mr-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="inline-block opacity-20 hover:opacity-60" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>SQL语句片段</h2>
<p>另一个情况是<strong>SQL语句片段</strong>。虽然ORM的一大作用就是将软件代码映射为SQL语句，减少我们手写SQL可能带来的错误，但是为了实现的灵活性，ORM常常同样也允许在自己的API中编写一些SQL的片段，而ORM会尝试将这些SQL片段嵌入进去。但是这些SQL片段可能也会有不兼容的情况！例如，下面的代码</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#E06C75">result</span><span style="color:#E5C07B"> :=</span><span style="color:#E06C75"> db</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Table</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;summaries AS s1&quot;</span><span style="color:#ABB2BF">).</span></span>
<span data-line=""><span style="color:#61AFEF">			Where</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;s1.id IN ?&quot;</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75">faultyIds</span><span style="color:#ABB2BF">).</span></span>
<span data-line=""><span style="color:#61AFEF">			Update</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;num_heartbeats&quot;</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">&quot;3&quot;</span><span style="color:#ABB2BF">)</span></span></code></pre></figure>
<p>上述gorm数据库仓库将会被映射为类型以下的SQL语句。注意<code>Table</code>和<code>Where</code>方法的参数与下列SQL语句中对应的语句的对应关系。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sql" data-theme="one-dark-pro"><code data-language="sql" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#C678DD">update</span><span style="color:#ABB2BF"> summaries </span><span style="color:#C678DD">AS</span><span style="color:#ABB2BF"> s1 </span><span style="color:#C678DD">set</span><span style="color:#ABB2BF"> num_heartbeats </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 3</span><span style="color:#C678DD"> where</span><span style="color:#D19A66"> s1</span><span style="color:#ABB2BF">.</span><span style="color:#D19A66">id</span><span style="color:#C678DD"> IN</span><span style="color:#ABB2BF"> ?</span></span></code></pre></figure>
<p>是不是感觉很简单？但是MSSQL仍然不支持！MSSQL不支持在<code>update</code>持语句中给表新增一个别名，所以以上SQL语句中的<code>AS s1</code>必须被去掉。</p>
<h2 id="重用dialector的逻辑为关键词加上引号"><a href="#重用dialector的逻辑为关键词加上引号" class="mr-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="inline-block opacity-20 hover:opacity-60" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>重用Dialector的逻辑，为关键词加上引号</h2>
<p>再看一个SQL语句片段：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#E06C75">r</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">db</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Model</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">&amp;</span><span style="color:#E5C07B">models</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">User</span><span style="color:#ABB2BF">{}).</span><span style="color:#61AFEF">Select</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;users.id as user, max(time) as time&quot;</span><span style="color:#ABB2BF">).</span></span></code></pre></figure>
<p>这段SQL语句一般会被映射为：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sql" data-theme="one-dark-pro"><code data-language="sql" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#C678DD">select</span><span style="color:#D19A66"> users</span><span style="color:#ABB2BF">.</span><span style="color:#D19A66">id</span><span style="color:#C678DD"> as</span><span style="color:#ABB2BF"> user, </span><span style="color:#56B6C2">max</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">time</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#C678DD"> time</span><span style="color:#C678DD"> from</span><span style="color:#ABB2BF"> users;</span></span></code></pre></figure>
<p>有问题吗？有！<code>user</code>在MSSQL中是关键词，要作为标识符使用必须使用<code>&quot;&quot;</code>或者<code>[]</code>将它包裹起来！而<code>user</code>在mysql等数据库引擎中都不是关键词，因此可以随意直接使用。</p>
<p>这个将关键词作为字符串使用的过程实际上编程中很常见，被称为<code>escape</code>，或者更简单的叫<code>quote</code>，加引号。但是更坑的是，不同的SQL引擎所使用的加引号的方法不一样。MSSQL使用的是<code>&quot;&quot;</code>或者<code>[]</code>，但是mysql使用的是`。如何通过一段代码来为不同的数据库加上正确的引号呢？</p>
<p>其实，这个加引号的过程实在是非常常见，只要ORM需要将程序员所写的名字（表名、列名等）映射到SQL，那么就需要考虑给这些名字叫上引号，防止这些名字和SQL自己的关键词冲突。如果你写一个名字叫<code>select</code>的表，没有这段逻辑，那么这个表就没法通过ORM来映射成SQL了！</p>
<p>因此，根据Don&#x27;t Repeat Yourself原则，ORM为数据库系统的适配器中肯定会有对应的逻辑。而我们与其自己编写这个处理逻辑，最好的方法当然是调用适配器中已经写好的逻辑了。</p>
<p>gorm使用<code>Dialector</code>接口作为ORM支持不同数据库系统的适配器的接口，所有gorm支持的数据库都有一个对应的实现了<code>Dialector</code>接口的<code>Dialector</code>。所以，第一步就是去看看gorm的<code>Dialector</code>里定义了哪些接口。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/interfaces.go#L12C1-L21C2</span></span>
<span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> Dialector</span><span style="color:#C678DD"> interface</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#61AFEF">	Name</span><span style="color:#ABB2BF">() </span><span style="color:#C678DD">string</span></span>
<span data-line=""><span style="color:#61AFEF">	Initialize</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">*</span><span style="color:#E5C07B">DB</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">error</span></span>
<span data-line=""><span style="color:#61AFEF">	Migrator</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">db</span><span style="color:#C678DD"> *</span><span style="color:#E5C07B">DB</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">Migrator</span></span>
<span data-line=""><span style="color:#61AFEF">	DataTypeOf</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">*</span><span style="color:#E5C07B">schema</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Field</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">string</span></span>
<span data-line=""><span style="color:#61AFEF">	DefaultValueOf</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">*</span><span style="color:#E5C07B">schema</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Field</span><span style="color:#ABB2BF">) </span><span style="color:#E5C07B">clause</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Expression</span></span>
<span data-line=""><span style="color:#61AFEF">	BindVarTo</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">writer</span><span style="color:#E5C07B"> clause</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Writer</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">stmt</span><span style="color:#C678DD"> *</span><span style="color:#E5C07B">Statement</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">v</span><span style="color:#C678DD"> interface</span><span style="color:#ABB2BF">{})</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#61AFEF">	QuoteTo</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">clause</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Writer</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">string</span><span style="color:#ABB2BF">)</span></span>
<span data-line=""><span style="color:#61AFEF">	Explain</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">sql</span><span style="color:#C678DD"> string</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">vars</span><span style="color:#ABB2BF"> ...</span><span style="color:#C678DD">interface</span><span style="color:#ABB2BF">{}) </span><span style="color:#C678DD">string</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<p>从名字判断，这个<code>QuoteTo</code>方法似乎就是我们要的接口。再随便点开一个dialector实现的代码浏览一下，就能确定，<code>QuoteTo</code>就是加引号的方法。</p>
<p>可是这个方法看上去和我们想象中的不太一样：我们预期这个功能是一个<code>(string) =&gt; string</code>的函数，这里怎么是一个<code>(clause.Writer, string) =&gt; void</code>的函数，这个<code>clause.Writer</code>是什么玩意？</p>
<p>由于拼接SQL说到底，就是要生成各个SQL的片段，然后将这些片段的字符串拼接起来。在绝大多数编程语言里，<code>string</code>都是不可变的，所以拼接字符串实际上是创建了第三个字符串，然后把两个字符串的内容复制进去。这个过程如果进行太多次，就非常浪费时间和内存。所以编程语言常常会提供一个<strong>组装字符串的工具类</strong>。这个工具类可以理解成是一个<strong>可变</strong>的字符串，你可以直接在这个_字符串_的后面增加新的字符串，而不需要每次操作都创建一个全新的字符串对象。而这个<code>Writer</code>接口，就是gorm定义的一个这样的能够<strong>组装字符串的工具类</strong>所需要实现的接口。这个<code>Writer</code>接口定义如下：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/clause/clause.go#L13</span></span>
<span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> Writer</span><span style="color:#C678DD"> interface</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#61AFEF">	WriteByte</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">byte</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">error</span></span>
<span data-line=""><span style="color:#61AFEF">	WriteString</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">string</span><span style="color:#ABB2BF">) (</span><span style="color:#C678DD">int</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">error</span><span style="color:#ABB2BF">)</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<p>很简单，很直白：<code>WriteByte</code>：在后面增加一个字符；<code>WriteString</code>，在后面增加一个字符串。</p>
<p>熟悉Go的同学可能会说了：啊，这个接口看上去非常熟悉，原生的<code>strings.Builder</code>就是用来做这个事情的，而且也有这两个方法！是不是可以直接用一个<code>strings.Builder</code>来作为这个<code>clause.Writer</code>？</p>
<p>正确！所以我们可以直接创建一个<code>*strings.Builder</code>来作为<code>clause.Writer</code>（用指针的原因是这个<code>strings.Builder</code>的这两个成员方法是使用的指针接收者而不是值接收者，所以只有对应的指针类型才算实现了这个接口。具体关于指针接收者和值接收者的区别我们就不在这里介绍了，有兴趣的可以学习一下Go语言），并在调用后获取这个<code>builder</code>最终的字符串，这样就直接调用了<code>dialector</code>中实现了加引号逻辑。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#C678DD">func</span><span style="color:#61AFEF"> QuoteDbIdentifier</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">db</span><span style="color:#C678DD"> *</span><span style="color:#E5C07B">gorm</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">DB</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">identifier</span><span style="color:#C678DD"> string</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">string</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#E06C75">	builder</span><span style="color:#E5C07B"> :=</span><span style="color:#C678DD"> &amp;</span><span style="color:#E5C07B">strings</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Builder</span><span style="color:#ABB2BF">{}</span></span>
<span data-line=""><span style="color:#E06C75">	db</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">Dialector</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">QuoteTo</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75">builder</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75">identifier</span><span style="color:#ABB2BF">)</span></span>
<span data-line=""><span style="color:#C678DD">	return</span><span style="color:#E06C75"> builder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">String</span><span style="color:#ABB2BF">()</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<p>然后，我们将此函数用在所有需要在SQL片段中使用自定义的名字的地方，这样，我们就重用了dialector的逻辑，用同一套代码兼容了所有的数据库。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#E06C75">r</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">db</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Model</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">&amp;</span><span style="color:#E5C07B">models</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">User</span><span style="color:#ABB2BF">{}).</span><span style="color:#61AFEF">Select</span><span style="color:#ABB2BF">(</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#E06C75">  fmt</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Sprintf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;users.id as </span><span style="color:#D19A66">%s</span><span style="color:#98C379">, max(time) as time&quot;</span><span style="color:#ABB2BF">), </span><span style="color:#E06C75">utils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">QuoteDbIndentifier</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75">r</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">db</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">&quot;user&quot;</span><span style="color:#ABB2BF">)</span></span>
<span data-line=""><span style="color:#ABB2BF">)</span></span></code></pre></figure>
<h2 id="重写不支持的功能"><a href="#重写不支持的功能" class="mr-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="inline-block opacity-20 hover:opacity-60" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>重写不支持的功能</h2>
<p>而在进一步查找并修改原生SQL的语句中，我找到了一段如下的原生SQL语句，直接让我眼前一黑。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="sql" data-theme="one-dark-pro"><code data-language="sql" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#C678DD">with</span><span style="color:#ABB2BF"> projects </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> (</span></span>
<span data-line=""><span style="color:#C678DD">			select</span><span style="color:#ABB2BF"> project, user_id, </span><span style="color:#56B6C2">min</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">time</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#C678DD"> first</span><span style="color:#ABB2BF">, </span><span style="color:#56B6C2">max</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">time</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#C678DD"> last</span><span style="color:#ABB2BF">, </span><span style="color:#56B6C2">count</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> cnt</span></span>
<span data-line=""><span style="color:#C678DD">			from</span><span style="color:#ABB2BF"> heartbeats</span></span>
<span data-line=""><span style="color:#C678DD">			where</span><span style="color:#ABB2BF"> user_id </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> ? </span><span style="color:#C678DD">and</span><span style="color:#ABB2BF"> project </span><span style="color:#56B6C2">!=</span><span style="color:#98C379"> &#x27;&#x27;</span></span>
<span data-line=""><span style="color:#C678DD">			and</span><span style="color:#C678DD"> time</span><span style="color:#C678DD"> between</span><span style="color:#ABB2BF"> ? </span><span style="color:#C678DD">and</span><span style="color:#ABB2BF"> ?</span></span>
<span data-line=""><span style="color:#C678DD">			and</span><span style="color:#C678DD"> language</span><span style="color:#C678DD"> is not null</span><span style="color:#C678DD"> and</span><span style="color:#C678DD"> language</span><span style="color:#56B6C2"> !=</span><span style="color:#98C379"> &#x27;&#x27;</span><span style="color:#C678DD"> and</span><span style="color:#ABB2BF"> project </span><span style="color:#56B6C2">!=</span><span style="color:#98C379"> &#x27;&#x27;</span></span>
<span data-line=""><span style="color:#C678DD">			group by</span><span style="color:#ABB2BF"> project, user_id</span></span>
<span data-line=""><span style="color:#C678DD">			order by</span><span style="color:#C678DD"> last</span><span style="color:#C678DD"> desc</span></span>
<span data-line=""><span style="color:#C678DD">			limit</span><span style="color:#ABB2BF"> ? offset ? )</span></span>
<span data-line=""><span style="color:#C678DD">select distinct</span><span style="color:#ABB2BF"> project, </span><span style="color:#56B6C2">min</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">first</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#C678DD"> first</span><span style="color:#ABB2BF">, </span><span style="color:#56B6C2">min</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">last</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#C678DD"> last</span><span style="color:#ABB2BF">, </span><span style="color:#56B6C2">min</span><span style="color:#ABB2BF">(cnt) </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> count, </span><span style="color:#56B6C2">first_value</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">language</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">over</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">partition</span><span style="color:#C678DD"> by</span><span style="color:#ABB2BF"> project </span><span style="color:#C678DD">order by</span><span style="color:#56B6C2"> count</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">desc</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#ABB2BF"> top_language</span></span>
<span data-line=""><span style="color:#C678DD">			from</span><span style="color:#ABB2BF"> heartbeats</span></span>
<span data-line=""><span style="color:#C678DD">			inner join</span><span style="color:#ABB2BF"> projects </span><span style="color:#C678DD">using</span><span style="color:#ABB2BF"> (project, user_id)</span></span>
<span data-line=""><span style="color:#C678DD">			group by</span><span style="color:#ABB2BF"> project, </span><span style="color:#C678DD">language</span></span>
<span data-line=""><span style="color:#C678DD">			order by</span><span style="color:#C678DD"> last</span><span style="color:#C678DD"> desc</span></span></code></pre></figure>
<p>这段SQL语句就这样赤裸裸地写在代码里。经过以上几个例子，是不是以为这个SQL在MSSQL中必定问题巨大，不重新写一份根本跑不起来？</p>
<p>我一开始也是这么想的。而我自己对SQL Server并没有那么熟悉，所以聪明的我，在给一些名字叫上引号后，直接把这段代码扔给了GitHub Copilot，让它帮我改成SQL Server能用的。反直觉的是，这段代码实际上问题没那么大：</p>
<p><figure><img alt="copilot的结果" loading="lazy" width="1056" height="1540" decoding="async" data-nimg="1" class="cursor-zoom-in mx-auto" style="color:transparent" srcSet="/articles/asset/contents/20240117-support-sqlserver-in-wakapi/copilot.png?width=1080 1x, /articles/asset/contents/20240117-support-sqlserver-in-wakapi/copilot.png?width=3840 2x" src="/articles/asset/contents/20240117-support-sqlserver-in-wakapi/copilot.png?width=3840"/><figcaption class="text-center">copilot的结果</figcaption></figure></p>
<p>具体来说，除了第三点去掉了不需要的引号后，有两个问题：</p>
<ol>
<li>不支持<code>join using</code>，需要使用常规的<code>join on</code>代替</li>
<li>不支持<code>limit offset</code>。查找了一下，mssql可以使用<code>offset ? ROWS fetch next ? rows only</code>来代替，当然<code>limit</code>和<code>offset</code>的参数顺序是反过来的</li>
</ol>
<p>啊，原来这么简单！由于需要修改的地方并不多，于是我就简单的通过if判断，将其中SQL Server不兼容的部分修改为SQL Server兼容的SQL语句，这段SQL语句也就完成了。</p>
<h2 id="把同一个go类型在不同的数据库中映射为不同的列类型"><a href="#把同一个go类型在不同的数据库中映射为不同的列类型" class="mr-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="inline-block opacity-20 hover:opacity-60" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>把同一个go类型在不同的数据库中映射为不同的列类型</h2>
<p>修改了这些SQL语句后，程序仍然运行不起来，仔细一看，报错如下：</p>
<pre><code>mssql: A table can only have one timestamp. Because table &#x27;users&#x27; already has one, the column &#x27;last_logged_in_at&#x27; cannot be added.
</code></pre>
<p>简单翻译，一个表只能有一个类型为<code>timestamp</code>的列，而<code>users</code>中有多个列都是<code>timestamp</code>的类型，所以SQL Server报错了。</p>
<p>去代码中一看，<code>users</code>表对应的<code>User</code>struct确实有好几个字段都通过<a href="https://gorm.io/docs/models.html#Fields-Tags">gorm的field tag功能</a><code>type:timestamp</code>，确定了在数据库中这些列需要映射为<code>timestamp</code>类型。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/user.go#L17</span></span>
<span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> User</span><span style="color:#C678DD"> struct</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#E06C75">  CreatedAt</span><span style="color:#E5C07B">           CustomTime</span><span style="color:#98C379">  `gorm:&quot;type:</span><mark data-highlighted-chars=""><span style="color:#98C379">timestamp</span></mark><span style="color:#98C379">; default:CURRENT_TIMESTAMP&quot; swaggertype:&quot;string&quot; format:&quot;date&quot; example:&quot;2006-01-02 15:04:05.000&quot;`</span></span>
<span data-line=""><span style="color:#E06C75">	LastLoggedInAt</span><span style="color:#E5C07B">      CustomTime</span><span style="color:#98C379">  `gorm:&quot;type:</span><mark data-highlighted-chars=""><span style="color:#98C379">timestamp</span></mark><span style="color:#98C379">; default:CURRENT_TIMESTAMP&quot; swaggertype:&quot;string&quot; format:&quot;date&quot; example:&quot;2006-01-02 15:04:05.000&quot;`</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#E06C75">  SubscribedUntil</span><span style="color:#C678DD">     *</span><span style="color:#E5C07B">CustomTime</span><span style="color:#98C379"> `json:&quot;-&quot; gorm:&quot;type:</span><mark data-highlighted-chars=""><span style="color:#98C379">timestamp</span></mark><span style="color:#98C379">&quot; swaggertype:&quot;string&quot; format:&quot;date&quot; example:&quot;2006-01-02 15:04:05.000&quot;`</span></span>
<span data-line=""><span style="color:#E06C75">	SubscriptionRenewal</span><span style="color:#C678DD"> *</span><span style="color:#E5C07B">CustomTime</span><span style="color:#98C379"> `json:&quot;-&quot; gorm:&quot;type:</span><mark data-highlighted-chars=""><span style="color:#98C379">timestamp</span></mark><span style="color:#98C379">&quot; swaggertype:&quot;string&quot; format:&quot;date&quot; example:&quot;2006-01-02 15:04:05.000&quot;`</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<p><code>timestamp</code>有什么问题呢？MySQL不都是使用<code>timestamp</code>来代表时间类型吗？去查找<code>sql server timestamp</code>，我才发现，SQL Server里的<code>timestamp</code>的含义和别的数据库中的含义不一样。在别的数据库中，<code>timestamp</code>就是一个表示时间戳/时间点的类型，而根据<a href="https://stackoverflow.com/a/12063938">这个stackoverflow回答</a>，<code>sql server</code>中的<code>timestamp</code>主要用于乐观锁的情况（具体不在这里阐述），只是用来标记本行上一次被修改的时间，所以每个表只能存在一个<code>timestamp</code>的列。而在SQL Server中如果要表示一个时间戳，需要使用<code>datetimeoffset</code>。</p>
<p>所以现在问题就变成了：<strong>如何将一个类型在不同的数据库中映射为不同的列的类型</strong>。</p>
<p><code>type:timestamp</code>这个tag肯定是不能用了，于是我们就需要查找有没有其他更动态的方法，可以自定义一个go字段映射到数据库中的类型。经过一番查找，我们找到了<a href="https://gorm.io/docs/data_types.html#GormDataTypeInterface">Customize Data Type</a>功能。gorm允许定义一个自定义的<code>struct</code>，并给这个<code>struct</code>实现<code>GormDBDataTypeInterface</code>接口，来返回这个类型的字段所真正对应的数据库类型。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> GormDBDataTypeInterface</span><span style="color:#C678DD"> interface</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#61AFEF">  GormDBDataType</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">*</span><span style="color:#E5C07B">gorm</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">DB</span><span style="color:#ABB2BF">, </span><span style="color:#C678DD">*</span><span style="color:#E5C07B">schema</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Field</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">string</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<p>这个函数的第一个参数就是<code>gorm.DB</code>对象，指向当前操作的数据库对象，可以获取到当前正在使用什么类型的<code>Dialector</code>，我们就可以根据<code>Dialector</code>类型，来输出对应的数据库列类型。另外，这个<code>CustomTime</code>正好是代码中所定义的一个新的<code>struct</code>，我们可以直接在<code>CustomTime</code>上实现这个接口。</p>
<p>看来比较简单，但是为了以防万一，我们再全局搜索一下<code>type:timestamp</code>，看看有没有什么其他的用法。果然被我找到了！</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/heartbeat.go#L27</span></span>
<span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> Heartbeat</span><span style="color:#C678DD"> struct</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#E06C75">  Time</span><span style="color:#E5C07B">            CustomTime</span><span style="color:#98C379"> `json:&quot;time&quot; gorm:&quot;type:</span><mark data-highlighted-chars=""><span style="color:#98C379">timestamp(3)</span></mark><span style="color:#98C379">; index:idx_time; index:idx_time_user&quot; swaggertype:&quot;primitive,number&quot;`</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<p>这里用到了<code>timestamp(3)</code>。根据<a href="https://dev.mysql.com/doc/refman/8.0/en/fractional-seconds.html">mysql的文档</a>，<code>timestamp(n)</code>中的<code>n</code>是代表精确到秒后面的第几位浮点位，<code>3</code>代表精确到毫秒，而<code>6</code>代表精确到微秒。而SQL Server的<code>datetimeoffset</code>也支持类似的标记（<a href="https://learn.microsoft.com/en-us/sql/t-sql/data-types/datetimeoffset-transact-sql?view=sql-server-ver16">文档</a>），<code>datetimeoffset(n)</code>中的<code>n</code>也同样表示精确到秒后面的第几位浮点位。由于我们不能直接使用<code>type</code>tag，但是我们还需要一个tag用来表示这个精确的位数（根据sql server的文档，将这个位数称为<code>scale</code>），所以，我们可以定义一个全新的<code>timeScale</code>的tag，其值就是<code>scale</code>的值。而一个字段上具体有哪些tag，正好可以通过<code>GormDBDataType</code>的第二个参数获取。</p>
<p>于是根据这个思路，我们实现了<code>CustomTime</code>的<code>GormDBDataType</code>方法：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/shared.go#L44</span></span>
<span data-line=""><span style="color:#C678DD">func</span><span style="color:#ABB2BF"> (</span><span style="color:#E06C75;font-style:italic">j </span><span style="color:#E5C07B">CustomTime</span><span style="color:#ABB2BF">) </span><span style="color:#61AFEF">GormDBDataType</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">db</span><span style="color:#C678DD"> *</span><span style="color:#E5C07B">gorm</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">DB</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">field</span><span style="color:#C678DD"> *</span><span style="color:#E5C07B">schema</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Field</span><span style="color:#ABB2BF">) </span><span style="color:#C678DD">string</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">	t</span><span style="color:#E5C07B"> :=</span><span style="color:#98C379"> &quot;timestamp&quot;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // 如果使用的是SQL Server Dialector，则将其类型设置为datetimeoffset</span></span>
<span data-line=""><span style="color:#C678DD">	if</span><span style="color:#E06C75"> db</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">Config</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">Dialector</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Name</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">==</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">sqlserver</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Dialector</span><span style="color:#ABB2BF">{}).</span><span style="color:#61AFEF">Name</span><span style="color:#ABB2BF">() {</span></span>
<span data-line=""><span style="color:#E06C75">		t</span><span style="color:#E5C07B"> =</span><span style="color:#98C379"> &quot;datetimeoffset&quot;</span></span>
<span data-line=""><span style="color:#ABB2BF">	}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // 如果一个属性有TIMESCALE的tag，那么给类型后面增加(n)参数</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // gorm将所有gorm下的tag的key转换成了全大写</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // 参考：https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/schema/utils.go#L35</span></span>
<span data-line=""><span style="color:#C678DD">	if</span><span style="color:#E06C75"> scale</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75">ok</span><span style="color:#E5C07B"> :=</span><span style="color:#E06C75"> field</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">TagSettings</span><span style="color:#ABB2BF">[</span><span style="color:#98C379">&quot;TIMESCALE&quot;</span><span style="color:#ABB2BF">]; </span><span style="color:#E06C75">ok</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#E06C75">		t</span><span style="color:#E5C07B"> +=</span><span style="color:#E06C75"> fmt</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Sprintf</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">&quot;(</span><span style="color:#D19A66">%s</span><span style="color:#98C379">)&quot;</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75">scale</span><span style="color:#ABB2BF">)</span></span>
<span data-line=""><span style="color:#ABB2BF">	}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#C678DD">	return</span><span style="color:#E06C75"> t</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<p>同时，我们将所有的<code>timestamp</code>都直接去掉，将<code>type:timestamp(n)</code>修改为了<code>timeScale:n</code>：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/user.go#L17</span></span>
<span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> User</span><span style="color:#C678DD"> struct</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#E06C75">  CreatedAt</span><span style="color:#E5C07B">           CustomTime</span><span style="color:#98C379">  `gorm:&quot;default:CURRENT_TIMESTAMP&quot; swaggertype:&quot;string&quot; format:&quot;date&quot; example:&quot;2006-01-02 15:04:05.000&quot;`</span></span>
<span data-line=""><span style="color:#E06C75">  LastLoggedInAt</span><span style="color:#E5C07B">      CustomTime</span><span style="color:#98C379">  `gorm:&quot;default:CURRENT_TIMESTAMP&quot; swaggertype:&quot;string&quot; format:&quot;date&quot; example:&quot;2006-01-02 15:04:05.000&quot;`</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#E06C75">  SubscribedUntil</span><span style="color:#C678DD">     *</span><span style="color:#E5C07B">CustomTime</span><span style="color:#98C379"> `json:&quot;-&quot; swaggertype:&quot;string&quot; format:&quot;date&quot; example:&quot;2006-01-02 15:04:05.000&quot;`</span></span>
<span data-line=""><span style="color:#E06C75">  SubscriptionRenewal</span><span style="color:#C678DD"> *</span><span style="color:#E5C07B">CustomTime</span><span style="color:#98C379"> `json:&quot;-&quot; swaggertype:&quot;string&quot; format:&quot;date&quot; example:&quot;2006-01-02 15:04:05.000&quot;`</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/heartbeat.go#L12</span></span>
<span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> Heartbeat</span><span style="color:#C678DD"> struct</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#E06C75">  Time</span><span style="color:#E5C07B">            CustomTime</span><span style="color:#98C379"> `json:&quot;time&quot; gorm:&quot;</span><mark data-highlighted-chars=""><span style="color:#98C379">timeScale:3</span></mark><span style="color:#98C379">; index:idx_time; index:idx_time_user&quot; swaggertype:&quot;primitive,number&quot;`</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<p>这样就解决了这个问题。</p>
<h2 id="避免创建递归的级联修改外键约束"><a href="#避免创建递归的级联修改外键约束" class="mr-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="inline-block opacity-20 hover:opacity-60" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>避免创建递归的级联修改外键约束</h2>
<p>没想到的是，到这里仍然无法启动程序。报错如下：</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="{3}" data-theme="one-dark-pro"><code data-language="{3}" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span>[2.938ms] [rows:0] CREATE TABLE &quot;summary_items&quot; (&quot;id&quot; bigint IDENTITY(1,1),&quot;summary_id&quot; bigint,&quot;type&quot; smallint,&quot;key&quot; nvarchar(255),&quot;total&quot; bigint,PRIMARY KEY (&quot;id&quot;),CONSTRAINT &quot;fk_summaries_editors&quot; FOREIGN KEY (&quot;summary_id&quot;) REFERENCES &quot;summaries&quot;(&quot;id&quot;) ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT &quot;fk_summaries_operating_systems&quot; FOREIGN KEY (&quot;summary_id&quot;) REFERENCES &quot;summaries&quot;(&quot;id&quot;) ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT &quot;fk_summaries_machines&quot; FOREIGN KEY (&quot;summary_id&quot;) REFERENCES &quot;summaries&quot;(&quot;id&quot;) ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT &quot;fk_summaries_projects&quot; FOREIGN KEY (&quot;summary_id&quot;) REFERENCES &quot;summaries&quot;(&quot;id&quot;) ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT &quot;fk_summaries_languages&quot; FOREIGN KEY (&quot;summary_id&quot;) REFERENCES &quot;summaries&quot;(&quot;id&quot;) ON DELETE CASCADE ON UPDATE CASCADE)</span></span>
<span data-line=""><span>2024-01-19T19:29:35.607826413+08:00 [ERROR] mssql: Could not create constraint or index. See previous errors.</span></span>
<span data-line=""><span>panic: mssql: Could not create constraint or index. See previous errors.</span></span></code></pre></figure>
<p><code>Could not create constraint or index. See previous errors.</code>这个等于什么都没说嘛，只知道创建一个外键约束或者索引的时候失败了，而其他的错误信息被gorm或者gorm的sqlserver dialector忽略了。还</p>
<p>还好我能看到具体执行的SQL语句，所以我们可以把这段SQL语句手动输入到Azure Data Studio中，看看数据库引擎到底报了什么错误。</p>
<p><figure><img alt="通过Azure Data Studio查看具体的错误信息" loading="lazy" width="1499" height="637" decoding="async" data-nimg="1" class="cursor-zoom-in mx-auto" style="color:transparent" srcSet="/articles/asset/contents/20240117-support-sqlserver-in-wakapi/foreign-keys.png?width=1920 1x, /articles/asset/contents/20240117-support-sqlserver-in-wakapi/foreign-keys.png?width=3840 2x" src="/articles/asset/contents/20240117-support-sqlserver-in-wakapi/foreign-keys.png?width=3840"/><figcaption class="text-center">通过Azure Data Studio查看具体的错误信息</figcaption></figure></p>
<blockquote>
<p>Introducing FOREIGN KEY constraint &#x27;fk_summaries_operating_systems&#x27; on table &#x27;summary_items&#x27; may cause cycles or multiple cascade paths. Specify ON DELETE NO ACTION or ON UPDATE NO ACTION, or modify other FOREIGN KEY constraints.</p>
</blockquote>
<p>看起来，是因为<code>fk_summaries_operating_systems</code>这个级联的外键索引会造成级联递归（cycles）。和外键约束有关，而外键约束是通过gorm定义，所以我们先去看看代码里涉及这个外键约束的两个表的定义。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/summary.go#L29</span></span>
<span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> Summary</span><span style="color:#C678DD"> struct</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#E06C75">	Projects</span><span style="color:#E5C07B">         SummaryItems</span><span style="color:#98C379"> `json:&quot;projects&quot; gorm:&quot;</span><mark data-highlighted-chars=""><span style="color:#98C379">constraint:OnUpdate:CASCADE,OnDelete:CASCADE</span></mark><span style="color:#98C379">&quot;`</span></span>
<span data-line=""><span style="color:#E06C75">	Languages</span><span style="color:#E5C07B">        SummaryItems</span><span style="color:#98C379"> `json:&quot;languages&quot; gorm:&quot;</span><mark data-highlighted-chars=""><span style="color:#98C379">constraint:OnUpdate:CASCADE,OnDelete:CASCADE</span></mark><span style="color:#98C379">&quot;`</span></span>
<span data-line=""><span style="color:#E06C75">	Editors</span><span style="color:#E5C07B">          SummaryItems</span><span style="color:#98C379"> `json:&quot;editors&quot; gorm:&quot;</span><mark data-highlighted-chars=""><span style="color:#98C379">constraint:OnUpdate:CASCADE,OnDelete:CASCADE</span></mark><span style="color:#98C379">&quot;`</span></span>
<span data-line=""><span style="color:#E06C75">	OperatingSystems</span><span style="color:#E5C07B"> SummaryItems</span><span style="color:#98C379"> `json:&quot;operating_systems&quot; gorm:&quot;</span><mark data-highlighted-chars=""><span style="color:#98C379">constraint:OnUpdate:CASCADE,OnDelete:CASCADE</span></mark><span style="color:#98C379">&quot;`</span></span>
<span data-line=""><span style="color:#E06C75">	Machines</span><span style="color:#E5C07B">         SummaryItems</span><span style="color:#98C379"> `json:&quot;machines&quot; gorm:&quot;</span><mark data-highlighted-chars=""><span style="color:#98C379">constraint:OnUpdate:CASCADE,OnDelete:CASCADE</span></mark><span style="color:#98C379">&quot;`</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> SummaryItems</span><span style="color:#ABB2BF"> []</span><span style="color:#C678DD">*</span><span style="color:#E5C07B">SummaryItem</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> SummaryItem</span><span style="color:#C678DD"> struct</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#E06C75">	Summary</span><span style="color:#C678DD">   *</span><span style="color:#E5C07B">Summary</span><span style="color:#98C379">      `json:&quot;-&quot; gorm:&quot;not null; </span><mark data-highlighted-chars=""><span style="color:#98C379">constraint:OnUpdate:CASCADE,OnDelete:CASCADE</span></mark><span style="color:#98C379">&quot;`</span></span>
<span data-line=""><span style="color:#E06C75">	SummaryID</span><span style="color:#C678DD"> uint</span><span style="color:#98C379">          `json:&quot;-&quot; gorm:&quot;size:32&quot;`</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<p>也就是说，<code>Summary</code>和<code>SummaryItem</code>两个表是1:m的关系，这个关系映射到数据库中，也就是<code>SummaryItem</code>表中有到<code>Summary</code>的ID的外键<code>summary_id</code>，而这个外键的约束则是通过<code>Summary</code>表中的tag定义的。</p>
<p>转回头去看生成的SQL，生成的SQL里有<strong>5</strong>个完全相同的外键（<code>fk_summaries_editors</code>, <code>fk_summaries_operating_systems</code>，<code>fk_summaries_machines</code>，<code>fk_summaries_projects</code>和<code>fk_summaries_languages</code>）。由于这五个外键都是级联删除（<code>ON DELETE CASCADE</code>）和级联更新（<code>ON UPDATE CASCADE</code>），实际上确实是会存在一个级联递归：当一个<code>SummaryItem</code>被删除，会造成其对应的<code>Summary</code>被删除，而<code>Summary</code>被删除可能会造成这个<code>SummaryItem</code>也被删除。</p>
<p>那问题又来了，那为什么之前在MySQL、PostgresSQL等数据库里均正常呢？通过<a href="https://stackoverflow.com/a/852047">这篇Stack Overflow</a>的回答，我们知道了这种问题在其他数据库中并不是问题：其他数据库会尝试解出一条级联路径出来。而SQL Server不会去尝试解，发现了这种循环，就会直接报错。</p>
<p>那如何解决这个问题呢？根据外键名和<code>Summary</code>中的属性的对应关系，我们可以推测，这五个外键是<code>Summary</code>中五个引用一一对应过来的。由于这五个外键实际上是一模一样的，只需要保留一个就可以了。所以，最终的解决方案是，只保留一个字段的外键tag，其他字段全部给一个<code>-</code>的tag，让gorm不要为这些字段生成外键。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/summary.go#L30</span></span>
<span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> Summary</span><span style="color:#C678DD"> struct</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#E06C75">	Projects</span><span style="color:#E5C07B"> SummaryItems</span><span style="color:#98C379"> `json:&quot;projects&quot; gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:CASCADE&quot;`</span></span>
<span data-line=""> </span>
<span data-line="" data-highlighted-line=""><span style="color:#E06C75">	Languages</span><span style="color:#E5C07B">        SummaryItems</span><span style="color:#98C379"> `json:&quot;languages&quot; gorm:&quot;-&quot;`</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#E06C75">	Editors</span><span style="color:#E5C07B">          SummaryItems</span><span style="color:#98C379"> `json:&quot;editors&quot; gorm:&quot;-&quot;`</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#E06C75">	OperatingSystems</span><span style="color:#E5C07B"> SummaryItems</span><span style="color:#98C379"> `json:&quot;operating_systems&quot; gorm:&quot;-&quot;`</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#E06C75">	Machines</span><span style="color:#E5C07B">         SummaryItems</span><span style="color:#98C379"> `json:&quot;machines&quot; gorm:&quot;-&quot;`</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<h2 id="规避gorm-sqlserver的bug"><a href="#规避gorm-sqlserver的bug" class="mr-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="inline-block opacity-20 hover:opacity-60" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>规避gorm sqlserver的bug</h2>
<p>至此，系统终于能启动起来了，并且大多数功能已经可以正常使用了。而在代码审核过程中，作者还<a href="https://github.com/muety/wakapi/pull/592#issuecomment-1892627154">发现了一个问题</a>：代码中有一个<code>Heartbeat</code>表，它就是wakatime的客户端插件定期给服务器端发送的数据，其中包含了正在工作的项目、使用的编程语言等信息。而这个表中有一个字段为<code>Hash</code>，这个字段的值根据其他信息算出来，并且有一个<code>unique index</code>，通过这个字段，就避免给<code>Heartbeat</code>表插入多个重复的数据。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/heartbeat.go#L13</span></span>
<span data-line=""><span style="color:#C678DD">type</span><span style="color:#E5C07B"> Heartbeat</span><span style="color:#C678DD"> struct</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#E06C75">	Hash</span><span style="color:#C678DD">            string</span><span style="color:#98C379">     `json:&quot;-&quot; gorm:&quot;type:varchar(17); uniqueIndex&quot;`</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<p>在插入的时候，作者使用了<code>ON CONFLICT DO NOTHING</code>的语句，这个语句的作用就是，如果当插入一行的时候，发现有些行违反了某个<code>unique index</code>的要求，则<strong>忽略</strong>这个问题，不插入这一行，也不报错。这刚好非常适合插入有可能有重复的<code>Heartbeat</code>的场景。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/repositories/heartbeat.go#L52</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">// 下述代码将会被映射为ON CONFLICT DO NOTHING</span></span>
<span data-line=""><span style="color:#C678DD">if</span><span style="color:#E06C75"> err</span><span style="color:#E5C07B"> :=</span><span style="color:#E06C75"> r</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">db</span><span style="color:#ABB2BF">.</span></span>
<span data-line=""><span style="color:#61AFEF">  Clauses</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">clause</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">OnConflict</span><span style="color:#ABB2BF">{</span></span>
<span data-line=""><span style="color:#E06C75">    DoNothing</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">,</span></span>
<span data-line=""><span style="color:#ABB2BF">  }).</span></span>
<span data-line=""><span style="color:#61AFEF">  Create</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">&amp;</span><span style="color:#E06C75">heartbeats</span><span style="color:#ABB2BF">).</span><span style="color:#E06C75">Error</span><span style="color:#ABB2BF">; </span><span style="color:#E06C75">err</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> nil</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#C678DD">  return</span><span style="color:#E06C75"> err</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span>
<span data-line=""><span style="color:#C678DD">return</span><span style="color:#D19A66"> nil</span></span></code></pre></figure>
<p>这种行为被称为<strong>插入或者更新</strong>，又被称为<strong>Upsert</strong>（Update/Insert），其行为是一个简单的判断：如果一行已经存在，则更新这一行的内容；如果不存在，则插入这一行。而如何判断<strong>一行是否存在</strong>呢？则是通过<code>unique index</code>来判断。</p>
<p>可是遗憾的是，SQL Server不支持<code>ON CONFLICT DO NOTHING</code>。要想在SQL Server中模拟upsert的行为，<a href="https://michaeljswart.com/2017/07/sql-server-upsert-patterns-and-antipatterns/">有很多方式</a>，一个比较常见的方法是使用<code>merge into</code>语句。具体如何编写比较复杂，这里就不再具体讲解。</p>
<p>由于这里是使用的gorm的API，并不是使用原生SQL语句，所以理论上来说，gorm是可以知道用户的意图，并根据不同的数据库生成行为相同的、但是兼容对应数据库的SQL语句的。根据<a href="https://github.com/go-gorm/sqlserver/issues/47">这个issue</a>，gorm的SQL Server库确实在很早之前就尝试通过生成一段的SQL Server兼容的SQL语句来支持这个功能，在gorm的文档里也<a href="https://gorm.io/docs/create.html#Upsert-x2F-On-Conflict">提到了</a>，<code>clause.OnConflict</code>会根据不同的数据库生成不同的语句，而对于SQL Server，其对应生成的正好就是<code>MERGE INTO</code>语句。</p>
<p>但是，既然库都支持了，那为什么还会遇到这个错误呢？再次检查所实际执行的SQL，发现这一次<code>Create</code>实际上生成的SQL语句仍然是最普通的<code>INSERT INTO</code>，并没有不是正确的<code>MERGE INTO</code>，。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="SQL" data-theme="one-dark-pro"><code data-language="SQL" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span>024/01/19 20:10:23 /home/ddadaal/Code/wakapi/repositories/heartbeat.go:54 mssql: Cannot insert duplicate key row in object &#x27;dbo.heartbeats&#x27; with unique index &#x27;idx_heartbeats_hash&#x27;. The duplicate key value is (d926be93ebcc4b6f).</span></span>
<span data-line=""> </span>
<span data-line=""><span>[10.830ms] [rows:0] </span><mark data-highlighted-chars=""><span>INSERT INTO</span></mark><span> &quot;heartbeats&quot; (&quot;user_id&quot;,&quot;entity&quot;,&quot;type&quot;,&quot;category&quot;,&quot;project&quot;,&quot;branch&quot;,&quot;language&quot;,&quot;is_write&quot;,&quot;editor&quot;,&quot;operating_system&quot;,&quot;machine&quot;,&quot;user_agent&quot;,&quot;time&quot;,&quot;hash&quot;,&quot;origin&quot;,&quot;origin_id&quot;,&quot;created_at&quot;) OUTPUT INSERTED.&quot;id&quot; VALUES (&#x27;ddadaal&#x27;,&#x27;/home/user1/dev/project1/main.go&#x27;,&#x27;file&#x27;,&#x27;&#x27;,&#x27;wakapi&#x27;,&#x27;&#x27;,&#x27;Go&#x27;,1,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;curl/8.5.0&#x27;,&#x27;2024-01-16 02:16:18.954&#x27;,&#x27;d926be93ebcc4b6f&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;2024-01-19 20:10:23.378&#x27;);</span></span></code></pre></figure>
<p>看来，要想弄明白这个问题，就得进到<code>gorm</code>的源码里来查看问题出在哪里了。使用VSCode启动一个调试版本的程序，给上面的代码的位置打上断电，使用<code>curl</code>连续插入两次同样的<code>Heartbeat</code>，根据断点往内查找，当进入到gorm的sqlserver的适配器的时候的代码的时候，我们发现了一些端倪：</p>
<p><figure><img alt="查找到可能出现bug的位置" loading="lazy" width="2252" height="1025" decoding="async" data-nimg="1" class="cursor-zoom-in mx-auto" style="color:transparent" srcSet="/articles/asset/contents/20240117-support-sqlserver-in-wakapi/sqlserver-adapter.png?width=3840 1x" src="/articles/asset/contents/20240117-support-sqlserver-in-wakapi/sqlserver-adapter.png?width=3840"/><figcaption class="text-center">查找到可能出现bug的位置</figcaption></figure></p>
<p>当前，我们正在图中的<code>if hasConflict</code>的位置，且<code>hasConflict</code>当前为true。根据下面的一段代码，如果<code>hasConflict</code>为<code>true</code>的话，将会进入<code>MergeCreate</code>函数，而这个函数即是一个在MySQL实现类似行为的SQL的语句的代码。但是，实际在橙色块结束后，<code>hasConflict</code><strong>被改成了<code>false</code></strong>，所以最终并没有进入<code>MergeCreate</code>，最终的结果就是一个普通的<code>INSERT INTO</code> SQL。那么也就是说，橙色这段代码就是罪魁祸首！</p>
<p>这段代码干了什么事情呢？简单来说，它会检查要插入的行中的各个列中有没有包含主键。如果没有设置主键，则将会把<code>hasConflict</code>改为<code>false</code>；而如何设置了主键，才会进入<code>MERGE INTO</code>流程。回想前面，要想正确生成upsert行为，我们需要判断<strong>一行是否存在</strong>。而很显然，这里的代码将<strong>一行是否存在</strong>的判断标准等价为了主键是否存在，而忽略了其他具有的<code>unique index</code>的列。</p>
<p>当然，其他人也发现了这个问题，gorm-sqlserver的仓库中也有<a href="https://github.com/go-gorm/sqlserver/issues/100">已经半年前打开的issue</a>正好就是关于这个问题。而很遗憾，这个问题过了半年依然没有修复。</p>
<p>要想解决这个问题，有多种方法，而我最终选择了最简单粗暴的方法：不管！这个函数的目的是同时插入多个<code>Heartbeatt</code>，那我们就手动一个一个插入，如果一个行插入失败了，我们简单判断一下，如果这个错误是因为hash重复造成了，那我们就不管了！检查了一下代码中调用这个方法的场景，其实大多数情况下都是只插入一行，所以这样写对性能造成的影响是可以接受的。</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#282c34;color:#abb2bf" tabindex="0" data-language="go" data-theme="one-dark-pro"><code data-language="go" data-theme="one-dark-pro" style="display:grid"><span data-line=""><span style="color:#7F848E;font-style:italic">// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/repositories/heartbeat.go#L34</span></span>
<span data-line=""><span style="color:#C678DD">if</span><span style="color:#E06C75"> r</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">db</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">Dialector</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Name</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">==</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">sqlserver</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Dialector</span><span style="color:#ABB2BF">{}).</span><span style="color:#61AFEF">Name</span><span style="color:#ABB2BF">() {</span></span>
<span data-line=""><span style="color:#C678DD">  for</span><span style="color:#E06C75"> _</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75">h</span><span style="color:#E5C07B"> :=</span><span style="color:#C678DD"> range</span><span style="color:#E06C75"> heartbeats</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#E06C75">    err</span><span style="color:#E5C07B"> :=</span><span style="color:#E06C75"> r</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">db</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Create</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75">h</span><span style="color:#ABB2BF">).</span><span style="color:#E06C75">Error</span></span>
<span data-line=""><span style="color:#C678DD">    if</span><span style="color:#E06C75"> err</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> nil</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#C678DD">      if</span><span style="color:#E06C75"> strings</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Contains</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75">err</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Error</span><span style="color:#ABB2BF">(), </span><span style="color:#98C379">&quot;Cannot insert duplicate key row in object &#x27;dbo.heartbeats&#x27; with unique index &#x27;idx_heartbeats_hash&#x27;&quot;</span><span style="color:#ABB2BF">) {</span></span>
<span data-line=""><span style="color:#7F848E;font-style:italic">        // ignored</span></span>
<span data-line=""><span style="color:#ABB2BF">      } </span><span style="color:#C678DD">else</span><span style="color:#ABB2BF"> {</span></span>
<span data-line=""><span style="color:#C678DD">        return</span><span style="color:#E06C75"> err</span></span>
<span data-line=""><span style="color:#ABB2BF">      }</span></span>
<span data-line=""><span style="color:#ABB2BF">    }</span></span>
<span data-line=""><span style="color:#ABB2BF">  }</span></span>
<span data-line=""><span style="color:#C678DD">  return</span><span style="color:#D19A66"> nil</span></span>
<span data-line=""><span style="color:#ABB2BF">}</span></span></code></pre></figure>
<h1 id="总算还是完成了"><a href="#总算还是完成了" class="mr-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="inline-block opacity-20 hover:opacity-60" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>总算还是完成了</h1>
<p>终于，经过了一周的时间，本来以为只是一个简单的调库，结果却发现了这么多的问题。经过这个过程，之前连SQL Server用都没用过的我也知道了很多SQL Server的细节；之前没有接触过gorm，现在却连源代码都好好翻了一通。</p>
<p>而关于go，虽然我一直不喜欢go的语法，觉得它太简单，类型系统太弱，很多代码都花在固定的模板代码上（比如<code>if err := nil</code>），但是不得不承认的一点是，go确实非常的<strong>explicit</strong>。没那么多乱七八糟的反射、运行时黑魔法，控制流非常清晰，想知道什么代码调用了一个方法，直接<code>Shift+F12</code>就完事了，出来的结果不会多不会少；要想某个错误是在哪里处理的，跟着繁琐的错误处理代码总能找到。它确实缺少一些特性，但是它非常地工业化。</p>
<p>解决这些问题后，PR顺利合并进了主分支，成就感满满，这可能也是我第一个没那么简单的开源项目的贡献了。</p>
<p><figure><img alt="https://github.com/muety/wakapi/pull/592" loading="lazy" width="2429" height="1882" decoding="async" data-nimg="1" class="cursor-zoom-in mx-auto" style="color:transparent" srcSet="/articles/asset/contents/20240117-support-sqlserver-in-wakapi/pr-merged.png?width=3840 1x" src="/articles/asset/contents/20240117-support-sqlserver-in-wakapi/pr-merged.png?width=3840"/><figcaption class="text-center">https://github.com/muety/wakapi/pull/592</figcaption></figure></p>
<p>对我来说，设定一个目标是学习的最好的途径，在这次实践里再次得到了印证。</p></div><div class="hidden lg:block lg:w-[25%]"><div class="px-1 sticky top-24 max-h-[60vh] overflow-auto"><div class="flex space-x-1 items-center py-2"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h14v-2H3v2zm16 0h2v-2h-2v2zm0-10v2h2V7h-2zm0 6h2v-2h-2v2z"></path></svg><span>目录</span></div><ul class="pl-2 border-l border-neutral"><li class="w-full text-sm"><a class="transition hover:bg-base-300 rounded w-full flex p-1" data-tocid="summary" href="#summary"><span class="font-bold">✨AI全文摘要</span></a></li><li class="w-full text-sm"><a class="transition hover:bg-base-300 rounded w-full flex p-1" data-tocid="不就是调库嘛" href="#不就是调库嘛">不就是调库嘛……</a></li><li class="w-full text-sm"><a class="transition hover:bg-base-300 rounded w-full flex p-1" data-tocid="遇到并解决一个一个一个的问题" href="#遇到并解决一个一个一个的问题">遇到并解决一个一个一个的问题</a><ul class="pl-2 border-l border-neutral"><li class="w-full text-sm"><a class="transition hover:bg-base-300 rounded w-full flex p-1" data-tocid="sql语句" href="#sql语句">SQL语句</a></li><li class="w-full text-sm"><a class="transition hover:bg-base-300 rounded w-full flex p-1" data-tocid="sql语句片段" href="#sql语句片段">SQL语句片段</a></li><li class="w-full text-sm"><a class="transition hover:bg-base-300 rounded w-full flex p-1" data-tocid="重用dialector的逻辑为关键词加上引号" href="#重用dialector的逻辑为关键词加上引号">重用Dialector的逻辑，为关键词加上引号</a></li><li class="w-full text-sm"><a class="transition hover:bg-base-300 rounded w-full flex p-1" data-tocid="重写不支持的功能" href="#重写不支持的功能">重写不支持的功能</a></li><li class="w-full text-sm"><a class="transition hover:bg-base-300 rounded w-full flex p-1" data-tocid="把同一个go类型在不同的数据库中映射为不同的列类型" href="#把同一个go类型在不同的数据库中映射为不同的列类型">把同一个go类型在不同的数据库中映射为不同的列类型</a></li><li class="w-full text-sm"><a class="transition hover:bg-base-300 rounded w-full flex p-1" data-tocid="避免创建递归的级联修改外键约束" href="#避免创建递归的级联修改外键约束">避免创建递归的级联修改外键约束</a></li><li class="w-full text-sm"><a class="transition hover:bg-base-300 rounded w-full flex p-1" data-tocid="规避gorm-sqlserver的bug" href="#规避gorm-sqlserver的bug">规避gorm sqlserver的bug</a></li></ul></li><li class="w-full text-sm"><a class="transition hover:bg-base-300 rounded w-full flex p-1" data-tocid="总算还是完成了" href="#总算还是完成了">总算还是完成了</a></li></ul></div></div></div></div><div class="max-w-7xl mx-auto p-4"></div><div class="max-w-7xl mx-auto p-4"><div><h2 class="text-2xl font-bold mb-2 flex items-center"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M416 192c0-88.4-93.1-160-208-160S0 103.6 0 192c0 34.3 14.1 65.9 38 92-13.4 30.2-35.5 54.2-35.8 54.5-2.2 2.3-2.8 5.7-1.5 8.7S4.8 352 8 352c36.6 0 66.9-12.3 88.7-25 32.2 15.7 70.3 25 111.3 25 114.9 0 208-71.6 208-160zm122 220c23.9-26 38-57.7 38-92 0-66.9-53.5-124.2-129.3-148.1.9 6.6 1.3 13.3 1.3 20.1 0 105.9-107.7 192-240 192-10.8 0-21.3-.8-31.7-1.9C207.8 439.6 281.8 480 368 480c41 0 79.1-9.2 111.3-25 21.8 12.7 52.1 25 88.7 25 3.2 0 6.1-1.9 7.3-4.8 1.3-2.9.7-6.3-1.5-8.7-.3-.3-22.4-24.2-35.8-54.5z"></path></svg><span class="mx-2"> 评论</span></h2></div></div></div></article></div><footer class="bg-base-200 text-base-content"><div class="footer py-6 max-w-7xl mx-auto px-4"><div class="space-y-1"><p>👨🏼‍💻 <!-- -->本网站由<a class="link link-hover" href="/about/me/cn">ddadaal</a>自豪地编写</p><p>📝<!-- -->本站文章在<a rel="licene noreferrer" target="_blank" class="link" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>协议下授权</p><div class="tooltip" data-tip="2018-11-17 06:51:00 UTC+0"><p>📅<!-- --> <!-- -->博客已经运行 <span class="countdown"><span style="--value:6"></span></span> 年 <span class="countdown"><span style="--value:9"></span></span> 月 <span class="countdown"><span style="--value:13"></span></span> 天 <span class="countdown"><span style="--value:5"></span></span> 时 <span class="countdown"><span style="--value:5"></span></span> 分 <span class="countdown"><span style="--value:35"></span></span> 秒</p></div><p>⏲️<!-- --> <!-- -->最后更新<!-- -->:  <!-- -->2025-07-26 11:56:35 UTC+0</p><div><p>📲<!-- --> <!-- -->联系我</p><div class="flex py-2 gap-2"><span><a href="http://wpa.qq.com/msgrd?v=3&amp;uin=540232834&amp;site=qq&amp;menu=yes" title="QQ: 540232834" target="_blank" class="block transition hover:scale-125" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="22.400000000000002" width="22.400000000000002" xmlns="http://www.w3.org/2000/svg"><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704z"></path></svg></a></span><span><a href="mailto://ddadaal.me@outlook.com" title="E-mail: ddadaal@outlook.com" target="_blank" class="block transition hover:scale-125" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="22.400000000000002" width="22.400000000000002" xmlns="http://www.w3.org/2000/svg"><path d="M160 448c-25.6 0-51.2-22.4-64-32-64-44.8-83.2-60.8-96-70.4V480c0 17.67 14.33 32 32 32h256c17.67 0 32-14.33 32-32V345.6c-12.8 9.6-32 25.6-96 70.4-12.8 9.6-38.4 32-64 32zm128-192H32c-17.67 0-32 14.33-32 32v16c25.6 19.2 22.4 19.2 115.2 86.4 9.6 6.4 28.8 25.6 44.8 25.6s35.2-19.2 44.8-22.4c92.8-67.2 89.6-67.2 115.2-86.4V288c0-17.67-14.33-32-32-32zm256-96H224c-17.67 0-32 14.33-32 32v32h96c33.21 0 60.59 25.42 63.71 57.82l.29-.22V416h192c17.67 0 32-14.33 32-32V192c0-17.67-14.33-32-32-32zm-32 128h-64v-64h64v64zm-352-96c0-35.29 28.71-64 64-64h224V32c0-17.67-14.33-32-32-32H96C78.33 0 64 14.33 64 32v192h96v-32z"></path></svg></a></span><span><a href="https://www.linkedin.com/in/chenjunda/" title="LinkedIn: 陈俊达" target="_blank" class="block transition hover:scale-125" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="22.400000000000002" width="22.400000000000002" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></span><span><a href="https://github.com/ddadaal" title="GitHub: ddadaal" target="_blank" class="block transition hover:scale-125" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="22.400000000000002" width="22.400000000000002" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></span><span><a href="https://steamcommunity.com/profiles/76561198104889782" title="Steam: Victor Crubs" target="_blank" class="block transition hover:scale-125" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="22.400000000000002" width="22.400000000000002" xmlns="http://www.w3.org/2000/svg"><path d="M496 256c0 137-111.2 248-248.4 248-113.8 0-209.6-76.3-239-180.4l95.2 39.3c6.4 32.1 34.9 56.4 68.9 56.4 39.2 0 71.9-32.4 70.2-73.5l84.5-60.2c52.1 1.3 95.8-40.9 95.8-93.5 0-51.6-42-93.5-93.7-93.5s-93.7 42-93.7 93.5v1.2L176.6 279c-15.5-.9-30.7 3.4-43.5 12.1L0 236.1C10.2 108.4 117.1 8 247.6 8 384.8 8 496 119 496 256zM155.7 384.3l-30.5-12.6a52.79 52.79 0 0 0 27.2 25.8c26.9 11.2 57.8-1.6 69-28.4 5.4-13 5.5-27.3.1-40.3-5.4-13-15.5-23.2-28.5-28.6-12.9-5.4-26.7-5.2-38.9-.6l31.5 13c19.8 8.2 29.2 30.9 20.9 50.7-8.3 19.9-31 29.2-50.8 21zm173.8-129.9c-34.4 0-62.4-28-62.4-62.3s28-62.3 62.4-62.3 62.4 28 62.4 62.3-27.9 62.3-62.4 62.3zm.1-15.6c25.9 0 46.9-21 46.9-46.8 0-25.9-21-46.8-46.9-46.8s-46.9 21-46.9 46.8c.1 25.8 21.1 46.8 46.9 46.8z"></path></svg></a></span><span><a href="https://zhihu.com/people/VicCrubs" title="知乎：陈俊达" target="_blank" class="block transition hover:scale-125" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 640 512" height="22.400000000000002" width="22.400000000000002" xmlns="http://www.w3.org/2000/svg"><path d="M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13H170.54zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82v170.31zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62v.01zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2l19.23 14.43zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.93-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78l.03-.01z"></path></svg></a></span><span><a href="https://www.douban.com/people/183064260/" title="豆瓣: ddadaal" target="_blank" class="block transition hover:scale-125" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" height="22.400000000000002" width="22.400000000000002" xmlns="http://www.w3.org/2000/svg"><path d="M.51 3.06h22.98V.755H.51V3.06Zm20.976 2.537v9.608h-2.137l-1.669 5.76H24v2.28H0v-2.28h6.32l-1.67-5.76H2.515V5.597h18.972Zm-5.066 9.608H7.58l1.67 5.76h5.501l1.67-5.76ZM18.367 7.9H5.634v5.025h12.733V7.9Z"></path></svg></a></span></div></div><p class="text-center">©<!-- --> <!-- -->2025<!-- --> <!-- -->|<!-- --> <!-- -->用 ❤ 制作</p></div><div><span class="footer-title">🚀<!-- --> <!-- -->强力驱动</span><a class="link link-hover" target="_blank" href="https://reactjs.org/" rel="noreferrer">React</a><a class="link link-hover" target="_blank" href="https://nextjs.org/" rel="noreferrer">Next.js</a><a class="link link-hover" target="_blank" href="https://pages.github.com/" rel="noreferrer">GitHub Pages</a><a class="link link-hover" target="_blank" href="https://www.typescriptlang.org/" rel="noreferrer">TypeScript</a></div><div><span class="footer-title">🎨<!-- --> <!-- -->描绘主题</span><a class="link link-hover" target="_blank" href="https://daisyui.com/" rel="noreferrer">daisyui</a><a class="link link-hover" target="_blank" href="https://tailwindcss.com/" rel="noreferrer">tailwind</a></div><div><span class="footer-title">🎓<!-- --> <!-- -->联系我</span><a class="link link-hover" target="_blank" href="https://idealclover.top" rel="noreferrer">idealclover - 翠翠酱的个人网站</a><a class="link link-hover" target="_blank" href="https://sephidator.xyz" rel="noreferrer">Sephidator - Sephidator的个人博客</a><a class="link link-hover" target="_blank" href="https://iznauy.github.io/" rel="noreferrer">iznauy - 个人博客</a><a class="link link-hover" target="_blank" href="https://aironoria.github.io" rel="noreferrer">Aironoria - 陈俊宇的个人博客</a><a class="link link-hover" target="_blank" href="https://jbesu.com/" rel="noreferrer">forewing - 个人主页</a><a class="link link-hover" target="_blank" href="https://weiser.fun" rel="noreferrer">Weiser - 个人主页</a></div></div></footer><button class="fixed animate-slide-up bottom-8 right-8 z-50 p-3 rounded-full bg-base-300 text-base-content shadow" title="To top"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" class="w-6 h-6" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"></path></svg></button><script src="/_next/static/chunks/webpack-1304466d85e75d46.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n3:I[6221,[],\"\"]\n4:I[5657,[],\"\"]\n6:I[8002,[],\"OutletBoundary\"]\n8:I[8002,[],\"MetadataBoundary\"]\na:I[8002,[],\"ViewportBoundary\"]\nc:I[4404,[],\"\"]\n:HL[\"/_next/static/css/54c4c90f0e4aaa79.css\",\"style\"]\n:HL[\"/_next/static/css/fe1e54f11bde7158.css\",\"style\"]\n:HL[\"/_next/static/css/0e452e629ebb050b.css\",\"style\"]\n:HL[\"/_next/static/css/550cc6711c036586.css\",\"style\"]\n:HL[\"/_next/static/css/84af3e6cc7365e2a.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"uWHwsu0GrSMYwwuz4nIEB\",\"p\":\"\",\"c\":[\"\",\"articles\",\"support-sqlserver-in-wakapi\",\"cn\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"articles\",{\"children\":[[\"params\",\"support-sqlserver-in-wakapi/cn\",\"oc\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/54c4c90f0e4aaa79.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],\"$L2\"]}],{\"children\":[\"articles\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"articles\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"params\",\"support-sqlserver-in-wakapi/cn\",\"oc\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"articles\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/fe1e54f11bde7158.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/0e452e629ebb050b.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"2\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/550cc6711c036586.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"3\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/84af3e6cc7365e2a.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$L6\",null,{\"children\":\"$L7\"}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"FnVaMMd718ygi0eXZcUSw\",{\"children\":[[\"$\",\"$L8\",null,{\"children\":\"$L9\"}],[\"$\",\"$La\",null,{\"children\":\"$Lb\"}],null]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$c\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"d:I[1574,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"325\",\"static/chunks/325-924239ad7bda233c.js\",\"177\",\"static/chunks/app/layout-7026065b75b2b00f.js\"],\"RootLayout\"]\ne:I[2061,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"325\",\"static/chunks/325-924239ad7bda233c.js\",\"177\",\"static/chunks/app/layout-7026065b75b2b00f.js\"],\"\"]\nf:I[2725,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"325\",\"static/chunks/325-924239ad7bda233c.js\",\"177\",\"static/chunks/app/layout-7026065b75b2b00f.js\"],\"Header\"]\n10:I[7583,[\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"974\",\"static/chunks/app/page-6cd03741a79daf91.js\"],\"Localized\"]\n11:I[1453,[\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"974\",\"static/chunks/app/page-6cd03741a79daf91.js\"],\"LocalizedArticleLink\"]\n12:I[8077,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"325\",\"static/chunks/325-924239ad7bda233c.js\",\"177\",\"static/chunks/app/layout-7026065b75b2b00f.js\"],\"RunningTime\"]\n13:I[665,[\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"974\",\"static/chunks/app/page-6cd03741a79daf91.js\"],\"LastUpdateTime\"]\n16:I[7365,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"325\",\"static/chunks/325-924239ad7bda233c.js\",\"177\",\"static/chunks/app/layout-7026065b75b2b00f.js\"],\"ToTop\"]\n14:T518,M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9"])</script><script>self.__next_f.push([1,".3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z15:T5b8,M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13H170.54zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82v170.31zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62v.01zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2l19.23 14.43zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.9"])</script><script>self.__next_f.push([1,"3-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78l.03-.01z"])</script><script>self.__next_f.push([1,"2:[\"$\",\"$Ld\",null,{\"children\":[[\"$\",\"$Le\",null,{\"data-host\":\"https://services.ddadaal.me\",\"data-dnt\":\"false\",\"src\":\"https://services.ddadaal.me/monitor/script.js\",\"id\":\"ZwSg9rf6GA\",\"async\":true,\"defer\":true}],[\"$\",\"$Lf\",null,{\"resumeLangs\":[\"cn\",\"en\"]}],[\"$\",\"div\",null,{\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],[\"$\",\"footer\",null,{\"className\":\"bg-base-200 text-base-content\",\"children\":[\"$\",\"div\",null,{\"className\":\"footer py-6 max-w-7xl mx-auto px-4\",\"children\":[[\"$\",\"div\",null,{\"className\":\"space-y-1\",\"children\":[[\"$\",\"p\",null,{\"children\":[\"👨🏼‍💻 \",[\"$\",\"$L10\",null,{\"id\":\"footer.codeBy\",\"args\":[[\"$\",\"$L11\",\"about/me\",{\"className\":\"link link-hover\",\"basePath\":\"/about/me\",\"children\":\"ddadaal\"}]]}]]}],[\"$\",\"p\",null,{\"children\":[\"📝\",[\"$\",\"$L10\",null,{\"id\":\"footer.license\",\"args\":[[\"$\",\"a\",\"license\",{\"rel\":\"licene noreferrer\",\"target\":\"_blank\",\"className\":\"link\",\"href\":\"https://creativecommons.org/licenses/by-sa/4.0/\",\"children\":\"CC BY-SA 4.0\"}]]}]]}],[\"$\",\"$L12\",null,{\"serverStartTime\":\"2025-07-26T11:56:35.007+00:00\"}],[\"$\",\"$L13\",null,{\"time\":\"2025-07-26T11:56:35.007+00:00\"}],[\"$\",\"div\",null,{\"children\":[[\"$\",\"p\",null,{\"children\":[\"📲\",\" \",[\"$\",\"$L10\",null,{\"id\":\"footer.contacts\"}]]}],[\"$\",\"div\",null,{\"className\":\"flex py-2 gap-2\",\"children\":[[\"$\",\"span\",\"http://wpa.qq.com/msgrd?v=3\u0026uin=540232834\u0026site=qq\u0026menu=yes\",{\"children\":[\"$\",\"a\",null,{\"href\":\"http://wpa.qq.com/msgrd?v=3\u0026uin=540232834\u0026site=qq\u0026menu=yes\",\"title\":\"QQ: 540232834\",\"target\":\"_blank\",\"className\":\"block transition hover:scale-125\",\"rel\":\"noreferrer\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 448 512\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704z\",\"children\":[]}]]],\"className\":\"$undefined\",\"style\":{\"color\":\"$undefined\"},\"height\":22.400000000000002,\"width\":22.400000000000002,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}]}],[\"$\",\"span\",\"mailto://ddadaal.me@outlook.com\",{\"children\":[\"$\",\"a\",null,{\"href\":\"mailto://ddadaal.me@outlook.com\",\"title\":\"E-mail: ddadaal@outlook.com\",\"target\":\"_blank\",\"className\":\"block transition hover:scale-125\",\"rel\":\"noreferrer\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 576 512\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"M160 448c-25.6 0-51.2-22.4-64-32-64-44.8-83.2-60.8-96-70.4V480c0 17.67 14.33 32 32 32h256c17.67 0 32-14.33 32-32V345.6c-12.8 9.6-32 25.6-96 70.4-12.8 9.6-38.4 32-64 32zm128-192H32c-17.67 0-32 14.33-32 32v16c25.6 19.2 22.4 19.2 115.2 86.4 9.6 6.4 28.8 25.6 44.8 25.6s35.2-19.2 44.8-22.4c92.8-67.2 89.6-67.2 115.2-86.4V288c0-17.67-14.33-32-32-32zm256-96H224c-17.67 0-32 14.33-32 32v32h96c33.21 0 60.59 25.42 63.71 57.82l.29-.22V416h192c17.67 0 32-14.33 32-32V192c0-17.67-14.33-32-32-32zm-32 128h-64v-64h64v64zm-352-96c0-35.29 28.71-64 64-64h224V32c0-17.67-14.33-32-32-32H96C78.33 0 64 14.33 64 32v192h96v-32z\",\"children\":[]}]]],\"className\":\"$undefined\",\"style\":{\"color\":\"$undefined\"},\"height\":22.400000000000002,\"width\":22.400000000000002,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}]}],[\"$\",\"span\",\"https://www.linkedin.com/in/chenjunda/\",{\"children\":[\"$\",\"a\",null,{\"href\":\"https://www.linkedin.com/in/chenjunda/\",\"title\":\"LinkedIn: 陈俊达\",\"target\":\"_blank\",\"className\":\"block transition hover:scale-125\",\"rel\":\"noreferrer\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 448 512\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z\",\"children\":[]}]]],\"className\":\"$undefined\",\"style\":{\"color\":\"$undefined\"},\"height\":22.400000000000002,\"width\":22.400000000000002,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}]}],[\"$\",\"span\",\"https://github.com/ddadaal\",{\"children\":[\"$\",\"a\",null,{\"href\":\"https://github.com/ddadaal\",\"title\":\"GitHub: ddadaal\",\"target\":\"_blank\",\"className\":\"block transition hover:scale-125\",\"rel\":\"noreferrer\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 496 512\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$14\",\"children\":[]}]]],\"className\":\"$undefined\",\"style\":{\"color\":\"$undefined\"},\"height\":22.400000000000002,\"width\":22.400000000000002,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}]}],[\"$\",\"span\",\"https://steamcommunity.com/profiles/76561198104889782\",{\"children\":[\"$\",\"a\",null,{\"href\":\"https://steamcommunity.com/profiles/76561198104889782\",\"title\":\"Steam: Victor Crubs\",\"target\":\"_blank\",\"className\":\"block transition hover:scale-125\",\"rel\":\"noreferrer\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 496 512\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"M496 256c0 137-111.2 248-248.4 248-113.8 0-209.6-76.3-239-180.4l95.2 39.3c6.4 32.1 34.9 56.4 68.9 56.4 39.2 0 71.9-32.4 70.2-73.5l84.5-60.2c52.1 1.3 95.8-40.9 95.8-93.5 0-51.6-42-93.5-93.7-93.5s-93.7 42-93.7 93.5v1.2L176.6 279c-15.5-.9-30.7 3.4-43.5 12.1L0 236.1C10.2 108.4 117.1 8 247.6 8 384.8 8 496 119 496 256zM155.7 384.3l-30.5-12.6a52.79 52.79 0 0 0 27.2 25.8c26.9 11.2 57.8-1.6 69-28.4 5.4-13 5.5-27.3.1-40.3-5.4-13-15.5-23.2-28.5-28.6-12.9-5.4-26.7-5.2-38.9-.6l31.5 13c19.8 8.2 29.2 30.9 20.9 50.7-8.3 19.9-31 29.2-50.8 21zm173.8-129.9c-34.4 0-62.4-28-62.4-62.3s28-62.3 62.4-62.3 62.4 28 62.4 62.3-27.9 62.3-62.4 62.3zm.1-15.6c25.9 0 46.9-21 46.9-46.8 0-25.9-21-46.8-46.9-46.8s-46.9 21-46.9 46.8c.1 25.8 21.1 46.8 46.9 46.8z\",\"children\":[]}]]],\"className\":\"$undefined\",\"style\":{\"color\":\"$undefined\"},\"height\":22.400000000000002,\"width\":22.400000000000002,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}]}],[\"$\",\"span\",\"https://zhihu.com/people/VicCrubs\",{\"children\":[\"$\",\"a\",null,{\"href\":\"https://zhihu.com/people/VicCrubs\",\"title\":\"知乎：陈俊达\",\"target\":\"_blank\",\"className\":\"block transition hover:scale-125\",\"rel\":\"noreferrer\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 640 512\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$15\",\"children\":[]}]]],\"className\":\"$undefined\",\"style\":{\"color\":\"$undefined\"},\"height\":22.400000000000002,\"width\":22.400000000000002,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}]}],[\"$\",\"span\",\"https://www.douban.com/people/183064260/\",{\"children\":[\"$\",\"a\",null,{\"href\":\"https://www.douban.com/people/183064260/\",\"title\":\"豆瓣: ddadaal\",\"target\":\"_blank\",\"className\":\"block transition hover:scale-125\",\"rel\":\"noreferrer\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"role\":\"img\",\"viewBox\":\"0 0 24 24\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"M.51 3.06h22.98V.755H.51V3.06Zm20.976 2.537v9.608h-2.137l-1.669 5.76H24v2.28H0v-2.28h6.32l-1.67-5.76H2.515V5.597h18.972Zm-5.066 9.608H7.58l1.67 5.76h5.501l1.67-5.76ZM18.367 7.9H5.634v5.025h12.733V7.9Z\",\"children\":[]}]]],\"className\":\"$undefined\",\"style\":{\"color\":\"$undefined\"},\"height\":22.400000000000002,\"width\":22.400000000000002,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}]}]]}]]}],[\"$\",\"p\",null,{\"className\":\"text-center\",\"children\":[\"©\",\" \",2025,\" \",\"|\",\" \",[\"$\",\"$L10\",null,{\"id\":\"footer.madeWithLove\"}]]}]]}],[\"$\",\"div\",null,{\"children\":[[\"$\",\"span\",null,{\"className\":\"footer-title\",\"children\":[\"🚀\",\" \",[\"$\",\"$L10\",null,{\"id\":\"footer.poweredBy\"}]]}],[[\"$\",\"a\",\"React\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://reactjs.org/\",\"rel\":\"noreferrer\",\"children\":\"React\"}],[\"$\",\"a\",\"Next.js\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://nextjs.org/\",\"rel\":\"noreferrer\",\"children\":\"Next.js\"}],[\"$\",\"a\",\"GitHub Pages\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://pages.github.com/\",\"rel\":\"noreferrer\",\"children\":\"GitHub Pages\"}],[\"$\",\"a\",\"TypeScript\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://www.typescriptlang.org/\",\"rel\":\"noreferrer\",\"children\":\"TypeScript\"}]]]}],[\"$\",\"div\",null,{\"children\":[[\"$\",\"span\",null,{\"className\":\"footer-title\",\"children\":[\"🎨\",\" \",[\"$\",\"$L10\",null,{\"id\":\"footer.themedWith\"}]]}],[[\"$\",\"a\",\"daisyui\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://daisyui.com/\",\"rel\":\"noreferrer\",\"children\":\"daisyui\"}],[\"$\",\"a\",\"tailwind\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://tailwindcss.com/\",\"rel\":\"noreferrer\",\"children\":\"tailwind\"}]]]}],[\"$\",\"div\",null,{\"children\":[[\"$\",\"span\",null,{\"className\":\"footer-title\",\"children\":[\"🎓\",\" \",[\"$\",\"$L10\",null,{\"id\":\"footer.contacts\"}]]}],[[\"$\",\"a\",\"idealclover - 翠翠酱的个人网站\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://idealclover.top\",\"rel\":\"noreferrer\",\"children\":\"idealclover - 翠翠酱的个人网站\"}],[\"$\",\"a\",\"Sephidator - Sephidator的个人博客\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://sephidator.xyz\",\"rel\":\"noreferrer\",\"children\":\"Sephidator - Sephidator的个人博客\"}],[\"$\",\"a\",\"iznauy - 个人博客\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://iznauy.github.io/\",\"rel\":\"noreferrer\",\"children\":\"iznauy - 个人博客\"}],[\"$\",\"a\",\"Aironoria - 陈俊宇的个人博客\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://aironoria.github.io\",\"rel\":\"noreferrer\",\"children\":\"Aironoria - 陈俊宇的个人博客\"}],[\"$\",\"a\",\"forewing - 个人主页\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://jbesu.com/\",\"rel\":\"noreferrer\",\"children\":\"forewing - 个人主页\"}],[\"$\",\"a\",\"Weiser - 个人主页\",{\"className\":\"link link-hover\",\"target\":\"_blank\",\"href\":\"https://weiser.fun\",\"rel\":\"noreferrer\",\"children\":\"Weiser - 个人主页\"}]]]}]]}]}],[\"$\",\"$L16\",null,{}]]}]\n"])</script><script>self.__next_f.push([1,"17:I[4378,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"413\",\"static/chunks/7a1bdfe6-8f7609c25899d936.js\",\"994\",\"static/chunks/c4aeae87-2a85323a0275cbf9.js\",\"786\",\"static/chunks/1b3e99d6-50521588821d44ca.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"826\",\"static/chunks/826-c44bffd752ec02cd.js\",\"467\",\"static/chunks/467-ff6f7f0e9f0462a7.js\",\"971\",\"static/chunks/app/articles/%5B%5B...params%5D%5D/page-59c8401fd7fff2e0.js\"],\"ArticleFrontmatter\"]\n1a:I[4674,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"413\",\"static/chunks/7a1bdfe6-8f7609c25899d936.js\",\"994\",\"static/chunks/c4aeae87-2a85323a0275cbf9.js\",\"786\",\"static/chunks/1b3e99d6-50521588821d44ca.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"826\",\"static/chunks/826-c44bffd752ec02cd.js\",\"467\",\"static/chunks/467-ff6f7f0e9f0462a7.js\",\"971\",\"static/chunks/app/articles/%5B%5B...params%5D%5D/page-59c8401fd7fff2e0.js\"],\"RelatedArticles\"]\n1b:I[3373,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"413\",\"static/chunks/7a1bdfe6-8f7609c25899d936.js\",\"994\",\"static/chunks/c4aeae87-2a85323a0275cbf9.js\",\"786\",\"static/chunks/1b3e99d6-50521588821d44ca.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"826\",\"static/chunks/826-c44bffd752ec02cd.js\",\"467\",\"static/chunks/467-ff6f7f0e9f0462a7.js\",\"971\",\"static/chunks/app/articles/%5B%5B...params%5D%5D/page-59c8401fd7fff2e0.js\"],\"CommentPanelWithCurrentLanguage\"]\n18:T7bca,"])</script><script>self.__next_f.push([1,"\n# 不就是调库嘛……\n\n在[上一篇文章](/articles/added-blog-page-click-monitoring)中，我给博客增加了点击量监测，并将这个服务部署到了Azure，数据库采用了使用SQL Server的Azure的SQL服务。由于SQL Server有免费的订阅，微软的Azure Data Studio也还算好用，于是我觉得可以重用一下刚才学习的这个技能，将其他的服务也使用SQL Server部署。\n\n我之前在用[wakatime](https://wakatime.com/)来记录我的编程的数据（例如每天的编程时间、所使用的编程语言等），但是wakatime免费用户只能保存14天的数据，而且wakatime没有提供官方的可自己部署的后端，所以我也一直在寻找wakatime的替代品。之前尝试使用了一段时间的[codetime](https://codetime.dev/)。这个软件的功能和wakatime类似，但是它当前只支持VSCode客户端，虽然免费保存数据，但是仍然没有提供可自己部署的后端。我在很早之前也尝试找过wakatime的后端替代品，但是当时并没有找到一个能用的。但前不久，同学给我推荐了[wakapi](https://www.wakapi.com/)项目，这个项目重新实现了wakatime的后端API，这样wakatime的丰富的客户端插件可以直接使用，并且完全可以自己部署，不用担心数据并存放在别人的服务器上。\n\n它就是我一直寻找的wakatime替代品！\n\n很激动地浏览了一下项目，看到wakapi当时并没有原生支持SQL Server，但是在README中提到，wakatime使用了[gorm](https://gorm.io)作为数据库访问框架，而gorm本身是[支持SQL Server](https://github.com/go-gorm/sqlserver)的。\n\n我想，既然库都支持了，SQL Server支持有什么难的？引入`gorm.io/sqlserver`包，引入创建一个`Dialector`，用gorm的API编写的绝大多数数据库操作就完成了。\n\n```go\nsqlserver.Open(mssqlConnectionString(c))\n```\n\n这有什么难的，开跑！结果遇到了一大堆报错。\n\n# 遇到并解决一个一个一个的问题\n\n## SQL语句\n\n仔细一看，这些报错主要是来自于数据库migration中的原生SQL语句和片段。\n\n程序启动的时候，会运行数据库migration脚本。随着软件开发更多的新功能，其使用的数据库的结构总会发生变化，而migration是指一些代码，这些代码的作用是修改数据库schema、让schema满足当前版本的要求。当软件功能越来越多，对数据库的变化也就越来越多，所以在一个成熟的软件中，你常常会看到有很多的数据库migration的代码。在程序启动的时候，这些migration将会被一个一个地执行，使得程序正式开始时，数据库的schema也更新到最新。\n\n```bash\n\u003e tree migrations\nmigrations\n├── 20201103_rename_language_mappings_table.go\n├── 20201106_migration_cascade_constraints.go\n├── 20210202_fix_cascade_for_alias_user_constraint.go\n├── 20210206_drop_badges_column_add_sharing_flags.go\n├── 20210213_add_has_data_field.go\n├── 20210221_add_created_date_column.go\n├── 20210411_add_imprint_content.go\n├── 20210411_drop_migrations_table.go\n├── 20210806_remove_persisted_project_labels.go\n\n```\n\n而有的migration（尤其是自动生成的migration）很可能包含了一些原生SQL。同时，由于ORM是对数据库操作的抽象，而再强大的抽象也不如原生的SQL来得强大和方便，所以很多时候，开发者仍然会选择在一些地方使用原生SQL语句的片段或者语句来实现一些功能。虽然SQL本身是有标准的，但是各个数据库厂商实际上自己实现了很多新功能，很多时候我们本以为理所当然的功能，实际上并不在标准中，而是数据库厂商自己实现的，一旦手写SQL而没有意识到有的SQL实际上只在部分数据库中兼容，就可能会在不兼容的数据库中遇到问题。\n\n举个例子，wakapi的某个版本需要在数据库的`users`表中新增一个`has_data`列，而对于已经存在的`users`表中的数据，这个列需要被设置为`TRUE`。代码中用于执行此次migration的代码使用如下SQL语句实现了这个功能：\n\n```sql\nUPDATE users SET has_data = TRUE WHERE TRUE;\n```\n\n看上去是个很简单的人畜无害的SQL语句，对吧？但是这个SQL语句在mssql中中是非法的，因为mssql中并没有`TRUE`, `FALSE`常量！sqlserver中没有`boolean`类型，所有这些类型都是使用一个字节的`tinyint`来表示的，而`TRUE`和`FALSE`就对应使用`1`和`0`来表示。但是，`1`和`0`在sql server中并不是一个合法的`boolean`表达式，所以它们并不能直接用在`WHERE`中。所以，在MSSQL中，以上SQL语句就必须重新成以下的样子：\n\n```sql\nUPDATE users SET has_data = 1;\n```\n\n## SQL语句片段\n\n另一个情况是**SQL语句片段**。虽然ORM的一大作用就是将软件代码映射为SQL语句，减少我们手写SQL可能带来的错误，但是为了实现的灵活性，ORM常常同样也允许在自己的API中编写一些SQL的片段，而ORM会尝试将这些SQL片段嵌入进去。但是这些SQL片段可能也会有不兼容的情况！例如，下面的代码\n\n```go\nresult := db.Table(\"summaries AS s1\").\n\t\t\tWhere(\"s1.id IN ?\", faultyIds).\n\t\t\tUpdate(\"num_heartbeats\", \"3\")\n```\n\n上述gorm数据库仓库将会被映射为类型以下的SQL语句。注意`Table`和`Where`方法的参数与下列SQL语句中对应的语句的对应关系。\n\n```sql\nupdate summaries AS s1 set num_heartbeats = 3 where s1.id IN ?\n```\n\n是不是感觉很简单？但是MSSQL仍然不支持！MSSQL不支持在`update`持语句中给表新增一个别名，所以以上SQL语句中的`AS s1`必须被去掉。\n\n## 重用Dialector的逻辑，为关键词加上引号\n\n再看一个SQL语句片段：\n\n```go\nr.db.Model(\u0026models.User{}).Select(\"users.id as user, max(time) as time\").\n```\n\n这段SQL语句一般会被映射为：\n\n```sql\nselect users.id as user, max(time) as time from users;\n```\n\n有问题吗？有！`user`在MSSQL中是关键词，要作为标识符使用必须使用`\"\"`或者`[]`将它包裹起来！而`user`在mysql等数据库引擎中都不是关键词，因此可以随意直接使用。\n\n这个将关键词作为字符串使用的过程实际上编程中很常见，被称为`escape`，或者更简单的叫`quote`，加引号。但是更坑的是，不同的SQL引擎所使用的加引号的方法不一样。MSSQL使用的是`\"\"`或者`[]`，但是mysql使用的是`。如何通过一段代码来为不同的数据库加上正确的引号呢？\n\n其实，这个加引号的过程实在是非常常见，只要ORM需要将程序员所写的名字（表名、列名等）映射到SQL，那么就需要考虑给这些名字叫上引号，防止这些名字和SQL自己的关键词冲突。如果你写一个名字叫`select`的表，没有这段逻辑，那么这个表就没法通过ORM来映射成SQL了！\n\n因此，根据Don't Repeat Yourself原则，ORM为数据库系统的适配器中肯定会有对应的逻辑。而我们与其自己编写这个处理逻辑，最好的方法当然是调用适配器中已经写好的逻辑了。\n\ngorm使用`Dialector`接口作为ORM支持不同数据库系统的适配器的接口，所有gorm支持的数据库都有一个对应的实现了`Dialector`接口的`Dialector`。所以，第一步就是去看看gorm的`Dialector`里定义了哪些接口。\n\n```go {9}\n// https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/interfaces.go#L12C1-L21C2\ntype Dialector interface {\n\tName() string\n\tInitialize(*DB) error\n\tMigrator(db *DB) Migrator\n\tDataTypeOf(*schema.Field) string\n\tDefaultValueOf(*schema.Field) clause.Expression\n\tBindVarTo(writer clause.Writer, stmt *Statement, v interface{})\n\tQuoteTo(clause.Writer, string)\n\tExplain(sql string, vars ...interface{}) string\n}\n```\n\n从名字判断，这个`QuoteTo`方法似乎就是我们要的接口。再随便点开一个dialector实现的代码浏览一下，就能确定，`QuoteTo`就是加引号的方法。\n\n可是这个方法看上去和我们想象中的不太一样：我们预期这个功能是一个`(string) =\u003e string`的函数，这里怎么是一个`(clause.Writer, string) =\u003e void`的函数，这个`clause.Writer`是什么玩意？\n\n由于拼接SQL说到底，就是要生成各个SQL的片段，然后将这些片段的字符串拼接起来。在绝大多数编程语言里，`string`都是不可变的，所以拼接字符串实际上是创建了第三个字符串，然后把两个字符串的内容复制进去。这个过程如果进行太多次，就非常浪费时间和内存。所以编程语言常常会提供一个**组装字符串的工具类**。这个工具类可以理解成是一个**可变**的字符串，你可以直接在这个_字符串_的后面增加新的字符串，而不需要每次操作都创建一个全新的字符串对象。而这个`Writer`接口，就是gorm定义的一个这样的能够**组装字符串的工具类**所需要实现的接口。这个`Writer`接口定义如下：\n\n```go\n// https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/clause/clause.go#L13\ntype Writer interface {\n\tWriteByte(byte) error\n\tWriteString(string) (int, error)\n}\n```\n\n很简单，很直白：`WriteByte`：在后面增加一个字符；`WriteString`，在后面增加一个字符串。\n\n熟悉Go的同学可能会说了：啊，这个接口看上去非常熟悉，原生的`strings.Builder`就是用来做这个事情的，而且也有这两个方法！是不是可以直接用一个`strings.Builder`来作为这个`clause.Writer`？\n\n正确！所以我们可以直接创建一个`*strings.Builder`来作为`clause.Writer`（用指针的原因是这个`strings.Builder`的这两个成员方法是使用的指针接收者而不是值接收者，所以只有对应的指针类型才算实现了这个接口。具体关于指针接收者和值接收者的区别我们就不在这里介绍了，有兴趣的可以学习一下Go语言），并在调用后获取这个`builder`最终的字符串，这样就直接调用了`dialector`中实现了加引号逻辑。\n\n```go\nfunc QuoteDbIdentifier(db *gorm.DB, identifier string) string {\n\tbuilder := \u0026strings.Builder{}\n\tdb.Dialector.QuoteTo(builder, identifier)\n\treturn builder.String()\n}\n```\n\n然后，我们将此函数用在所有需要在SQL片段中使用自定义的名字的地方，这样，我们就重用了dialector的逻辑，用同一套代码兼容了所有的数据库。\n\n```go {2}\nr.db.Model(\u0026models.User{}).Select(\n  fmt.Sprintf(\"users.id as %s, max(time) as time\"), utils.QuoteDbIndentifier(r.db, \"user\")\n)\n```\n\n## 重写不支持的功能\n\n而在进一步查找并修改原生SQL的语句中，我找到了一段如下的原生SQL语句，直接让我眼前一黑。\n\n```sql\nwith projects as (\n\t\t\tselect project, user_id, min(time) as first, max(time) as last, count(*) as cnt\n\t\t\tfrom heartbeats\n\t\t\twhere user_id = ? and project != ''\n\t\t\tand time between ? and ?\n\t\t\tand language is not null and language != '' and project != ''\n\t\t\tgroup by project, user_id\n\t\t\torder by last desc\n\t\t\tlimit ? offset ? )\nselect distinct project, min(first) as first, min(last) as last, min(cnt) as count, first_value(language) over (partition by project order by count(*) desc) as top_language\n\t\t\tfrom heartbeats\n\t\t\tinner join projects using (project, user_id)\n\t\t\tgroup by project, language\n\t\t\torder by last desc\n```\n\n这段SQL语句就这样赤裸裸地写在代码里。经过以上几个例子，是不是以为这个SQL在MSSQL中必定问题巨大，不重新写一份根本跑不起来？\n\n我一开始也是这么想的。而我自己对SQL Server并没有那么熟悉，所以聪明的我，在给一些名字叫上引号后，直接把这段代码扔给了GitHub Copilot，让它帮我改成SQL Server能用的。反直觉的是，这段代码实际上问题没那么大：\n\n![copilot的结果](./copilot.png)\n\n具体来说，除了第三点去掉了不需要的引号后，有两个问题：\n\n1. 不支持`join using`，需要使用常规的`join on`代替\n2. 不支持`limit offset`。查找了一下，mssql可以使用`offset ? ROWS fetch next ? rows only`来代替，当然`limit`和`offset`的参数顺序是反过来的\n\n啊，原来这么简单！由于需要修改的地方并不多，于是我就简单的通过if判断，将其中SQL Server不兼容的部分修改为SQL Server兼容的SQL语句，这段SQL语句也就完成了。\n\n## 把同一个go类型在不同的数据库中映射为不同的列类型\n\n修改了这些SQL语句后，程序仍然运行不起来，仔细一看，报错如下：\n\n```\nmssql: A table can only have one timestamp. Because table 'users' already has one, the column 'last_logged_in_at' cannot be added.\n```\n\n简单翻译，一个表只能有一个类型为`timestamp`的列，而`users`中有多个列都是`timestamp`的类型，所以SQL Server报错了。\n\n去代码中一看，`users`表对应的`User`struct确实有好几个字段都通过[gorm的field tag功能](https://gorm.io/docs/models.html#Fields-Tags)`type:timestamp`，确定了在数据库中这些列需要映射为`timestamp`类型。\n\n```go /timestamp/\n// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/user.go#L17\ntype User struct {\n  // ...\n  CreatedAt           CustomTime  `gorm:\"type:timestamp; default:CURRENT_TIMESTAMP\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`\n\tLastLoggedInAt      CustomTime  `gorm:\"type:timestamp; default:CURRENT_TIMESTAMP\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`\n  // ...\n  SubscribedUntil     *CustomTime `json:\"-\" gorm:\"type:timestamp\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`\n\tSubscriptionRenewal *CustomTime `json:\"-\" gorm:\"type:timestamp\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`\n}\n```\n\n`timestamp`有什么问题呢？MySQL不都是使用`timestamp`来代表时间类型吗？去查找`sql server timestamp`，我才发现，SQL Server里的`timestamp`的含义和别的数据库中的含义不一样。在别的数据库中，`timestamp`就是一个表示时间戳/时间点的类型，而根据[这个stackoverflow回答](https://stackoverflow.com/a/12063938)，`sql server`中的`timestamp`主要用于乐观锁的情况（具体不在这里阐述），只是用来标记本行上一次被修改的时间，所以每个表只能存在一个`timestamp`的列。而在SQL Server中如果要表示一个时间戳，需要使用`datetimeoffset`。\n\n所以现在问题就变成了：**如何将一个类型在不同的数据库中映射为不同的列的类型**。\n\n`type:timestamp`这个tag肯定是不能用了，于是我们就需要查找有没有其他更动态的方法，可以自定义一个go字段映射到数据库中的类型。经过一番查找，我们找到了[Customize Data Type](https://gorm.io/docs/data_types.html#GormDataTypeInterface)功能。gorm允许定义一个自定义的`struct`，并给这个`struct`实现`GormDBDataTypeInterface`接口，来返回这个类型的字段所真正对应的数据库类型。\n\n```go\ntype GormDBDataTypeInterface interface {\n  GormDBDataType(*gorm.DB, *schema.Field) string\n}\n```\n这个函数的第一个参数就是`gorm.DB`对象，指向当前操作的数据库对象，可以获取到当前正在使用什么类型的`Dialector`，我们就可以根据`Dialector`类型，来输出对应的数据库列类型。另外，这个`CustomTime`正好是代码中所定义的一个新的`struct`，我们可以直接在`CustomTime`上实现这个接口。\n\n看来比较简单，但是为了以防万一，我们再全局搜索一下`type:timestamp`，看看有没有什么其他的用法。果然被我找到了！\n\n```go /timestamp(3)/\n// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/heartbeat.go#L27\ntype Heartbeat struct {\n  // ...\n  Time            CustomTime `json:\"time\" gorm:\"type:timestamp(3); index:idx_time; index:idx_time_user\" swaggertype:\"primitive,number\"`\n  // ...\n}\n```\n\n这里用到了`timestamp(3)`。根据[mysql的文档](https://dev.mysql.com/doc/refman/8.0/en/fractional-seconds.html)，`timestamp(n)`中的`n`是代表精确到秒后面的第几位浮点位，`3`代表精确到毫秒，而`6`代表精确到微秒。而SQL Server的`datetimeoffset`也支持类似的标记（[文档](https://learn.microsoft.com/en-us/sql/t-sql/data-types/datetimeoffset-transact-sql?view=sql-server-ver16)），`datetimeoffset(n)`中的`n`也同样表示精确到秒后面的第几位浮点位。由于我们不能直接使用`type`tag，但是我们还需要一个tag用来表示这个精确的位数（根据sql server的文档，将这个位数称为`scale`），所以，我们可以定义一个全新的`timeScale`的tag，其值就是`scale`的值。而一个字段上具体有哪些tag，正好可以通过`GormDBDataType`的第二个参数获取。\n\n于是根据这个思路，我们实现了`CustomTime`的`GormDBDataType`方法：\n\n```go\n// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/shared.go#L44\nfunc (j CustomTime) GormDBDataType(db *gorm.DB, field *schema.Field) string {\n\n\tt := \"timestamp\"\n\n  // 如果使用的是SQL Server Dialector，则将其类型设置为datetimeoffset\n\tif db.Config.Dialector.Name() == (sqlserver.Dialector{}).Name() {\n\t\tt = \"datetimeoffset\"\n\t}\n\n  // 如果一个属性有TIMESCALE的tag，那么给类型后面增加(n)参数\n  // gorm将所有gorm下的tag的key转换成了全大写\n  // 参考：https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/schema/utils.go#L35\n\tif scale, ok := field.TagSettings[\"TIMESCALE\"]; ok {\n\t\tt += fmt.Sprintf(\"(%s)\", scale)\n\t}\n\n\treturn t\n}\n```\n\n同时，我们将所有的`timestamp`都直接去掉，将`type:timestamp(n)`修改为了`timeScale:n`：\n\n```go /timeScale:3/\n// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/user.go#L17\ntype User struct {\n  // ...\n  CreatedAt           CustomTime  `gorm:\"default:CURRENT_TIMESTAMP\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`\n  LastLoggedInAt      CustomTime  `gorm:\"default:CURRENT_TIMESTAMP\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`\n  // ...\n  SubscribedUntil     *CustomTime `json:\"-\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`\n  SubscriptionRenewal *CustomTime `json:\"-\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`\n}\n\n// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/heartbeat.go#L12\ntype Heartbeat struct {\n  // ...\n  Time            CustomTime `json:\"time\" gorm:\"timeScale:3; index:idx_time; index:idx_time_user\" swaggertype:\"primitive,number\"`\n  // ...\n}\n```\n\n这样就解决了这个问题。\n\n## 避免创建递归的级联修改外键约束\n\n没想到的是，到这里仍然无法启动程序。报错如下：\n\n``` {3}\n[2.938ms] [rows:0] CREATE TABLE \"summary_items\" (\"id\" bigint IDENTITY(1,1),\"summary_id\" bigint,\"type\" smallint,\"key\" nvarchar(255),\"total\" bigint,PRIMARY KEY (\"id\"),CONSTRAINT \"fk_summaries_editors\" FOREIGN KEY (\"summary_id\") REFERENCES \"summaries\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \"fk_summaries_operating_systems\" FOREIGN KEY (\"summary_id\") REFERENCES \"summaries\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \"fk_summaries_machines\" FOREIGN KEY (\"summary_id\") REFERENCES \"summaries\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \"fk_summaries_projects\" FOREIGN KEY (\"summary_id\") REFERENCES \"summaries\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \"fk_summaries_languages\" FOREIGN KEY (\"summary_id\") REFERENCES \"summaries\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE)\n2024-01-19T19:29:35.607826413+08:00 [ERROR] mssql: Could not create constraint or index. See previous errors.\npanic: mssql: Could not create constraint or index. See previous errors.\n```\n\n`Could not create constraint or index. See previous errors.`这个等于什么都没说嘛，只知道创建一个外键约束或者索引的时候失败了，而其他的错误信息被gorm或者gorm的sqlserver dialector忽略了。还\n\n还好我能看到具体执行的SQL语句，所以我们可以把这段SQL语句手动输入到Azure Data Studio中，看看数据库引擎到底报了什么错误。\n\n![通过Azure Data Studio查看具体的错误信息](./foreign-keys.png)\n\n\u003e Introducing FOREIGN KEY constraint 'fk_summaries_operating_systems' on table 'summary_items' may cause cycles or multiple cascade paths. Specify ON DELETE NO ACTION or ON UPDATE NO ACTION, or modify other FOREIGN KEY constraints.\n\n看起来，是因为`fk_summaries_operating_systems`这个级联的外键索引会造成级联递归（cycles）。和外键约束有关，而外键约束是通过gorm定义，所以我们先去看看代码里涉及这个外键约束的两个表的定义。\n\n```go /constraint:OnUpdate:CASCADE,OnDelete:CASCADE/\n// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/summary.go#L29\ntype Summary struct {\n  // ...\n\tProjects         SummaryItems `json:\"projects\" gorm:\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"`\n\tLanguages        SummaryItems `json:\"languages\" gorm:\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"`\n\tEditors          SummaryItems `json:\"editors\" gorm:\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"`\n\tOperatingSystems SummaryItems `json:\"operating_systems\" gorm:\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"`\n\tMachines         SummaryItems `json:\"machines\" gorm:\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"`\n}\n\ntype SummaryItems []*SummaryItem\n\ntype SummaryItem struct {\n  // ...\n\tSummary   *Summary      `json:\"-\" gorm:\"not null; constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"`\n\tSummaryID uint          `json:\"-\" gorm:\"size:32\"`\n}\n```\n\n也就是说，`Summary`和`SummaryItem`两个表是1:m的关系，这个关系映射到数据库中，也就是`SummaryItem`表中有到`Summary`的ID的外键`summary_id`，而这个外键的约束则是通过`Summary`表中的tag定义的。\n\n转回头去看生成的SQL，生成的SQL里有**5**个完全相同的外键（`fk_summaries_editors`, `fk_summaries_operating_systems`，`fk_summaries_machines`，`fk_summaries_projects`和`fk_summaries_languages`）。由于这五个外键都是级联删除（`ON DELETE CASCADE`）和级联更新（`ON UPDATE CASCADE`），实际上确实是会存在一个级联递归：当一个`SummaryItem`被删除，会造成其对应的`Summary`被删除，而`Summary`被删除可能会造成这个`SummaryItem`也被删除。\n\n那问题又来了，那为什么之前在MySQL、PostgresSQL等数据库里均正常呢？通过[这篇Stack Overflow](https://stackoverflow.com/a/852047)的回答，我们知道了这种问题在其他数据库中并不是问题：其他数据库会尝试解出一条级联路径出来。而SQL Server不会去尝试解，发现了这种循环，就会直接报错。\n\n那如何解决这个问题呢？根据外键名和`Summary`中的属性的对应关系，我们可以推测，这五个外键是`Summary`中五个引用一一对应过来的。由于这五个外键实际上是一模一样的，只需要保留一个就可以了。所以，最终的解决方案是，只保留一个字段的外键tag，其他字段全部给一个`-`的tag，让gorm不要为这些字段生成外键。\n\n```go {5-8}\n// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/summary.go#L30\ntype Summary struct {\n\tProjects SummaryItems `json:\"projects\" gorm:\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"`\n\n\tLanguages        SummaryItems `json:\"languages\" gorm:\"-\"`\n\tEditors          SummaryItems `json:\"editors\" gorm:\"-\"`\n\tOperatingSystems SummaryItems `json:\"operating_systems\" gorm:\"-\"`\n\tMachines         SummaryItems `json:\"machines\" gorm:\"-\"`\n}\n```\n\n## 规避gorm sqlserver的bug\n\n至此，系统终于能启动起来了，并且大多数功能已经可以正常使用了。而在代码审核过程中，作者还[发现了一个问题](https://github.com/muety/wakapi/pull/592#issuecomment-1892627154)：代码中有一个`Heartbeat`表，它就是wakatime的客户端插件定期给服务器端发送的数据，其中包含了正在工作的项目、使用的编程语言等信息。而这个表中有一个字段为`Hash`，这个字段的值根据其他信息算出来，并且有一个`unique index`，通过这个字段，就避免给`Heartbeat`表插入多个重复的数据。\n\n```go {4}\n// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/heartbeat.go#L13\ntype Heartbeat struct {\n  // ...\n\tHash            string     `json:\"-\" gorm:\"type:varchar(17); uniqueIndex\"`\n  // ...\n}\n```\n\n在插入的时候，作者使用了`ON CONFLICT DO NOTHING`的语句，这个语句的作用就是，如果当插入一行的时候，发现有些行违反了某个`unique index`的要求，则**忽略**这个问题，不插入这一行，也不报错。这刚好非常适合插入有可能有重复的`Heartbeat`的场景。\n\n```go\n// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/repositories/heartbeat.go#L52\n// 下述代码将会被映射为ON CONFLICT DO NOTHING\nif err := r.db.\n  Clauses(clause.OnConflict{\n    DoNothing: true,\n  }).\n  Create(\u0026heartbeats).Error; err != nil {\n  return err\n}\nreturn nil\n```\n\n这种行为被称为**插入或者更新**，又被称为**Upsert**（Update/Insert），其行为是一个简单的判断：如果一行已经存在，则更新这一行的内容；如果不存在，则插入这一行。而如何判断**一行是否存在**呢？则是通过`unique index`来判断。\n\n可是遗憾的是，SQL Server不支持`ON CONFLICT DO NOTHING`。要想在SQL Server中模拟upsert的行为，[有很多方式](https://michaeljswart.com/2017/07/sql-server-upsert-patterns-and-antipatterns/)，一个比较常见的方法是使用`merge into`语句。具体如何编写比较复杂，这里就不再具体讲解。\n\n由于这里是使用的gorm的API，并不是使用原生SQL语句，所以理论上来说，gorm是可以知道用户的意图，并根据不同的数据库生成行为相同的、但是兼容对应数据库的SQL语句的。根据[这个issue](https://github.com/go-gorm/sqlserver/issues/47)，gorm的SQL Server库确实在很早之前就尝试通过生成一段的SQL Server兼容的SQL语句来支持这个功能，在gorm的文档里也[提到了](https://gorm.io/docs/create.html#Upsert-x2F-On-Conflict)，`clause.OnConflict`会根据不同的数据库生成不同的语句，而对于SQL Server，其对应生成的正好就是`MERGE INTO`语句。\n\n但是，既然库都支持了，那为什么还会遇到这个错误呢？再次检查所实际执行的SQL，发现这一次`Create`实际上生成的SQL语句仍然是最普通的`INSERT INTO`，并没有不是正确的`MERGE INTO`，。\n\n```SQL /INSERT INTO/\n024/01/19 20:10:23 /home/ddadaal/Code/wakapi/repositories/heartbeat.go:54 mssql: Cannot insert duplicate key row in object 'dbo.heartbeats' with unique index 'idx_heartbeats_hash'. The duplicate key value is (d926be93ebcc4b6f).\n\n[10.830ms] [rows:0] INSERT INTO \"heartbeats\" (\"user_id\",\"entity\",\"type\",\"category\",\"project\",\"branch\",\"language\",\"is_write\",\"editor\",\"operating_system\",\"machine\",\"user_agent\",\"time\",\"hash\",\"origin\",\"origin_id\",\"created_at\") OUTPUT INSERTED.\"id\" VALUES ('ddadaal','/home/user1/dev/project1/main.go','file','','wakapi','','Go',1,'','','','curl/8.5.0','2024-01-16 02:16:18.954','d926be93ebcc4b6f','','','2024-01-19 20:10:23.378');\n```\n\n看来，要想弄明白这个问题，就得进到`gorm`的源码里来查看问题出在哪里了。使用VSCode启动一个调试版本的程序，给上面的代码的位置打上断电，使用`curl`连续插入两次同样的`Heartbeat`，根据断点往内查找，当进入到gorm的sqlserver的适配器的时候的代码的时候，我们发现了一些端倪：\n\n![查找到可能出现bug的位置](./sqlserver-adapter.png)\n\n当前，我们正在图中的`if hasConflict`的位置，且`hasConflict`当前为true。根据下面的一段代码，如果`hasConflict`为`true`的话，将会进入`MergeCreate`函数，而这个函数即是一个在MySQL实现类似行为的SQL的语句的代码。但是，实际在橙色块结束后，`hasConflict`**被改成了`false`**，所以最终并没有进入`MergeCreate`，最终的结果就是一个普通的`INSERT INTO` SQL。那么也就是说，橙色这段代码就是罪魁祸首！\n\n这段代码干了什么事情呢？简单来说，它会检查要插入的行中的各个列中有没有包含主键。如果没有设置主键，则将会把`hasConflict`改为`false`；而如何设置了主键，才会进入`MERGE INTO`流程。回想前面，要想正确生成upsert行为，我们需要判断**一行是否存在**。而很显然，这里的代码将**一行是否存在**的判断标准等价为了主键是否存在，而忽略了其他具有的`unique index`的列。\n\n当然，其他人也发现了这个问题，gorm-sqlserver的仓库中也有[已经半年前打开的issue](https://github.com/go-gorm/sqlserver/issues/100)正好就是关于这个问题。而很遗憾，这个问题过了半年依然没有修复。\n\n要想解决这个问题，有多种方法，而我最终选择了最简单粗暴的方法：不管！这个函数的目的是同时插入多个`Heartbeatt`，那我们就手动一个一个插入，如果一个行插入失败了，我们简单判断一下，如果这个错误是因为hash重复造成了，那我们就不管了！检查了一下代码中调用这个方法的场景，其实大多数情况下都是只插入一行，所以这样写对性能造成的影响是可以接受的。\n\n```go\n// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/repositories/heartbeat.go#L34\nif r.db.Dialector.Name() == (sqlserver.Dialector{}).Name() {\n  for _, h := range heartbeats {\n    err := r.db.Create(h).Error\n    if err != nil {\n      if strings.Contains(err.Error(), \"Cannot insert duplicate key row in object 'dbo.heartbeats' with unique index 'idx_heartbeats_hash'\") {\n        // ignored\n      } else {\n        return err\n      }\n    }\n  }\n  return nil\n}\n```\n\n# 总算还是完成了\n\n终于，经过了一周的时间，本来以为只是一个简单的调库，结果却发现了这么多的问题。经过这个过程，之前连SQL Server用都没用过的我也知道了很多SQL Server的细节；之前没有接触过gorm，现在却连源代码都好好翻了一通。\n\n而关于go，虽然我一直不喜欢go的语法，觉得它太简单，类型系统太弱，很多代码都花在固定的模板代码上（比如`if err := nil`），但是不得不承认的一点是，go确实非常的**explicit**。没那么多乱七八糟的反射、运行时黑魔法，控制流非常清晰，想知道什么代码调用了一个方法，直接`Shift+F12`就完事了，出来的结果不会多不会少；要想某个错误是在哪里处理的，跟着繁琐的错误处理代码总能找到。它确实缺少一些特性，但是它非常地工业化。\n\n解决这些问题后，PR顺利合并进了主分支，成就感满满，这可能也是我第一个没那么简单的开源项目的贡献了。\n\n![https://github.com/muety/wakapi/pull/592](./pr-merged.png)\n\n对我来说，设定一个目标是学习的最好的途径，在这次实践里再次得到了印证。\n"])</script><script>self.__next_f.push([1,"5:[\"$\",\"article\",null,{\"children\":[[\"$\",\"div\",null,{\"className\":\"bg-neutral px-4 py-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"max-w-7xl mx-auto min-h-[256px] flex justify-center text-center text-neutral-content\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex flex-col justify-center animate-slide-up\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-4xl my-2\",\"children\":\"从调库到翻源代码：给wakapi增加SQL Server支持\"}],[\"$\",\"$L17\",null,{\"className\":\"justify-center\",\"articleId\":\"support-sqlserver-in-wakapi\",\"info\":{\"content\":\"$18\",\"title\":\"从调库到翻源代码：给wakapi增加SQL Server支持\",\"date\":\"2024-01-17 22:58\",\"id\":\"support-sqlserver-in-wakapi\",\"lang\":\"cn\",\"tags\":[\"project\",\"problem-investigation\"],\"related\":\"$undefined\",\"ignored_in_list\":\"$undefined\",\"hide_heading\":\"$undefined\",\"no_toc\":\"$undefined\",\"absolute_path\":\"$undefined\",\"last_updated\":\"$undefined\",\"wordCount\":6636,\"readingTime\":33.18,\"filePath\":\"contents/20240117-support-sqlserver-in-wakapi/cn.md\",\"summary\":{\"articleId\":\"support-sqlserver-in-wakapi\",\"lang\":\"cn\",\"hash\":\"2894ee61840e2353f94fdd29fb81283beca5354b54bd7435b9453fdffcf7c88e\",\"summaries\":[{\"metadata\":{\"summarizer\":\"azure-ai\",\"model\":\"DeepSeek-R1\"},\"summaries\":[\"作者在尝试将Wakapi项目迁移至SQL Server时，遇到一系列数据库适配问题。包括SQL语法差异、ORM框架配置、外键约束冲突及GORM库的Upsert功能缺陷。通过修改原生SQL语句、动态调整时间字段类型映射、重构外键关系、手动处理唯一索引冲突，最终解决兼容性问题并成功合并代码。此次实践深入了解了SQL Server特性与GORM内部机制，验证了通过实际项目攻坚学习技术的有效性。\"],\"startTime\":\"2025-02-14T13:43:38.671Z\",\"endTime\":\"2025-02-14T13:44:02.939Z\"},{\"metadata\":{\"summarizer\":\"ollama\",\"model\":\"deepseek-r1:8b\"},\"summaries\":[\"在解决这个问题时，我逐步发现了许多关于 SQL Server 和 GORM 的细节，并通过手动处理重复插入的问题，最终完成了任务。尽管遇到了一些挑战，但过程让我对 Go 语言和开源项目贡献有了更深的理解。\\n\\n**主要步骤：**\\n\\n1. **问题识别**：在尝试使用 GORM 插入数据时，遇到了重复主键错误。\\n2. **调试与分析**：通过调试工具追踪到 GORM 的 SQL Server 适配器，发现了可能的 bug。\\n3. **手动处理**：在没有修复适配器的情况下，选择手动逐个插入数据，跳过重复的记录。\\n4. **学习与反思**：深入了解了 Go 语言的明确性和错误处理机制，同时也认识到 SQL Server 的特性。\\n\\n通过这次经历，我不仅解决了问题，还提升了对开发工具和开源项目贡献的理解。最终，我的Pull Request得到了合并，这让我感到成就感和满足。\\n\\n**结果：**\\n\\n- **问题解决**：成功将数据插入 SQL Server，无重复记录错误。\\n- **技能提升**：加深了对 Go 语言和 GORM 的理解，掌握了调试技巧。\\n- **贡献体验**：第一次在大型开源项目中参与问题解决，增强了解决问题的信心。\\n\\n这次经历让我更加明确地认识到学习的重要性，不管是技术上的还是工具使用方面，都需要持续探索和实践。\"]}]}},\"langVersions\":[\"cn\"]}]]}]}]}],[\"$\",\"div\",null,{\"className\":\"animate-slide-up\",\"children\":[[\"$\",\"div\",null,{\"className\":\"max-w-7xl mx-auto p-4\",\"children\":\"$L19\"}],[\"$\",\"div\",null,{\"className\":\"max-w-7xl mx-auto p-4\",\"children\":[\"$\",\"$L1a\",null,{\"relatedArticles\":[]}]}],[\"$\",\"div\",null,{\"className\":\"max-w-7xl mx-auto p-4\",\"children\":[\"$\",\"$L1b\",null,{\"articleId\":\"support-sqlserver-in-wakapi\",\"articleTitle\":\"从调库到翻源代码：给wakapi增加SQL Server支持\"}]}]]}]]}]\n"])</script><script>self.__next_f.push([1,"1c:I[6535,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"413\",\"static/chunks/7a1bdfe6-8f7609c25899d936.js\",\"994\",\"static/chunks/c4aeae87-2a85323a0275cbf9.js\",\"786\",\"static/chunks/1b3e99d6-50521588821d44ca.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"826\",\"static/chunks/826-c44bffd752ec02cd.js\",\"467\",\"static/chunks/467-ff6f7f0e9f0462a7.js\",\"971\",\"static/chunks/app/articles/%5B%5B...params%5D%5D/page-59c8401fd7fff2e0.js\"],\"ArticleSummarization\"]\n1d:I[7868,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"413\",\"static/chunks/7a1bdfe6-8f7609c25899d936.js\",\"994\",\"static/chunks/c4aeae87-2a85323a0275cbf9.js\",\"786\",\"static/chunks/1b3e99d6-50521588821d44ca.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"826\",\"static/chunks/826-c44bffd752ec02cd.js\",\"467\",\"static/chunks/467-ff6f7f0e9f0462a7.js\",\"971\",\"static/chunks/app/articles/%5B%5B...params%5D%5D/page-59c8401fd7fff2e0.js\"],\"Gallery\"]\n2c:I[2422,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"413\",\"static/chunks/7a1bdfe6-8f7609c25899d936.js\",\"994\",\"static/chunks/c4aeae87-2a85323a0275cbf9.js\",\"786\",\"static/chunks/1b3e99d6-50521588821d44ca.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"826\",\"static/chunks/826-c44bffd752ec02cd.js\",\"467\",\"static/chunks/467-ff6f7f0e9f0462a7.js\",\"971\",\"static/chunks/app/articles/%5B%5B...params%5D%5D/page-59c8401fd7fff2e0.js\"],\"ArticleToc\"]\n1e:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521"])</script><script>self.__next_f.push([1,"-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z1f:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z20:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-"])</script><script>self.__next_f.push([1,"59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z21:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.0"])</script><script>self.__next_f.push([1,"37 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z22:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z23:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.8"])</script><script>self.__next_f.push([1,"3-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z25:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-"])</script><script>self.__next_f.push([1,"59.259 59.271-155.699.001-214.959z26:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z28:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.45"])</script><script>self.__next_f.push([1,"4 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z2a:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"])</script><script>self.__next_f.push([1,"19:[\"$\",\"div\",null,{\"className\":\"flex flex-row space-x-4\",\"children\":[[\"$\",\"div\",null,{\"className\":\"prose max-w-full lg:w-[75%]\",\"children\":[[\"$\",\"$L1c\",null,{\"summaries\":[{\"metadata\":\"$5:props:children:0:props:children:props:children:props:children:1:props:info:summary:summaries:0:metadata\",\"children\":[[\"$\",\"p\",\"p-0\",{\"children\":\"作者在尝试将Wakapi项目迁移至SQL Server时，遇到一系列数据库适配问题。包括SQL语法差异、ORM框架配置、外键约束冲突及GORM库的Upsert功能缺陷。通过修改原生SQL语句、动态调整时间字段类型映射、重构外键关系、手动处理唯一索引冲突，最终解决兼容性问题并成功合并代码。此次实践深入了解了SQL Server特性与GORM内部机制，验证了通过实际项目攻坚学习技术的有效性。\"}]]},{\"metadata\":\"$5:props:children:0:props:children:props:children:props:children:1:props:info:summary:summaries:1:metadata\",\"children\":[[\"$\",\"p\",\"p-0\",{\"children\":\"在解决这个问题时，我逐步发现了许多关于 SQL Server 和 GORM 的细节，并通过手动处理重复插入的问题，最终完成了任务。尽管遇到了一些挑战，但过程让我对 Go 语言和开源项目贡献有了更深的理解。\"}],\"\\n\",[\"$\",\"p\",\"p-1\",{\"children\":[\"$\",\"strong\",\"strong-0\",{\"children\":\"主要步骤：\"}]}],\"\\n\",[\"$\",\"ol\",\"ol-0\",{\"children\":[\"\\n\",[\"$\",\"li\",\"li-0\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"问题识别\"}],\"：在尝试使用 GORM 插入数据时，遇到了重复主键错误。\"]}],\"\\n\",[\"$\",\"li\",\"li-1\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"调试与分析\"}],\"：通过调试工具追踪到 GORM 的 SQL Server 适配器，发现了可能的 bug。\"]}],\"\\n\",[\"$\",\"li\",\"li-2\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"手动处理\"}],\"：在没有修复适配器的情况下，选择手动逐个插入数据，跳过重复的记录。\"]}],\"\\n\",[\"$\",\"li\",\"li-3\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"学习与反思\"}],\"：深入了解了 Go 语言的明确性和错误处理机制，同时也认识到 SQL Server 的特性。\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-2\",{\"children\":\"通过这次经历，我不仅解决了问题，还提升了对开发工具和开源项目贡献的理解。最终，我的Pull Request得到了合并，这让我感到成就感和满足。\"}],\"\\n\",[\"$\",\"p\",\"p-3\",{\"children\":[\"$\",\"strong\",\"strong-0\",{\"children\":\"结果：\"}]}],\"\\n\",[\"$\",\"ul\",\"ul-0\",{\"children\":[\"\\n\",[\"$\",\"li\",\"li-0\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"问题解决\"}],\"：成功将数据插入 SQL Server，无重复记录错误。\"]}],\"\\n\",[\"$\",\"li\",\"li-1\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"技能提升\"}],\"：加深了对 Go 语言和 GORM 的理解，掌握了调试技巧。\"]}],\"\\n\",[\"$\",\"li\",\"li-2\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"贡献体验\"}],\"：第一次在大型开源项目中参与问题解决，增强了解决问题的信心。\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-4\",{\"children\":\"这次经历让我更加明确地认识到学习的重要性，不管是技术上的还是工具使用方面，都需要持续探索和实践。\"}]]}]}],[\"$\",\"$L1d\",null,{\"withCaption\":true,\"id\":\"support-sqlserver-in-wakapi\",\"children\":[[\"$\",\"h1\",\"h1-0\",{\"id\":\"不就是调库嘛\",\"children\":[[\"$\",\"a\",\"不就是调库嘛\",{\"href\":\"#不就是调库嘛\",\"className\":\"mr-1\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"inline-block opacity-20 hover:opacity-60\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$1e\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":16,\"width\":16,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}],\"不就是调库嘛……\"]}],\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":[\"在\",[\"$\",\"a\",\"a-0\",{\"href\":\"/articles/added-blog-page-click-monitoring\",\"children\":\"上一篇文章\"}],\"中，我给博客增加了点击量监测，并将这个服务部署到了Azure，数据库采用了使用SQL Server的Azure的SQL服务。由于SQL Server有免费的订阅，微软的Azure Data Studio也还算好用，于是我觉得可以重用一下刚才学习的这个技能，将其他的服务也使用SQL Server部署。\"]}],\"\\n\",[\"$\",\"p\",\"p-1\",{\"children\":[\"我之前在用\",[\"$\",\"a\",\"a-0\",{\"href\":\"https://wakatime.com/\",\"children\":\"wakatime\"}],\"来记录我的编程的数据（例如每天的编程时间、所使用的编程语言等），但是wakatime免费用户只能保存14天的数据，而且wakatime没有提供官方的可自己部署的后端，所以我也一直在寻找wakatime的替代品。之前尝试使用了一段时间的\",[\"$\",\"a\",\"a-1\",{\"href\":\"https://codetime.dev/\",\"children\":\"codetime\"}],\"。这个软件的功能和wakatime类似，但是它当前只支持VSCode客户端，虽然免费保存数据，但是仍然没有提供可自己部署的后端。我在很早之前也尝试找过wakatime的后端替代品，但是当时并没有找到一个能用的。但前不久，同学给我推荐了\",[\"$\",\"a\",\"a-2\",{\"href\":\"https://www.wakapi.com/\",\"children\":\"wakapi\"}],\"项目，这个项目重新实现了wakatime的后端API，这样wakatime的丰富的客户端插件可以直接使用，并且完全可以自己部署，不用担心数据并存放在别人的服务器上。\"]}],\"\\n\",[\"$\",\"p\",\"p-2\",{\"children\":\"它就是我一直寻找的wakatime替代品！\"}],\"\\n\",[\"$\",\"p\",\"p-3\",{\"children\":[\"很激动地浏览了一下项目，看到wakapi当时并没有原生支持SQL Server，但是在README中提到，wakatime使用了\",[\"$\",\"a\",\"a-0\",{\"href\":\"https://gorm.io\",\"children\":\"gorm\"}],\"作为数据库访问框架，而gorm本身是\",[\"$\",\"a\",\"a-1\",{\"href\":\"https://github.com/go-gorm/sqlserver\",\"children\":\"支持SQL Server\"}],\"的。\"]}],\"\\n\",[\"$\",\"p\",\"p-4\",{\"children\":[\"我想，既然库都支持了，SQL Server支持有什么难的？引入\",[\"$\",\"code\",\"code-0\",{\"children\":\"gorm.io/sqlserver\"}],\"包，引入创建一个\",[\"$\",\"code\",\"code-1\",{\"children\":\"Dialector\"}],\"，用gorm的API编写的绝大多数数据库操作就完成了。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-0\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"sqlserver\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Open\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"mssqlConnectionString\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"c\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"))\"}]]}]}]}]}],\"\\n\",[\"$\",\"p\",\"p-5\",{\"children\":\"这有什么难的，开跑！结果遇到了一大堆报错。\"}],\"\\n\",[\"$\",\"h1\",\"h1-1\",{\"id\":\"遇到并解决一个一个一个的问题\",\"children\":[[\"$\",\"a\",\"遇到并解决一个一个一个的问题\",{\"href\":\"#遇到并解决一个一个一个的问题\",\"className\":\"mr-1\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"inline-block opacity-20 hover:opacity-60\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$1f\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":16,\"width\":16,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}],\"遇到并解决一个一个一个的问题\"]}],\"\\n\",[\"$\",\"h2\",\"h2-0\",{\"id\":\"sql语句\",\"children\":[[\"$\",\"a\",\"sql语句\",{\"href\":\"#sql语句\",\"className\":\"mr-1\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"inline-block opacity-20 hover:opacity-60\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$20\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":16,\"width\":16,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}],\"SQL语句\"]}],\"\\n\",[\"$\",\"p\",\"p-6\",{\"children\":\"仔细一看，这些报错主要是来自于数据库migration中的原生SQL语句和片段。\"}],\"\\n\",[\"$\",\"p\",\"p-7\",{\"children\":\"程序启动的时候，会运行数据库migration脚本。随着软件开发更多的新功能，其使用的数据库的结构总会发生变化，而migration是指一些代码，这些代码的作用是修改数据库schema、让schema满足当前版本的要求。当软件功能越来越多，对数据库的变化也就越来越多，所以在一个成熟的软件中，你常常会看到有很多的数据库migration的代码。在程序启动的时候，这些migration将会被一个一个地执行，使得程序正式开始时，数据库的schema也更新到最新。\"}],\"\\n\",[\"$\",\"figure\",\"figure-1\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"bash\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"bash\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"\u003e tree migrations\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"migrations\"}]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"├──\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" 20201103_rename_language_mappings_table.go\"}]]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"├──\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" 20201106_migration_cascade_constraints.go\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"├──\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" 20210202_fix_cascade_for_alias_user_constraint.go\"}]]}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"├──\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" 20210206_drop_badges_column_add_sharing_flags.go\"}]]}],\"\\n\",[\"$\",\"span\",\"span-6\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"├──\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" 20210213_add_has_data_field.go\"}]]}],\"\\n\",[\"$\",\"span\",\"span-7\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"├──\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" 20210221_add_created_date_column.go\"}]]}],\"\\n\",[\"$\",\"span\",\"span-8\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"├──\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" 20210411_add_imprint_content.go\"}]]}],\"\\n\",[\"$\",\"span\",\"span-9\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"├──\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" 20210411_drop_migrations_table.go\"}]]}],\"\\n\",[\"$\",\"span\",\"span-10\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"├──\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" 20210806_remove_persisted_project_labels.go\"}]]}],\"\\n\",[\"$\",\"span\",\"span-11\",{\"data-line\":\"\",\"children\":\" \"}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-8\",{\"children\":\"而有的migration（尤其是自动生成的migration）很可能包含了一些原生SQL。同时，由于ORM是对数据库操作的抽象，而再强大的抽象也不如原生的SQL来得强大和方便，所以很多时候，开发者仍然会选择在一些地方使用原生SQL语句的片段或者语句来实现一些功能。虽然SQL本身是有标准的，但是各个数据库厂商实际上自己实现了很多新功能，很多时候我们本以为理所当然的功能，实际上并不在标准中，而是数据库厂商自己实现的，一旦手写SQL而没有意识到有的SQL实际上只在部分数据库中兼容，就可能会在不兼容的数据库中遇到问题。\"}],\"\\n\",[\"$\",\"p\",\"p-9\",{\"children\":[\"举个例子，wakapi的某个版本需要在数据库的\",[\"$\",\"code\",\"code-0\",{\"children\":\"users\"}],\"表中新增一个\",[\"$\",\"code\",\"code-1\",{\"children\":\"has_data\"}],\"列，而对于已经存在的\",[\"$\",\"code\",\"code-2\",{\"children\":\"users\"}],\"表中的数据，这个列需要被设置为\",[\"$\",\"code\",\"code-3\",{\"children\":\"TRUE\"}],\"。代码中用于执行此次migration的代码使用如下SQL语句实现了这个功能：\"]}],\"\\n\",[\"$\",\"figure\",\"figure-2\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"sql\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"sql\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"UPDATE\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" users \"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"SET\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" has_data \"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"=\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" TRUE \"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"WHERE\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" TRUE;\"}]]}]}]}]}],\"\\n\",[\"$\",\"p\",\"p-10\",{\"children\":[\"看上去是个很简单的人畜无害的SQL语句，对吧？但是这个SQL语句在mssql中中是非法的，因为mssql中并没有\",[\"$\",\"code\",\"code-0\",{\"children\":\"TRUE\"}],\", \",[\"$\",\"code\",\"code-1\",{\"children\":\"FALSE\"}],\"常量！sqlserver中没有\",[\"$\",\"code\",\"code-2\",{\"children\":\"boolean\"}],\"类型，所有这些类型都是使用一个字节的\",[\"$\",\"code\",\"code-3\",{\"children\":\"tinyint\"}],\"来表示的，而\",[\"$\",\"code\",\"code-4\",{\"children\":\"TRUE\"}],\"和\",[\"$\",\"code\",\"code-5\",{\"children\":\"FALSE\"}],\"就对应使用\",[\"$\",\"code\",\"code-6\",{\"children\":\"1\"}],\"和\",[\"$\",\"code\",\"code-7\",{\"children\":\"0\"}],\"来表示。但是，\",[\"$\",\"code\",\"code-8\",{\"children\":\"1\"}],\"和\",[\"$\",\"code\",\"code-9\",{\"children\":\"0\"}],\"在sql server中并不是一个合法的\",[\"$\",\"code\",\"code-10\",{\"children\":\"boolean\"}],\"表达式，所以它们并不能直接用在\",[\"$\",\"code\",\"code-11\",{\"children\":\"WHERE\"}],\"中。所以，在MSSQL中，以上SQL语句就必须重新成以下的样子：\"]}],\"\\n\",[\"$\",\"figure\",\"figure-3\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"sql\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"sql\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"UPDATE\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" users \"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"SET\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" has_data \"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"=\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\" 1\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\";\"}]]}]}]}]}],\"\\n\",[\"$\",\"h2\",\"h2-1\",{\"id\":\"sql语句片段\",\"children\":[[\"$\",\"a\",\"sql语句片段\",{\"href\":\"#sql语句片段\",\"className\":\"mr-1\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"inline-block opacity-20 hover:opacity-60\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$21\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":16,\"width\":16,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}],\"SQL语句片段\"]}],\"\\n\",[\"$\",\"p\",\"p-11\",{\"children\":[\"另一个情况是\",[\"$\",\"strong\",\"strong-0\",{\"children\":\"SQL语句片段\"}],\"。虽然ORM的一大作用就是将软件代码映射为SQL语句，减少我们手写SQL可能带来的错误，但是为了实现的灵活性，ORM常常同样也允许在自己的API中编写一些SQL的片段，而ORM会尝试将这些SQL片段嵌入进去。但是这些SQL片段可能也会有不兼容的情况！例如，下面的代码\"]}],\"\\n\",[\"$\",\"figure\",\"figure-4\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"result\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" :=\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" db\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Table\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"summaries AS s1\\\"\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\").\"}]]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\t\\t\\tWhere\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"s1.id IN ?\\\"\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"faultyIds\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\").\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\t\\t\\tUpdate\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"num_heartbeats\\\"\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"3\\\"\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\")\"}]]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-12\",{\"children\":[\"上述gorm数据库仓库将会被映射为类型以下的SQL语句。注意\",[\"$\",\"code\",\"code-0\",{\"children\":\"Table\"}],\"和\",[\"$\",\"code\",\"code-1\",{\"children\":\"Where\"}],\"方法的参数与下列SQL语句中对应的语句的对应关系。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-5\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"sql\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"sql\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"update\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" summaries \"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"AS\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" s1 \"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"set\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" num_heartbeats \"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"=\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\" 3\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" where\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\" s1\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\"id\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" IN\"}],[\"$\",\"span\",\"span-13\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" ?\"}]]}]}]}]}],\"\\n\",[\"$\",\"p\",\"p-13\",{\"children\":[\"是不是感觉很简单？但是MSSQL仍然不支持！MSSQL不支持在\",[\"$\",\"code\",\"code-0\",{\"children\":\"update\"}],\"持语句中给表新增一个别名，所以以上SQL语句中的\",[\"$\",\"code\",\"code-1\",{\"children\":\"AS s1\"}],\"必须被去掉。\"]}],\"\\n\",[\"$\",\"h2\",\"h2-2\",{\"id\":\"重用dialector的逻辑为关键词加上引号\",\"children\":[[\"$\",\"a\",\"重用dialector的逻辑为关键词加上引号\",{\"href\":\"#重用dialector的逻辑为关键词加上引号\",\"className\":\"mr-1\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"inline-block opacity-20 hover:opacity-60\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$22\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":16,\"width\":16,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}],\"重用Dialector的逻辑，为关键词加上引号\"]}],\"\\n\",[\"$\",\"p\",\"p-14\",{\"children\":\"再看一个SQL语句片段：\"}],\"\\n\",[\"$\",\"figure\",\"figure-6\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"r\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"db\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Model\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\u0026\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"models\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"User\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"{}).\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Select\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-13\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"users.id as user, max(time) as time\\\"\"}],[\"$\",\"span\",\"span-14\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\").\"}]]}]}]}]}],\"\\n\",[\"$\",\"p\",\"p-15\",{\"children\":\"这段SQL语句一般会被映射为：\"}],\"\\n\",[\"$\",\"figure\",\"figure-7\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"sql\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"sql\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"select\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\" users\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\"id\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" as\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" user, \"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"max\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"time\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"as\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" time\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" from\"}],[\"$\",\"span\",\"span-13\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" users;\"}]]}]}]}]}],\"\\n\",[\"$\",\"p\",\"p-16\",{\"children\":[\"有问题吗？有！\",[\"$\",\"code\",\"code-0\",{\"children\":\"user\"}],\"在MSSQL中是关键词，要作为标识符使用必须使用\",[\"$\",\"code\",\"code-1\",{\"children\":\"\\\"\\\"\"}],\"或者\",[\"$\",\"code\",\"code-2\",{\"children\":\"[]\"}],\"将它包裹起来！而\",[\"$\",\"code\",\"code-3\",{\"children\":\"user\"}],\"在mysql等数据库引擎中都不是关键词，因此可以随意直接使用。\"]}],\"\\n\",[\"$\",\"p\",\"p-17\",{\"children\":[\"这个将关键词作为字符串使用的过程实际上编程中很常见，被称为\",[\"$\",\"code\",\"code-0\",{\"children\":\"escape\"}],\"，或者更简单的叫\",[\"$\",\"code\",\"code-1\",{\"children\":\"quote\"}],\"，加引号。但是更坑的是，不同的SQL引擎所使用的加引号的方法不一样。MSSQL使用的是\",[\"$\",\"code\",\"code-2\",{\"children\":\"\\\"\\\"\"}],\"或者\",[\"$\",\"code\",\"code-3\",{\"children\":\"[]\"}],\"，但是mysql使用的是`。如何通过一段代码来为不同的数据库加上正确的引号呢？\"]}],\"\\n\",[\"$\",\"p\",\"p-18\",{\"children\":[\"其实，这个加引号的过程实在是非常常见，只要ORM需要将程序员所写的名字（表名、列名等）映射到SQL，那么就需要考虑给这些名字叫上引号，防止这些名字和SQL自己的关键词冲突。如果你写一个名字叫\",[\"$\",\"code\",\"code-0\",{\"children\":\"select\"}],\"的表，没有这段逻辑，那么这个表就没法通过ORM来映射成SQL了！\"]}],\"\\n\",[\"$\",\"p\",\"p-19\",{\"children\":\"因此，根据Don't Repeat Yourself原则，ORM为数据库系统的适配器中肯定会有对应的逻辑。而我们与其自己编写这个处理逻辑，最好的方法当然是调用适配器中已经写好的逻辑了。\"}],\"\\n\",[\"$\",\"p\",\"p-20\",{\"children\":[\"gorm使用\",[\"$\",\"code\",\"code-0\",{\"children\":\"Dialector\"}],\"接口作为ORM支持不同数据库系统的适配器的接口，所有gorm支持的数据库都有一个对应的实现了\",[\"$\",\"code\",\"code-1\",{\"children\":\"Dialector\"}],\"接口的\",[\"$\",\"code\",\"code-2\",{\"children\":\"Dialector\"}],\"。所以，第一步就是去看看gorm的\",[\"$\",\"code\",\"code-3\",{\"children\":\"Dialector\"}],\"里定义了哪些接口。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-8\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/interfaces.go#L12C1-L21C2\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" Dialector\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" interface\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\tName\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"() \"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"string\"}]]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\tInitialize\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"*\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"DB\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"error\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\tMigrator\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E06C75\",\"fontStyle\":\"italic\"},\"children\":\"db\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" *\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"DB\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Migrator\"}]]}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\tDataTypeOf\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"*\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"schema\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Field\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"string\"}]]}],\"\\n\",[\"$\",\"span\",\"span-6\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\tDefaultValueOf\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"*\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"schema\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Field\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"clause\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Expression\"}]]}],\"\\n\",[\"$\",\"span\",\"span-7\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\tBindVarTo\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E06C75\",\"fontStyle\":\"italic\"},\"children\":\"writer\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" clause\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Writer\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#E06C75\",\"fontStyle\":\"italic\"},\"children\":\"stmt\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" *\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Statement\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#E06C75\",\"fontStyle\":\"italic\"},\"children\":\"v\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" interface\"}],[\"$\",\"span\",\"span-13\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"{})\"}]]}],\"\\n\",[\"$\",\"span\",\"span-8\",{\"data-line\":\"\",\"data-highlighted-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\tQuoteTo\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"clause\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Writer\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"string\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\")\"}]]}],\"\\n\",[\"$\",\"span\",\"span-9\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\tExplain\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E06C75\",\"fontStyle\":\"italic\"},\"children\":\"sql\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" string\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E06C75\",\"fontStyle\":\"italic\"},\"children\":\"vars\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" ...\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"interface\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"{}) \"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"string\"}]]}],\"\\n\",[\"$\",\"span\",\"span-10\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-21\",{\"children\":[\"从名字判断，这个\",[\"$\",\"code\",\"code-0\",{\"children\":\"QuoteTo\"}],\"方法似乎就是我们要的接口。再随便点开一个dialector实现的代码浏览一下，就能确定，\",[\"$\",\"code\",\"code-1\",{\"children\":\"QuoteTo\"}],\"就是加引号的方法。\"]}],\"\\n\",[\"$\",\"p\",\"p-22\",{\"children\":[\"可是这个方法看上去和我们想象中的不太一样：我们预期这个功能是一个\",[\"$\",\"code\",\"code-0\",{\"children\":\"(string) =\u003e string\"}],\"的函数，这里怎么是一个\",[\"$\",\"code\",\"code-1\",{\"children\":\"(clause.Writer, string) =\u003e void\"}],\"的函数，这个\",[\"$\",\"code\",\"code-2\",{\"children\":\"clause.Writer\"}],\"是什么玩意？\"]}],\"\\n\",[\"$\",\"p\",\"p-23\",{\"children\":[\"由于拼接SQL说到底，就是要生成各个SQL的片段，然后将这些片段的字符串拼接起来。在绝大多数编程语言里，\",[\"$\",\"code\",\"code-0\",{\"children\":\"string\"}],\"都是不可变的，所以拼接字符串实际上是创建了第三个字符串，然后把两个字符串的内容复制进去。这个过程如果进行太多次，就非常浪费时间和内存。所以编程语言常常会提供一个\",[\"$\",\"strong\",\"strong-0\",{\"children\":\"组装字符串的工具类\"}],\"。这个工具类可以理解成是一个\",[\"$\",\"strong\",\"strong-1\",{\"children\":\"可变\"}],\"的字符串，你可以直接在这个_字符串_的后面增加新的字符串，而不需要每次操作都创建一个全新的字符串对象。而这个\",[\"$\",\"code\",\"code-1\",{\"children\":\"Writer\"}],\"接口，就是gorm定义的一个这样的能够\",[\"$\",\"strong\",\"strong-2\",{\"children\":\"组装字符串的工具类\"}],\"所需要实现的接口。这个\",[\"$\",\"code\",\"code-2\",{\"children\":\"Writer\"}],\"接口定义如下：\"]}],\"\\n\",[\"$\",\"figure\",\"figure-9\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/clause/clause.go#L13\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" Writer\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" interface\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\tWriteByte\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"byte\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"error\"}]]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"\\tWriteString\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"string\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") (\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"int\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"error\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\")\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-24\",{\"children\":[\"很简单，很直白：\",[\"$\",\"code\",\"code-0\",{\"children\":\"WriteByte\"}],\"：在后面增加一个字符；\",[\"$\",\"code\",\"code-1\",{\"children\":\"WriteString\"}],\"，在后面增加一个字符串。\"]}],\"\\n\",[\"$\",\"p\",\"p-25\",{\"children\":[\"熟悉Go的同学可能会说了：啊，这个接口看上去非常熟悉，原生的\",[\"$\",\"code\",\"code-0\",{\"children\":\"strings.Builder\"}],\"就是用来做这个事情的，而且也有这两个方法！是不是可以直接用一个\",[\"$\",\"code\",\"code-1\",{\"children\":\"strings.Builder\"}],\"来作为这个\",[\"$\",\"code\",\"code-2\",{\"children\":\"clause.Writer\"}],\"？\"]}],\"\\n\",[\"$\",\"p\",\"p-26\",{\"children\":[\"正确！所以我们可以直接创建一个\",[\"$\",\"code\",\"code-0\",{\"children\":\"*strings.Builder\"}],\"来作为\",[\"$\",\"code\",\"code-1\",{\"children\":\"clause.Writer\"}],\"（用指针的原因是这个\",[\"$\",\"code\",\"code-2\",{\"children\":\"strings.Builder\"}],\"的这两个成员方法是使用的指针接收者而不是值接收者，所以只有对应的指针类型才算实现了这个接口。具体关于指针接收者和值接收者的区别我们就不在这里介绍了，有兴趣的可以学习一下Go语言），并在调用后获取这个\",[\"$\",\"code\",\"code-3\",{\"children\":\"builder\"}],\"最终的字符串，这样就直接调用了\",[\"$\",\"code\",\"code-4\",{\"children\":\"dialector\"}],\"中实现了加引号逻辑。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-10\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"func\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\" QuoteDbIdentifier\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E06C75\",\"fontStyle\":\"italic\"},\"children\":\"db\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" *\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"gorm\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"DB\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#E06C75\",\"fontStyle\":\"italic\"},\"children\":\"identifier\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" string\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"string\"}],[\"$\",\"span\",\"span-13\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tbuilder\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" :=\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" \u0026\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"strings\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Builder\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"{}\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tdb\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"Dialector\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"QuoteTo\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"builder\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"identifier\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\")\"}]]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\treturn\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" builder\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"String\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"()\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-27\",{\"children\":\"然后，我们将此函数用在所有需要在SQL片段中使用自定义的名字的地方，这样，我们就重用了dialector的逻辑，用同一套代码兼容了所有的数据库。\"}],\"\\n\",[\"$\",\"figure\",\"figure-11\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"r\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"db\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Model\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\u0026\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"models\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"User\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"{}).\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Select\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}]]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"data-highlighted-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"  fmt\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Sprintf\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"users.id as \"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\"%s\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#98C379\"},\"children\":\", max(time) as time\\\"\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"), \"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"utils\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"QuoteDbIndentifier\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"r\"}],[\"$\",\"span\",\"span-13\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-14\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"db\"}],[\"$\",\"span\",\"span-15\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-16\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"user\\\"\"}],[\"$\",\"span\",\"span-17\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\")\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\")\"}]}]]}]}]}],\"\\n\",[\"$\",\"h2\",\"h2-3\",{\"id\":\"重写不支持的功能\",\"children\":[[\"$\",\"a\",\"重写不支持的功能\",{\"href\":\"#重写不支持的功能\",\"className\":\"mr-1\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"inline-block opacity-20 hover:opacity-60\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$23\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":16,\"width\":16,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}],\"重写不支持的功能\"]}],\"\\n\",[\"$\",\"p\",\"p-28\",{\"children\":\"而在进一步查找并修改原生SQL的语句中，我找到了一段如下的原生SQL语句，直接让我眼前一黑。\"}],\"\\n\",[\"$\",\"figure\",\"figure-12\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"sql\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"sql\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"with\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" projects \"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"as\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" (\"}]]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\tselect\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" project, user_id, \"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"min\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"time\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"as\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" first\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"max\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"time\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-13\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"as\"}],[\"$\",\"span\",\"span-14\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" last\"}],[\"$\",\"span\",\"span-15\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-16\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"count\"}],[\"$\",\"span\",\"span-17\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(*) \"}],[\"$\",\"span\",\"span-18\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"as\"}],[\"$\",\"span\",\"span-19\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" cnt\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\tfrom\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" heartbeats\"}]]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\twhere\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" user_id \"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"=\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" ? \"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"and\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" project \"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"!=\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" ''\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\tand\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" time\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" between\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" ? \"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"and\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" ?\"}]]}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\tand\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" language\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" is not null\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" and\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" language\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\" !=\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" ''\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" and\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" project \"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"!=\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" ''\"}]]}],\"\\n\",[\"$\",\"span\",\"span-6\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\tgroup by\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" project, user_id\"}]]}],\"\\n\",[\"$\",\"span\",\"span-7\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\torder by\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" last\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" desc\"}]]}],\"\\n\",[\"$\",\"span\",\"span-8\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\tlimit\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" ? offset ? )\"}]]}],\"\\n\",[\"$\",\"span\",\"span-9\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"select distinct\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" project, \"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"min\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"first\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"as\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" first\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"min\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"last\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-13\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"as\"}],[\"$\",\"span\",\"span-14\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" last\"}],[\"$\",\"span\",\"span-15\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-16\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"min\"}],[\"$\",\"span\",\"span-17\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(cnt) \"}],[\"$\",\"span\",\"span-18\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"as\"}],[\"$\",\"span\",\"span-19\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" count, \"}],[\"$\",\"span\",\"span-20\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"first_value\"}],[\"$\",\"span\",\"span-21\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-22\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"language\"}],[\"$\",\"span\",\"span-23\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-24\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"over\"}],[\"$\",\"span\",\"span-25\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" (\"}],[\"$\",\"span\",\"span-26\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"partition\"}],[\"$\",\"span\",\"span-27\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" by\"}],[\"$\",\"span\",\"span-28\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" project \"}],[\"$\",\"span\",\"span-29\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"order by\"}],[\"$\",\"span\",\"span-30\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\" count\"}],[\"$\",\"span\",\"span-31\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(*) \"}],[\"$\",\"span\",\"span-32\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"desc\"}],[\"$\",\"span\",\"span-33\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-34\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"as\"}],[\"$\",\"span\",\"span-35\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" top_language\"}]]}],\"\\n\",[\"$\",\"span\",\"span-10\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\tfrom\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" heartbeats\"}]]}],\"\\n\",[\"$\",\"span\",\"span-11\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\tinner join\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" projects \"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"using\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" (project, user_id)\"}]]}],\"\\n\",[\"$\",\"span\",\"span-12\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\tgroup by\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" project, \"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"language\"}]]}],\"\\n\",[\"$\",\"span\",\"span-13\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\t\\t\\torder by\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" last\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" desc\"}]]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-29\",{\"children\":\"这段SQL语句就这样赤裸裸地写在代码里。经过以上几个例子，是不是以为这个SQL在MSSQL中必定问题巨大，不重新写一份根本跑不起来？\"}],\"\\n\",[\"$\",\"p\",\"p-30\",{\"children\":\"我一开始也是这么想的。而我自己对SQL Server并没有那么熟悉，所以聪明的我，在给一些名字叫上引号后，直接把这段代码扔给了GitHub Copilot，让它帮我改成SQL Server能用的。反直觉的是，这段代码实际上问题没那么大：\"}],\"\\n\",[\"$\",\"p\",\"p-31\",{\"children\":\"$L24\"}],\"\\n\",[\"$\",\"p\",\"p-32\",{\"children\":\"具体来说，除了第三点去掉了不需要的引号后，有两个问题：\"}],\"\\n\",[\"$\",\"ol\",\"ol-0\",{\"children\":[\"\\n\",[\"$\",\"li\",\"li-0\",{\"children\":[\"不支持\",[\"$\",\"code\",\"code-0\",{\"children\":\"join using\"}],\"，需要使用常规的\",[\"$\",\"code\",\"code-1\",{\"children\":\"join on\"}],\"代替\"]}],\"\\n\",[\"$\",\"li\",\"li-1\",{\"children\":[\"不支持\",[\"$\",\"code\",\"code-0\",{\"children\":\"limit offset\"}],\"。查找了一下，mssql可以使用\",[\"$\",\"code\",\"code-1\",{\"children\":\"offset ? ROWS fetch next ? rows only\"}],\"来代替，当然\",[\"$\",\"code\",\"code-2\",{\"children\":\"limit\"}],\"和\",[\"$\",\"code\",\"code-3\",{\"children\":\"offset\"}],\"的参数顺序是反过来的\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-33\",{\"children\":\"啊，原来这么简单！由于需要修改的地方并不多，于是我就简单的通过if判断，将其中SQL Server不兼容的部分修改为SQL Server兼容的SQL语句，这段SQL语句也就完成了。\"}],\"\\n\",[\"$\",\"h2\",\"h2-4\",{\"id\":\"把同一个go类型在不同的数据库中映射为不同的列类型\",\"children\":[[\"$\",\"a\",\"把同一个go类型在不同的数据库中映射为不同的列类型\",{\"href\":\"#把同一个go类型在不同的数据库中映射为不同的列类型\",\"className\":\"mr-1\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"inline-block opacity-20 hover:opacity-60\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$25\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":16,\"width\":16,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}],\"把同一个go类型在不同的数据库中映射为不同的列类型\"]}],\"\\n\",[\"$\",\"p\",\"p-34\",{\"children\":\"修改了这些SQL语句后，程序仍然运行不起来，仔细一看，报错如下：\"}],\"\\n\",[\"$\",\"pre\",\"pre-0\",{\"children\":[\"$\",\"code\",\"code-0\",{\"children\":\"mssql: A table can only have one timestamp. Because table 'users' already has one, the column 'last_logged_in_at' cannot be added.\\n\"}]}],\"\\n\",[\"$\",\"p\",\"p-35\",{\"children\":[\"简单翻译，一个表只能有一个类型为\",[\"$\",\"code\",\"code-0\",{\"children\":\"timestamp\"}],\"的列，而\",[\"$\",\"code\",\"code-1\",{\"children\":\"users\"}],\"中有多个列都是\",[\"$\",\"code\",\"code-2\",{\"children\":\"timestamp\"}],\"的类型，所以SQL Server报错了。\"]}],\"\\n\",[\"$\",\"p\",\"p-36\",{\"children\":[\"去代码中一看，\",[\"$\",\"code\",\"code-0\",{\"children\":\"users\"}],\"表对应的\",[\"$\",\"code\",\"code-1\",{\"children\":\"User\"}],\"struct确实有好几个字段都通过\",[\"$\",\"a\",\"a-0\",{\"href\":\"https://gorm.io/docs/models.html#Fields-Tags\",\"children\":\"gorm的field tag功能\"}],[\"$\",\"code\",\"code-2\",{\"children\":\"type:timestamp\"}],\"，确定了在数据库中这些列需要映射为\",[\"$\",\"code\",\"code-3\",{\"children\":\"timestamp\"}],\"类型。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-13\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/user.go#L17\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" User\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" struct\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"  CreatedAt\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"           CustomTime\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"  `gorm:\\\"type:\"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"timestamp\"}]}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"; default:CURRENT_TIMESTAMP\\\" swaggertype:\\\"string\\\" format:\\\"date\\\" example:\\\"2006-01-02 15:04:05.000\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tLastLoggedInAt\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"      CustomTime\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"  `gorm:\\\"type:\"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"timestamp\"}]}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"; default:CURRENT_TIMESTAMP\\\" swaggertype:\\\"string\\\" format:\\\"date\\\" example:\\\"2006-01-02 15:04:05.000\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-6\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"  SubscribedUntil\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"     *\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"CustomTime\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"-\\\" gorm:\\\"type:\"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"timestamp\"}]}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\" swaggertype:\\\"string\\\" format:\\\"date\\\" example:\\\"2006-01-02 15:04:05.000\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-7\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tSubscriptionRenewal\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" *\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"CustomTime\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"-\\\" gorm:\\\"type:\"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"timestamp\"}]}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\" swaggertype:\\\"string\\\" format:\\\"date\\\" example:\\\"2006-01-02 15:04:05.000\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-8\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-37\",{\"children\":[[\"$\",\"code\",\"code-0\",{\"children\":\"timestamp\"}],\"有什么问题呢？MySQL不都是使用\",[\"$\",\"code\",\"code-1\",{\"children\":\"timestamp\"}],\"来代表时间类型吗？去查找\",[\"$\",\"code\",\"code-2\",{\"children\":\"sql server timestamp\"}],\"，我才发现，SQL Server里的\",[\"$\",\"code\",\"code-3\",{\"children\":\"timestamp\"}],\"的含义和别的数据库中的含义不一样。在别的数据库中，\",[\"$\",\"code\",\"code-4\",{\"children\":\"timestamp\"}],\"就是一个表示时间戳/时间点的类型，而根据\",[\"$\",\"a\",\"a-0\",{\"href\":\"https://stackoverflow.com/a/12063938\",\"children\":\"这个stackoverflow回答\"}],\"，\",[\"$\",\"code\",\"code-5\",{\"children\":\"sql server\"}],\"中的\",[\"$\",\"code\",\"code-6\",{\"children\":\"timestamp\"}],\"主要用于乐观锁的情况（具体不在这里阐述），只是用来标记本行上一次被修改的时间，所以每个表只能存在一个\",[\"$\",\"code\",\"code-7\",{\"children\":\"timestamp\"}],\"的列。而在SQL Server中如果要表示一个时间戳，需要使用\",[\"$\",\"code\",\"code-8\",{\"children\":\"datetimeoffset\"}],\"。\"]}],\"\\n\",[\"$\",\"p\",\"p-38\",{\"children\":[\"所以现在问题就变成了：\",[\"$\",\"strong\",\"strong-0\",{\"children\":\"如何将一个类型在不同的数据库中映射为不同的列的类型\"}],\"。\"]}],\"\\n\",[\"$\",\"p\",\"p-39\",{\"children\":[[\"$\",\"code\",\"code-0\",{\"children\":\"type:timestamp\"}],\"这个tag肯定是不能用了，于是我们就需要查找有没有其他更动态的方法，可以自定义一个go字段映射到数据库中的类型。经过一番查找，我们找到了\",[\"$\",\"a\",\"a-0\",{\"href\":\"https://gorm.io/docs/data_types.html#GormDataTypeInterface\",\"children\":\"Customize Data Type\"}],\"功能。gorm允许定义一个自定义的\",[\"$\",\"code\",\"code-1\",{\"children\":\"struct\"}],\"，并给这个\",[\"$\",\"code\",\"code-2\",{\"children\":\"struct\"}],\"实现\",[\"$\",\"code\",\"code-3\",{\"children\":\"GormDBDataTypeInterface\"}],\"接口，来返回这个类型的字段所真正对应的数据库类型。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-14\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" GormDBDataTypeInterface\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" interface\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"  GormDBDataType\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"*\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"gorm\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"DB\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"*\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"schema\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Field\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"string\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-40\",{\"children\":[\"这个函数的第一个参数就是\",[\"$\",\"code\",\"code-0\",{\"children\":\"gorm.DB\"}],\"对象，指向当前操作的数据库对象，可以获取到当前正在使用什么类型的\",[\"$\",\"code\",\"code-1\",{\"children\":\"Dialector\"}],\"，我们就可以根据\",[\"$\",\"code\",\"code-2\",{\"children\":\"Dialector\"}],\"类型，来输出对应的数据库列类型。另外，这个\",[\"$\",\"code\",\"code-3\",{\"children\":\"CustomTime\"}],\"正好是代码中所定义的一个新的\",[\"$\",\"code\",\"code-4\",{\"children\":\"struct\"}],\"，我们可以直接在\",[\"$\",\"code\",\"code-5\",{\"children\":\"CustomTime\"}],\"上实现这个接口。\"]}],\"\\n\",[\"$\",\"p\",\"p-41\",{\"children\":[\"看来比较简单，但是为了以防万一，我们再全局搜索一下\",[\"$\",\"code\",\"code-0\",{\"children\":\"type:timestamp\"}],\"，看看有没有什么其他的用法。果然被我找到了！\"]}],\"\\n\",[\"$\",\"figure\",\"figure-15\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/heartbeat.go#L27\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" Heartbeat\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" struct\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"  Time\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"            CustomTime\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"time\\\" gorm:\\\"type:\"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"timestamp(3)\"}]}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"; index:idx_time; index:idx_time_user\\\" swaggertype:\\\"primitive,number\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-42\",{\"children\":[\"这里用到了\",[\"$\",\"code\",\"code-0\",{\"children\":\"timestamp(3)\"}],\"。根据\",[\"$\",\"a\",\"a-0\",{\"href\":\"https://dev.mysql.com/doc/refman/8.0/en/fractional-seconds.html\",\"children\":\"mysql的文档\"}],\"，\",[\"$\",\"code\",\"code-1\",{\"children\":\"timestamp(n)\"}],\"中的\",[\"$\",\"code\",\"code-2\",{\"children\":\"n\"}],\"是代表精确到秒后面的第几位浮点位，\",[\"$\",\"code\",\"code-3\",{\"children\":\"3\"}],\"代表精确到毫秒，而\",[\"$\",\"code\",\"code-4\",{\"children\":\"6\"}],\"代表精确到微秒。而SQL Server的\",[\"$\",\"code\",\"code-5\",{\"children\":\"datetimeoffset\"}],\"也支持类似的标记（\",[\"$\",\"a\",\"a-1\",{\"href\":\"https://learn.microsoft.com/en-us/sql/t-sql/data-types/datetimeoffset-transact-sql?view=sql-server-ver16\",\"children\":\"文档\"}],\"），\",[\"$\",\"code\",\"code-6\",{\"children\":\"datetimeoffset(n)\"}],\"中的\",[\"$\",\"code\",\"code-7\",{\"children\":\"n\"}],\"也同样表示精确到秒后面的第几位浮点位。由于我们不能直接使用\",[\"$\",\"code\",\"code-8\",{\"children\":\"type\"}],\"tag，但是我们还需要一个tag用来表示这个精确的位数（根据sql server的文档，将这个位数称为\",[\"$\",\"code\",\"code-9\",{\"children\":\"scale\"}],\"），所以，我们可以定义一个全新的\",[\"$\",\"code\",\"code-10\",{\"children\":\"timeScale\"}],\"的tag，其值就是\",[\"$\",\"code\",\"code-11\",{\"children\":\"scale\"}],\"的值。而一个字段上具体有哪些tag，正好可以通过\",[\"$\",\"code\",\"code-12\",{\"children\":\"GormDBDataType\"}],\"的第二个参数获取。\"]}],\"\\n\",[\"$\",\"p\",\"p-43\",{\"children\":[\"于是根据这个思路，我们实现了\",[\"$\",\"code\",\"code-0\",{\"children\":\"CustomTime\"}],\"的\",[\"$\",\"code\",\"code-1\",{\"children\":\"GormDBDataType\"}],\"方法：\"]}],\"\\n\",[\"$\",\"figure\",\"figure-16\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/shared.go#L44\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"func\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" (\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E06C75\",\"fontStyle\":\"italic\"},\"children\":\"j \"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"CustomTime\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"GormDBDataType\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#E06C75\",\"fontStyle\":\"italic\"},\"children\":\"db\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" *\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"gorm\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"DB\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-13\",{\"style\":{\"color\":\"#E06C75\",\"fontStyle\":\"italic\"},\"children\":\"field\"}],[\"$\",\"span\",\"span-14\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" *\"}],[\"$\",\"span\",\"span-15\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"schema\"}],[\"$\",\"span\",\"span-16\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-17\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Field\"}],[\"$\",\"span\",\"span-18\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") \"}],[\"$\",\"span\",\"span-19\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"string\"}],[\"$\",\"span\",\"span-20\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tt\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" :=\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" \\\"timestamp\\\"\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // 如果使用的是SQL Server Dialector，则将其类型设置为datetimeoffset\"}]}],\"\\n\",[\"$\",\"span\",\"span-6\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\tif\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" db\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"Config\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"Dialector\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Name\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"() \"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"==\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" (\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"sqlserver\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-13\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Dialector\"}],[\"$\",\"span\",\"span-14\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"{}).\"}],[\"$\",\"span\",\"span-15\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Name\"}],[\"$\",\"span\",\"span-16\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"() {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-7\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\t\\tt\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" =\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" \\\"datetimeoffset\\\"\"}]]}],\"\\n\",[\"$\",\"span\",\"span-8\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"\\t}\"}]}],\"\\n\",[\"$\",\"span\",\"span-9\",{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",\"span-10\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // 如果一个属性有TIMESCALE的tag，那么给类型后面增加(n)参数\"}]}],\"\\n\",[\"$\",\"span\",\"span-11\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // gorm将所有gorm下的tag的key转换成了全大写\"}]}],\"\\n\",[\"$\",\"span\",\"span-12\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // 参考：https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/schema/utils.go#L35\"}]}],\"\\n\",[\"$\",\"span\",\"span-13\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\tif\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" scale\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"ok\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" :=\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" field\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"TagSettings\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"[\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"TIMESCALE\\\"\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"]; \"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"ok\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-14\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\t\\tt\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" +=\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" fmt\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Sprintf\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"(\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\"%s\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#98C379\"},\"children\":\")\\\"\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"scale\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\")\"}]]}],\"\\n\",[\"$\",\"span\",\"span-15\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"\\t}\"}]}],\"\\n\",[\"$\",\"span\",\"span-16\",{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",\"span-17\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\\treturn\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" t\"}]]}],\"\\n\",[\"$\",\"span\",\"span-18\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-44\",{\"children\":[\"同时，我们将所有的\",[\"$\",\"code\",\"code-0\",{\"children\":\"timestamp\"}],\"都直接去掉，将\",[\"$\",\"code\",\"code-1\",{\"children\":\"type:timestamp(n)\"}],\"修改为了\",[\"$\",\"code\",\"code-2\",{\"children\":\"timeScale:n\"}],\"：\"]}],\"\\n\",[\"$\",\"figure\",\"figure-17\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/user.go#L17\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" User\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" struct\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"  CreatedAt\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"           CustomTime\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"  `gorm:\\\"default:CURRENT_TIMESTAMP\\\" swaggertype:\\\"string\\\" format:\\\"date\\\" example:\\\"2006-01-02 15:04:05.000\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"  LastLoggedInAt\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"      CustomTime\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"  `gorm:\\\"default:CURRENT_TIMESTAMP\\\" swaggertype:\\\"string\\\" format:\\\"date\\\" example:\\\"2006-01-02 15:04:05.000\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-6\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"  SubscribedUntil\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"     *\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"CustomTime\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"-\\\" swaggertype:\\\"string\\\" format:\\\"date\\\" example:\\\"2006-01-02 15:04:05.000\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-7\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"  SubscriptionRenewal\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" *\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"CustomTime\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"-\\\" swaggertype:\\\"string\\\" format:\\\"date\\\" example:\\\"2006-01-02 15:04:05.000\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-8\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}],\"\\n\",[\"$\",\"span\",\"span-9\",{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",\"span-10\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/heartbeat.go#L12\"}]}],\"\\n\",[\"$\",\"span\",\"span-11\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" Heartbeat\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" struct\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-12\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-13\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"  Time\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"            CustomTime\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"time\\\" gorm:\\\"\"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"timeScale:3\"}]}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"; index:idx_time; index:idx_time_user\\\" swaggertype:\\\"primitive,number\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-14\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-15\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-45\",{\"children\":\"这样就解决了这个问题。\"}],\"\\n\",[\"$\",\"h2\",\"h2-5\",{\"id\":\"避免创建递归的级联修改外键约束\",\"children\":[[\"$\",\"a\",\"避免创建递归的级联修改外键约束\",{\"href\":\"#避免创建递归的级联修改外键约束\",\"className\":\"mr-1\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"inline-block opacity-20 hover:opacity-60\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$26\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":16,\"width\":16,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}],\"避免创建递归的级联修改外键约束\"]}],\"\\n\",[\"$\",\"p\",\"p-46\",{\"children\":\"没想到的是，到这里仍然无法启动程序。报错如下：\"}],\"\\n\",[\"$\",\"figure\",\"figure-18\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"{3}\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"{3}\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"children\":\"[2.938ms] [rows:0] CREATE TABLE \\\"summary_items\\\" (\\\"id\\\" bigint IDENTITY(1,1),\\\"summary_id\\\" bigint,\\\"type\\\" smallint,\\\"key\\\" nvarchar(255),\\\"total\\\" bigint,PRIMARY KEY (\\\"id\\\"),CONSTRAINT \\\"fk_summaries_editors\\\" FOREIGN KEY (\\\"summary_id\\\") REFERENCES \\\"summaries\\\"(\\\"id\\\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \\\"fk_summaries_operating_systems\\\" FOREIGN KEY (\\\"summary_id\\\") REFERENCES \\\"summaries\\\"(\\\"id\\\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \\\"fk_summaries_machines\\\" FOREIGN KEY (\\\"summary_id\\\") REFERENCES \\\"summaries\\\"(\\\"id\\\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \\\"fk_summaries_projects\\\" FOREIGN KEY (\\\"summary_id\\\") REFERENCES \\\"summaries\\\"(\\\"id\\\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \\\"fk_summaries_languages\\\" FOREIGN KEY (\\\"summary_id\\\") REFERENCES \\\"summaries\\\"(\\\"id\\\") ON DELETE CASCADE ON UPDATE CASCADE)\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"children\":\"2024-01-19T19:29:35.607826413+08:00 [ERROR] mssql: Could not create constraint or index. See previous errors.\"}]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"children\":\"panic: mssql: Could not create constraint or index. See previous errors.\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-47\",{\"children\":[[\"$\",\"code\",\"code-0\",{\"children\":\"Could not create constraint or index. See previous errors.\"}],\"这个等于什么都没说嘛，只知道创建一个外键约束或者索引的时候失败了，而其他的错误信息被gorm或者gorm的sqlserver dialector忽略了。还\"]}],\"\\n\",[\"$\",\"p\",\"p-48\",{\"children\":\"还好我能看到具体执行的SQL语句，所以我们可以把这段SQL语句手动输入到Azure Data Studio中，看看数据库引擎到底报了什么错误。\"}],\"\\n\",[\"$\",\"p\",\"p-49\",{\"children\":\"$L27\"}],\"\\n\",[\"$\",\"blockquote\",\"blockquote-0\",{\"children\":[\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":\"Introducing FOREIGN KEY constraint 'fk_summaries_operating_systems' on table 'summary_items' may cause cycles or multiple cascade paths. Specify ON DELETE NO ACTION or ON UPDATE NO ACTION, or modify other FOREIGN KEY constraints.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-50\",{\"children\":[\"看起来，是因为\",[\"$\",\"code\",\"code-0\",{\"children\":\"fk_summaries_operating_systems\"}],\"这个级联的外键索引会造成级联递归（cycles）。和外键约束有关，而外键约束是通过gorm定义，所以我们先去看看代码里涉及这个外键约束的两个表的定义。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-19\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/summary.go#L29\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" Summary\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" struct\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tProjects\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"         SummaryItems\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"projects\\\" gorm:\\\"\"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"}]}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tLanguages\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"        SummaryItems\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"languages\\\" gorm:\\\"\"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"}]}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tEditors\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"          SummaryItems\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"editors\\\" gorm:\\\"\"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"}]}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-6\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tOperatingSystems\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" SummaryItems\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"operating_systems\\\" gorm:\\\"\"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"}]}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-7\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tMachines\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"         SummaryItems\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"machines\\\" gorm:\\\"\"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"}]}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-8\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}],\"\\n\",[\"$\",\"span\",\"span-9\",{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",\"span-10\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" SummaryItems\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" []\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"*\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"SummaryItem\"}]]}],\"\\n\",[\"$\",\"span\",\"span-11\",{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",\"span-12\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" SummaryItem\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" struct\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-13\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-14\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tSummary\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"   *\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Summary\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"      `json:\\\"-\\\" gorm:\\\"not null; \"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"}]}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-15\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tSummaryID\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" uint\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"          `json:\\\"-\\\" gorm:\\\"size:32\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-16\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-51\",{\"children\":[\"也就是说，\",[\"$\",\"code\",\"code-0\",{\"children\":\"Summary\"}],\"和\",[\"$\",\"code\",\"code-1\",{\"children\":\"SummaryItem\"}],\"两个表是1:m的关系，这个关系映射到数据库中，也就是\",[\"$\",\"code\",\"code-2\",{\"children\":\"SummaryItem\"}],\"表中有到\",[\"$\",\"code\",\"code-3\",{\"children\":\"Summary\"}],\"的ID的外键\",[\"$\",\"code\",\"code-4\",{\"children\":\"summary_id\"}],\"，而这个外键的约束则是通过\",[\"$\",\"code\",\"code-5\",{\"children\":\"Summary\"}],\"表中的tag定义的。\"]}],\"\\n\",[\"$\",\"p\",\"p-52\",{\"children\":[\"转回头去看生成的SQL，生成的SQL里有\",[\"$\",\"strong\",\"strong-0\",{\"children\":\"5\"}],\"个完全相同的外键（\",[\"$\",\"code\",\"code-0\",{\"children\":\"fk_summaries_editors\"}],\", \",[\"$\",\"code\",\"code-1\",{\"children\":\"fk_summaries_operating_systems\"}],\"，\",[\"$\",\"code\",\"code-2\",{\"children\":\"fk_summaries_machines\"}],\"，\",[\"$\",\"code\",\"code-3\",{\"children\":\"fk_summaries_projects\"}],\"和\",[\"$\",\"code\",\"code-4\",{\"children\":\"fk_summaries_languages\"}],\"）。由于这五个外键都是级联删除（\",[\"$\",\"code\",\"code-5\",{\"children\":\"ON DELETE CASCADE\"}],\"）和级联更新（\",[\"$\",\"code\",\"code-6\",{\"children\":\"ON UPDATE CASCADE\"}],\"），实际上确实是会存在一个级联递归：当一个\",[\"$\",\"code\",\"code-7\",{\"children\":\"SummaryItem\"}],\"被删除，会造成其对应的\",[\"$\",\"code\",\"code-8\",{\"children\":\"Summary\"}],\"被删除，而\",[\"$\",\"code\",\"code-9\",{\"children\":\"Summary\"}],\"被删除可能会造成这个\",[\"$\",\"code\",\"code-10\",{\"children\":\"SummaryItem\"}],\"也被删除。\"]}],\"\\n\",[\"$\",\"p\",\"p-53\",{\"children\":[\"那问题又来了，那为什么之前在MySQL、PostgresSQL等数据库里均正常呢？通过\",[\"$\",\"a\",\"a-0\",{\"href\":\"https://stackoverflow.com/a/852047\",\"children\":\"这篇Stack Overflow\"}],\"的回答，我们知道了这种问题在其他数据库中并不是问题：其他数据库会尝试解出一条级联路径出来。而SQL Server不会去尝试解，发现了这种循环，就会直接报错。\"]}],\"\\n\",[\"$\",\"p\",\"p-54\",{\"children\":[\"那如何解决这个问题呢？根据外键名和\",[\"$\",\"code\",\"code-0\",{\"children\":\"Summary\"}],\"中的属性的对应关系，我们可以推测，这五个外键是\",[\"$\",\"code\",\"code-1\",{\"children\":\"Summary\"}],\"中五个引用一一对应过来的。由于这五个外键实际上是一模一样的，只需要保留一个就可以了。所以，最终的解决方案是，只保留一个字段的外键tag，其他字段全部给一个\",[\"$\",\"code\",\"code-2\",{\"children\":\"-\"}],\"的tag，让gorm不要为这些字段生成外键。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-20\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/summary.go#L30\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" Summary\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" struct\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tProjects\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" SummaryItems\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"projects\\\" gorm:\\\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"data-highlighted-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tLanguages\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"        SummaryItems\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"languages\\\" gorm:\\\"-\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"data-highlighted-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tEditors\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"          SummaryItems\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"editors\\\" gorm:\\\"-\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-6\",{\"data-line\":\"\",\"data-highlighted-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tOperatingSystems\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" SummaryItems\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"operating_systems\\\" gorm:\\\"-\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-7\",{\"data-line\":\"\",\"data-highlighted-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tMachines\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"         SummaryItems\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\" `json:\\\"machines\\\" gorm:\\\"-\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-8\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"h2\",\"h2-6\",{\"id\":\"规避gorm-sqlserver的bug\",\"children\":[[\"$\",\"a\",\"规避gorm-sqlserver的bug\",{\"href\":\"#规避gorm-sqlserver的bug\",\"className\":\"mr-1\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"inline-block opacity-20 hover:opacity-60\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$28\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":16,\"width\":16,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}],\"规避gorm sqlserver的bug\"]}],\"\\n\",[\"$\",\"p\",\"p-55\",{\"children\":[\"至此，系统终于能启动起来了，并且大多数功能已经可以正常使用了。而在代码审核过程中，作者还\",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/muety/wakapi/pull/592#issuecomment-1892627154\",\"children\":\"发现了一个问题\"}],\"：代码中有一个\",[\"$\",\"code\",\"code-0\",{\"children\":\"Heartbeat\"}],\"表，它就是wakatime的客户端插件定期给服务器端发送的数据，其中包含了正在工作的项目、使用的编程语言等信息。而这个表中有一个字段为\",[\"$\",\"code\",\"code-1\",{\"children\":\"Hash\"}],\"，这个字段的值根据其他信息算出来，并且有一个\",[\"$\",\"code\",\"code-2\",{\"children\":\"unique index\"}],\"，通过这个字段，就避免给\",[\"$\",\"code\",\"code-3\",{\"children\":\"Heartbeat\"}],\"表插入多个重复的数据。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-21\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/heartbeat.go#L13\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"type\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" Heartbeat\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" struct\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"data-highlighted-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"\\tHash\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"            string\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"     `json:\\\"-\\\" gorm:\\\"type:varchar(17); uniqueIndex\\\"`\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"  // ...\"}]}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-56\",{\"children\":[\"在插入的时候，作者使用了\",[\"$\",\"code\",\"code-0\",{\"children\":\"ON CONFLICT DO NOTHING\"}],\"的语句，这个语句的作用就是，如果当插入一行的时候，发现有些行违反了某个\",[\"$\",\"code\",\"code-1\",{\"children\":\"unique index\"}],\"的要求，则\",[\"$\",\"strong\",\"strong-0\",{\"children\":\"忽略\"}],\"这个问题，不插入这一行，也不报错。这刚好非常适合插入有可能有重复的\",[\"$\",\"code\",\"code-2\",{\"children\":\"Heartbeat\"}],\"的场景。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-22\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/repositories/heartbeat.go#L52\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// 下述代码将会被映射为ON CONFLICT DO NOTHING\"}]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"if\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" err\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" :=\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" r\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"db\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}]]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"  Clauses\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"clause\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"OnConflict\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"{\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"    DoNothing\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\": \"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\"true\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\",\"}]]}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"  }).\"}]}],\"\\n\",[\"$\",\"span\",\"span-6\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"  Create\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"\u0026\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"heartbeats\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\").\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"Error\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"; \"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"err\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\" !=\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\" nil\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-7\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"  return\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" err\"}]]}],\"\\n\",[\"$\",\"span\",\"span-8\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}],\"\\n\",[\"$\",\"span\",\"span-9\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"return\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\" nil\"}]]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-57\",{\"children\":[\"这种行为被称为\",[\"$\",\"strong\",\"strong-0\",{\"children\":\"插入或者更新\"}],\"，又被称为\",[\"$\",\"strong\",\"strong-1\",{\"children\":\"Upsert\"}],\"（Update/Insert），其行为是一个简单的判断：如果一行已经存在，则更新这一行的内容；如果不存在，则插入这一行。而如何判断\",[\"$\",\"strong\",\"strong-2\",{\"children\":\"一行是否存在\"}],\"呢？则是通过\",[\"$\",\"code\",\"code-0\",{\"children\":\"unique index\"}],\"来判断。\"]}],\"\\n\",[\"$\",\"p\",\"p-58\",{\"children\":[\"可是遗憾的是，SQL Server不支持\",[\"$\",\"code\",\"code-0\",{\"children\":\"ON CONFLICT DO NOTHING\"}],\"。要想在SQL Server中模拟upsert的行为，\",[\"$\",\"a\",\"a-0\",{\"href\":\"https://michaeljswart.com/2017/07/sql-server-upsert-patterns-and-antipatterns/\",\"children\":\"有很多方式\"}],\"，一个比较常见的方法是使用\",[\"$\",\"code\",\"code-1\",{\"children\":\"merge into\"}],\"语句。具体如何编写比较复杂，这里就不再具体讲解。\"]}],\"\\n\",[\"$\",\"p\",\"p-59\",{\"children\":[\"由于这里是使用的gorm的API，并不是使用原生SQL语句，所以理论上来说，gorm是可以知道用户的意图，并根据不同的数据库生成行为相同的、但是兼容对应数据库的SQL语句的。根据\",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/go-gorm/sqlserver/issues/47\",\"children\":\"这个issue\"}],\"，gorm的SQL Server库确实在很早之前就尝试通过生成一段的SQL Server兼容的SQL语句来支持这个功能，在gorm的文档里也\",[\"$\",\"a\",\"a-1\",{\"href\":\"https://gorm.io/docs/create.html#Upsert-x2F-On-Conflict\",\"children\":\"提到了\"}],\"，\",[\"$\",\"code\",\"code-0\",{\"children\":\"clause.OnConflict\"}],\"会根据不同的数据库生成不同的语句，而对于SQL Server，其对应生成的正好就是\",[\"$\",\"code\",\"code-1\",{\"children\":\"MERGE INTO\"}],\"语句。\"]}],\"\\n\",[\"$\",\"p\",\"p-60\",{\"children\":[\"但是，既然库都支持了，那为什么还会遇到这个错误呢？再次检查所实际执行的SQL，发现这一次\",[\"$\",\"code\",\"code-0\",{\"children\":\"Create\"}],\"实际上生成的SQL语句仍然是最普通的\",[\"$\",\"code\",\"code-1\",{\"children\":\"INSERT INTO\"}],\"，并没有不是正确的\",[\"$\",\"code\",\"code-2\",{\"children\":\"MERGE INTO\"}],\"，。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-23\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"SQL\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"SQL\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"children\":\"024/01/19 20:10:23 /home/ddadaal/Code/wakapi/repositories/heartbeat.go:54 mssql: Cannot insert duplicate key row in object 'dbo.heartbeats' with unique index 'idx_heartbeats_hash'. The duplicate key value is (d926be93ebcc4b6f).\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"children\":\"[10.830ms] [rows:0] \"}],[\"$\",\"mark\",\"mark-0\",{\"data-highlighted-chars\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"children\":\"INSERT INTO\"}]}],[\"$\",\"span\",\"span-1\",{\"children\":\" \\\"heartbeats\\\" (\\\"user_id\\\",\\\"entity\\\",\\\"type\\\",\\\"category\\\",\\\"project\\\",\\\"branch\\\",\\\"language\\\",\\\"is_write\\\",\\\"editor\\\",\\\"operating_system\\\",\\\"machine\\\",\\\"user_agent\\\",\\\"time\\\",\\\"hash\\\",\\\"origin\\\",\\\"origin_id\\\",\\\"created_at\\\") OUTPUT INSERTED.\\\"id\\\" VALUES ('ddadaal','/home/user1/dev/project1/main.go','file','','wakapi','','Go',1,'','','','curl/8.5.0','2024-01-16 02:16:18.954','d926be93ebcc4b6f','','','2024-01-19 20:10:23.378');\"}]]}]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-61\",{\"children\":[\"看来，要想弄明白这个问题，就得进到\",[\"$\",\"code\",\"code-0\",{\"children\":\"gorm\"}],\"的源码里来查看问题出在哪里了。使用VSCode启动一个调试版本的程序，给上面的代码的位置打上断电，使用\",[\"$\",\"code\",\"code-1\",{\"children\":\"curl\"}],\"连续插入两次同样的\",[\"$\",\"code\",\"code-2\",{\"children\":\"Heartbeat\"}],\"，根据断点往内查找，当进入到gorm的sqlserver的适配器的时候的代码的时候，我们发现了一些端倪：\"]}],\"\\n\",[\"$\",\"p\",\"p-62\",{\"children\":\"$L29\"}],\"\\n\",[\"$\",\"p\",\"p-63\",{\"children\":[\"当前，我们正在图中的\",[\"$\",\"code\",\"code-0\",{\"children\":\"if hasConflict\"}],\"的位置，且\",[\"$\",\"code\",\"code-1\",{\"children\":\"hasConflict\"}],\"当前为true。根据下面的一段代码，如果\",[\"$\",\"code\",\"code-2\",{\"children\":\"hasConflict\"}],\"为\",[\"$\",\"code\",\"code-3\",{\"children\":\"true\"}],\"的话，将会进入\",[\"$\",\"code\",\"code-4\",{\"children\":\"MergeCreate\"}],\"函数，而这个函数即是一个在MySQL实现类似行为的SQL的语句的代码。但是，实际在橙色块结束后，\",[\"$\",\"code\",\"code-5\",{\"children\":\"hasConflict\"}],[\"$\",\"strong\",\"strong-0\",{\"children\":[\"被改成了\",[\"$\",\"code\",\"code-0\",{\"children\":\"false\"}]]}],\"，所以最终并没有进入\",[\"$\",\"code\",\"code-6\",{\"children\":\"MergeCreate\"}],\"，最终的结果就是一个普通的\",[\"$\",\"code\",\"code-7\",{\"children\":\"INSERT INTO\"}],\" SQL。那么也就是说，橙色这段代码就是罪魁祸首！\"]}],\"\\n\",[\"$\",\"p\",\"p-64\",{\"children\":[\"这段代码干了什么事情呢？简单来说，它会检查要插入的行中的各个列中有没有包含主键。如果没有设置主键，则将会把\",[\"$\",\"code\",\"code-0\",{\"children\":\"hasConflict\"}],\"改为\",[\"$\",\"code\",\"code-1\",{\"children\":\"false\"}],\"；而如何设置了主键，才会进入\",[\"$\",\"code\",\"code-2\",{\"children\":\"MERGE INTO\"}],\"流程。回想前面，要想正确生成upsert行为，我们需要判断\",[\"$\",\"strong\",\"strong-0\",{\"children\":\"一行是否存在\"}],\"。而很显然，这里的代码将\",[\"$\",\"strong\",\"strong-1\",{\"children\":\"一行是否存在\"}],\"的判断标准等价为了主键是否存在，而忽略了其他具有的\",[\"$\",\"code\",\"code-3\",{\"children\":\"unique index\"}],\"的列。\"]}],\"\\n\",[\"$\",\"p\",\"p-65\",{\"children\":[\"当然，其他人也发现了这个问题，gorm-sqlserver的仓库中也有\",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/go-gorm/sqlserver/issues/100\",\"children\":\"已经半年前打开的issue\"}],\"正好就是关于这个问题。而很遗憾，这个问题过了半年依然没有修复。\"]}],\"\\n\",[\"$\",\"p\",\"p-66\",{\"children\":[\"要想解决这个问题，有多种方法，而我最终选择了最简单粗暴的方法：不管！这个函数的目的是同时插入多个\",[\"$\",\"code\",\"code-0\",{\"children\":\"Heartbeatt\"}],\"，那我们就手动一个一个插入，如果一个行插入失败了，我们简单判断一下，如果这个错误是因为hash重复造成了，那我们就不管了！检查了一下代码中调用这个方法的场景，其实大多数情况下都是只插入一行，所以这样写对性能造成的影响是可以接受的。\"]}],\"\\n\",[\"$\",\"figure\",\"figure-24\",{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",\"pre-0\",{\"style\":{\"backgroundColor\":\"#282c34\",\"color\":\"#abb2bf\"},\"tabIndex\":0,\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"children\":[\"$\",\"code\",\"code-0\",{\"data-language\":\"go\",\"data-theme\":\"one-dark-pro\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",\"span-0\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/repositories/heartbeat.go#L34\"}]}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"if\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" r\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"db\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"Dialector\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Name\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"() \"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\"==\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" (\"}],[\"$\",\"span\",\"span-11\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"sqlserver\"}],[\"$\",\"span\",\"span-12\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-13\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\"Dialector\"}],[\"$\",\"span\",\"span-14\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"{}).\"}],[\"$\",\"span\",\"span-15\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Name\"}],[\"$\",\"span\",\"span-16\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"() {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-2\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"  for\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" _\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\", \"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"h\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" :=\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\" range\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" heartbeats\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-3\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"    err\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E5C07B\"},\"children\":\" :=\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" r\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"db\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Create\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"h\"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\").\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"Error\"}]]}],\"\\n\",[\"$\",\"span\",\"span-4\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"    if\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" err\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#56B6C2\"},\"children\":\" !=\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\" nil\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-5\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"      if\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" strings\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-3\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Contains\"}],[\"$\",\"span\",\"span-4\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(\"}],[\"$\",\"span\",\"span-5\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\"err\"}],[\"$\",\"span\",\"span-6\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\".\"}],[\"$\",\"span\",\"span-7\",{\"style\":{\"color\":\"#61AFEF\"},\"children\":\"Error\"}],[\"$\",\"span\",\"span-8\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"(), \"}],[\"$\",\"span\",\"span-9\",{\"style\":{\"color\":\"#98C379\"},\"children\":\"\\\"Cannot insert duplicate key row in object 'dbo.heartbeats' with unique index 'idx_heartbeats_hash'\\\"\"}],[\"$\",\"span\",\"span-10\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\") {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-6\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#7F848E\",\"fontStyle\":\"italic\"},\"children\":\"        // ignored\"}]}],\"\\n\",[\"$\",\"span\",\"span-7\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"      } \"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"else\"}],[\"$\",\"span\",\"span-2\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",\"span-8\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"        return\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#E06C75\"},\"children\":\" err\"}]]}],\"\\n\",[\"$\",\"span\",\"span-9\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"      }\"}]}],\"\\n\",[\"$\",\"span\",\"span-10\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"    }\"}]}],\"\\n\",[\"$\",\"span\",\"span-11\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"  }\"}]}],\"\\n\",[\"$\",\"span\",\"span-12\",{\"data-line\":\"\",\"children\":[[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#C678DD\"},\"children\":\"  return\"}],[\"$\",\"span\",\"span-1\",{\"style\":{\"color\":\"#D19A66\"},\"children\":\" nil\"}]]}],\"\\n\",[\"$\",\"span\",\"span-13\",{\"data-line\":\"\",\"children\":[\"$\",\"span\",\"span-0\",{\"style\":{\"color\":\"#ABB2BF\"},\"children\":\"}\"}]}]]}]}]}],\"\\n\",[\"$\",\"h1\",\"h1-2\",{\"id\":\"总算还是完成了\",\"children\":[[\"$\",\"a\",\"总算还是完成了\",{\"href\":\"#总算还是完成了\",\"className\":\"mr-1\",\"children\":[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 512 512\",\"className\":\"inline-block opacity-20 hover:opacity-60\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"$2a\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":16,\"width\":16,\"xmlns\":\"http://www.w3.org/2000/svg\"}]}],\"总算还是完成了\"]}],\"\\n\",[\"$\",\"p\",\"p-67\",{\"children\":\"终于，经过了一周的时间，本来以为只是一个简单的调库，结果却发现了这么多的问题。经过这个过程，之前连SQL Server用都没用过的我也知道了很多SQL Server的细节；之前没有接触过gorm，现在却连源代码都好好翻了一通。\"}],\"\\n\",[\"$\",\"p\",\"p-68\",{\"children\":[\"而关于go，虽然我一直不喜欢go的语法，觉得它太简单，类型系统太弱，很多代码都花在固定的模板代码上（比如\",[\"$\",\"code\",\"code-0\",{\"children\":\"if err := nil\"}],\"），但是不得不承认的一点是，go确实非常的\",[\"$\",\"strong\",\"strong-0\",{\"children\":\"explicit\"}],\"。没那么多乱七八糟的反射、运行时黑魔法，控制流非常清晰，想知道什么代码调用了一个方法，直接\",[\"$\",\"code\",\"code-1\",{\"children\":\"Shift+F12\"}],\"就完事了，出来的结果不会多不会少；要想某个错误是在哪里处理的，跟着繁琐的错误处理代码总能找到。它确实缺少一些特性，但是它非常地工业化。\"]}],\"\\n\",[\"$\",\"p\",\"p-69\",{\"children\":\"解决这些问题后，PR顺利合并进了主分支，成就感满满，这可能也是我第一个没那么简单的开源项目的贡献了。\"}],\"\\n\",[\"$\",\"p\",\"p-70\",{\"children\":\"$L2b\"}],\"\\n\",[\"$\",\"p\",\"p-71\",{\"children\":\"对我来说，设定一个目标是学习的最好的途径，在这次实践里再次得到了印证。\"}]]}]]}],[\"$\",\"div\",null,{\"className\":\"hidden lg:block lg:w-[25%]\",\"children\":[\"$\",\"$L2c\",null,{\"toc\":[{\"depth\":1,\"value\":\"不就是调库嘛……\",\"id\":\"不就是调库嘛\"},{\"depth\":1,\"value\":\"遇到并解决一个一个一个的问题\",\"id\":\"遇到并解决一个一个一个的问题\",\"children\":[{\"depth\":2,\"value\":\"SQL语句\",\"id\":\"sql语句\"},{\"depth\":2,\"value\":\"SQL语句片段\",\"id\":\"sql语句片段\"},{\"depth\":2,\"value\":\"重用Dialector的逻辑，为关键词加上引号\",\"id\":\"重用dialector的逻辑为关键词加上引号\"},{\"depth\":2,\"value\":\"重写不支持的功能\",\"id\":\"重写不支持的功能\"},{\"depth\":2,\"value\":\"把同一个go类型在不同的数据库中映射为不同的列类型\",\"id\":\"把同一个go类型在不同的数据库中映射为不同的列类型\"},{\"depth\":2,\"value\":\"避免创建递归的级联修改外键约束\",\"id\":\"避免创建递归的级联修改外键约束\"},{\"depth\":2,\"value\":\"规避gorm sqlserver的bug\",\"id\":\"规避gorm-sqlserver的bug\"}]},{\"depth\":1,\"value\":\"总算还是完成了\",\"id\":\"总算还是完成了\"}],\"hasSummary\":true}]}]]}]\n"])</script><script>self.__next_f.push([1,"b:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"9:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"从调库到翻源代码：给wakapi增加SQL Server支持 - ddadaal.me\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"ddadaal's personal website\"}],[\"$\",\"link\",\"3\",{\"rel\":\"manifest\",\"href\":\"/site.webmanifest\",\"crossOrigin\":\"$undefined\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}],[\"$\",\"link\",\"5\",{\"rel\":\"icon\",\"href\":\"/icon.svg?35be8e76be1c3618\",\"type\":\"image/svg+xml\",\"sizes\":\"any\"}],[\"$\",\"link\",\"6\",{\"rel\":\"apple-touch-icon\",\"href\":\"/apple-icon.png?5334a64f42000bb0\",\"type\":\"image/png\",\"sizes\":\"180x180\"}]]\n"])</script><script>self.__next_f.push([1,"7:null\n"])</script><script>self.__next_f.push([1,"2d:I[51,[\"116\",\"static/chunks/c556396d-6bde9789d0a41114.js\",\"413\",\"static/chunks/7a1bdfe6-8f7609c25899d936.js\",\"994\",\"static/chunks/c4aeae87-2a85323a0275cbf9.js\",\"786\",\"static/chunks/1b3e99d6-50521588821d44ca.js\",\"845\",\"static/chunks/845-a0203995fac91684.js\",\"57\",\"static/chunks/57-3951d65188499c8f.js\",\"826\",\"static/chunks/826-c44bffd752ec02cd.js\",\"467\",\"static/chunks/467-ff6f7f0e9f0462a7.js\",\"971\",\"static/chunks/app/articles/%5B%5B...params%5D%5D/page-59c8401fd7fff2e0.js\"],\"ArticleImage\"]\n24:[\"$\",\"$L2d\",\"img-0\",{\"src\":\"/articles/asset/contents/20240117-support-sqlserver-in-wakapi/copilot.png\",\"imageSize\":{\"height\":1540,\"width\":1056},\"imageProps\":{\"src\":\"./copilot.png\",\"alt\":\"copilot的结果\"}}]\n27:[\"$\",\"$L2d\",\"img-0\",{\"src\":\"/articles/asset/contents/20240117-support-sqlserver-in-wakapi/foreign-keys.png\",\"imageSize\":{\"height\":637,\"width\":1499},\"imageProps\":{\"src\":\"./foreign-keys.png\",\"alt\":\"通过Azure Data Studio查看具体的错误信息\"}}]\n29:[\"$\",\"$L2d\",\"img-0\",{\"src\":\"/articles/asset/contents/20240117-support-sqlserver-in-wakapi/sqlserver-adapter.png\",\"imageSize\":{\"height\":1025,\"width\":2252},\"imageProps\":{\"src\":\"./sqlserver-adapter.png\",\"alt\":\"查找到可能出现bug的位置\"}}]\n2b:[\"$\",\"$L2d\",\"img-0\",{\"src\":\"/articles/asset/contents/20240117-support-sqlserver-in-wakapi/pr-merged.png\",\"imageSize\":{\"height\":1882,\"width\":2429},\"imageProps\":{\"src\":\"./pr-merged.png\",\"alt\":\"https://github.com/muety/wakapi/pull/592\"}}]\n"])</script></body></html>