1:"$Sreact.fragment"
2:I[28979,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"ArticleFrontmatter"]
c:I[21753,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"ArticleSummarization"]
d:I[79817,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"Gallery"]
7e:I[23491,["/_next/static/chunks/2caa33a942c5f527.js","/_next/static/chunks/59983278a34fd25c.js"],"OutletBoundary"]
7f:"$Sreact.suspense"
92:I[72053,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"ArticleImage"]
aa:I[14620,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"ArticleToc"]
ab:I[39182,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"RelatedArticles"]
ac:I[42449,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"CommentPanelWithCurrentLanguage"]
:HL["/_next/static/chunks/44d2e091595b3eca.css","style"]
:HL["/_next/static/chunks/5e55d74f3211c796.css","style"]
:HL["/_next/static/chunks/b59bad6ea4f112f2.css","style"]
3:T7bca,
# 不就是调库嘛……

在[上一篇文章](/articles/added-blog-page-click-monitoring)中，我给博客增加了点击量监测，并将这个服务部署到了Azure，数据库采用了使用SQL Server的Azure的SQL服务。由于SQL Server有免费的订阅，微软的Azure Data Studio也还算好用，于是我觉得可以重用一下刚才学习的这个技能，将其他的服务也使用SQL Server部署。

我之前在用[wakatime](https://wakatime.com/)来记录我的编程的数据（例如每天的编程时间、所使用的编程语言等），但是wakatime免费用户只能保存14天的数据，而且wakatime没有提供官方的可自己部署的后端，所以我也一直在寻找wakatime的替代品。之前尝试使用了一段时间的[codetime](https://codetime.dev/)。这个软件的功能和wakatime类似，但是它当前只支持VSCode客户端，虽然免费保存数据，但是仍然没有提供可自己部署的后端。我在很早之前也尝试找过wakatime的后端替代品，但是当时并没有找到一个能用的。但前不久，同学给我推荐了[wakapi](https://www.wakapi.com/)项目，这个项目重新实现了wakatime的后端API，这样wakatime的丰富的客户端插件可以直接使用，并且完全可以自己部署，不用担心数据并存放在别人的服务器上。

它就是我一直寻找的wakatime替代品！

很激动地浏览了一下项目，看到wakapi当时并没有原生支持SQL Server，但是在README中提到，wakatime使用了[gorm](https://gorm.io)作为数据库访问框架，而gorm本身是[支持SQL Server](https://github.com/go-gorm/sqlserver)的。

我想，既然库都支持了，SQL Server支持有什么难的？引入`gorm.io/sqlserver`包，引入创建一个`Dialector`，用gorm的API编写的绝大多数数据库操作就完成了。

```go
sqlserver.Open(mssqlConnectionString(c))
```

这有什么难的，开跑！结果遇到了一大堆报错。

# 遇到并解决一个一个一个的问题

## SQL语句

仔细一看，这些报错主要是来自于数据库migration中的原生SQL语句和片段。

程序启动的时候，会运行数据库migration脚本。随着软件开发更多的新功能，其使用的数据库的结构总会发生变化，而migration是指一些代码，这些代码的作用是修改数据库schema、让schema满足当前版本的要求。当软件功能越来越多，对数据库的变化也就越来越多，所以在一个成熟的软件中，你常常会看到有很多的数据库migration的代码。在程序启动的时候，这些migration将会被一个一个地执行，使得程序正式开始时，数据库的schema也更新到最新。

```bash
> tree migrations
migrations
├── 20201103_rename_language_mappings_table.go
├── 20201106_migration_cascade_constraints.go
├── 20210202_fix_cascade_for_alias_user_constraint.go
├── 20210206_drop_badges_column_add_sharing_flags.go
├── 20210213_add_has_data_field.go
├── 20210221_add_created_date_column.go
├── 20210411_add_imprint_content.go
├── 20210411_drop_migrations_table.go
├── 20210806_remove_persisted_project_labels.go

```

而有的migration（尤其是自动生成的migration）很可能包含了一些原生SQL。同时，由于ORM是对数据库操作的抽象，而再强大的抽象也不如原生的SQL来得强大和方便，所以很多时候，开发者仍然会选择在一些地方使用原生SQL语句的片段或者语句来实现一些功能。虽然SQL本身是有标准的，但是各个数据库厂商实际上自己实现了很多新功能，很多时候我们本以为理所当然的功能，实际上并不在标准中，而是数据库厂商自己实现的，一旦手写SQL而没有意识到有的SQL实际上只在部分数据库中兼容，就可能会在不兼容的数据库中遇到问题。

举个例子，wakapi的某个版本需要在数据库的`users`表中新增一个`has_data`列，而对于已经存在的`users`表中的数据，这个列需要被设置为`TRUE`。代码中用于执行此次migration的代码使用如下SQL语句实现了这个功能：

```sql
UPDATE users SET has_data = TRUE WHERE TRUE;
```

看上去是个很简单的人畜无害的SQL语句，对吧？但是这个SQL语句在mssql中中是非法的，因为mssql中并没有`TRUE`, `FALSE`常量！sqlserver中没有`boolean`类型，所有这些类型都是使用一个字节的`tinyint`来表示的，而`TRUE`和`FALSE`就对应使用`1`和`0`来表示。但是，`1`和`0`在sql server中并不是一个合法的`boolean`表达式，所以它们并不能直接用在`WHERE`中。所以，在MSSQL中，以上SQL语句就必须重新成以下的样子：

```sql
UPDATE users SET has_data = 1;
```

## SQL语句片段

另一个情况是**SQL语句片段**。虽然ORM的一大作用就是将软件代码映射为SQL语句，减少我们手写SQL可能带来的错误，但是为了实现的灵活性，ORM常常同样也允许在自己的API中编写一些SQL的片段，而ORM会尝试将这些SQL片段嵌入进去。但是这些SQL片段可能也会有不兼容的情况！例如，下面的代码

```go
result := db.Table("summaries AS s1").
			Where("s1.id IN ?", faultyIds).
			Update("num_heartbeats", "3")
```

上述gorm数据库仓库将会被映射为类型以下的SQL语句。注意`Table`和`Where`方法的参数与下列SQL语句中对应的语句的对应关系。

```sql
update summaries AS s1 set num_heartbeats = 3 where s1.id IN ?
```

是不是感觉很简单？但是MSSQL仍然不支持！MSSQL不支持在`update`持语句中给表新增一个别名，所以以上SQL语句中的`AS s1`必须被去掉。

## 重用Dialector的逻辑，为关键词加上引号

再看一个SQL语句片段：

```go
r.db.Model(&models.User{}).Select("users.id as user, max(time) as time").
```

这段SQL语句一般会被映射为：

```sql
select users.id as user, max(time) as time from users;
```

有问题吗？有！`user`在MSSQL中是关键词，要作为标识符使用必须使用`""`或者`[]`将它包裹起来！而`user`在mysql等数据库引擎中都不是关键词，因此可以随意直接使用。

这个将关键词作为字符串使用的过程实际上编程中很常见，被称为`escape`，或者更简单的叫`quote`，加引号。但是更坑的是，不同的SQL引擎所使用的加引号的方法不一样。MSSQL使用的是`""`或者`[]`，但是mysql使用的是`。如何通过一段代码来为不同的数据库加上正确的引号呢？

其实，这个加引号的过程实在是非常常见，只要ORM需要将程序员所写的名字（表名、列名等）映射到SQL，那么就需要考虑给这些名字叫上引号，防止这些名字和SQL自己的关键词冲突。如果你写一个名字叫`select`的表，没有这段逻辑，那么这个表就没法通过ORM来映射成SQL了！

因此，根据Don't Repeat Yourself原则，ORM为数据库系统的适配器中肯定会有对应的逻辑。而我们与其自己编写这个处理逻辑，最好的方法当然是调用适配器中已经写好的逻辑了。

gorm使用`Dialector`接口作为ORM支持不同数据库系统的适配器的接口，所有gorm支持的数据库都有一个对应的实现了`Dialector`接口的`Dialector`。所以，第一步就是去看看gorm的`Dialector`里定义了哪些接口。

```go {9}
// https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/interfaces.go#L12C1-L21C2
type Dialector interface {
	Name() string
	Initialize(*DB) error
	Migrator(db *DB) Migrator
	DataTypeOf(*schema.Field) string
	DefaultValueOf(*schema.Field) clause.Expression
	BindVarTo(writer clause.Writer, stmt *Statement, v interface{})
	QuoteTo(clause.Writer, string)
	Explain(sql string, vars ...interface{}) string
}
```

从名字判断，这个`QuoteTo`方法似乎就是我们要的接口。再随便点开一个dialector实现的代码浏览一下，就能确定，`QuoteTo`就是加引号的方法。

可是这个方法看上去和我们想象中的不太一样：我们预期这个功能是一个`(string) => string`的函数，这里怎么是一个`(clause.Writer, string) => void`的函数，这个`clause.Writer`是什么玩意？

由于拼接SQL说到底，就是要生成各个SQL的片段，然后将这些片段的字符串拼接起来。在绝大多数编程语言里，`string`都是不可变的，所以拼接字符串实际上是创建了第三个字符串，然后把两个字符串的内容复制进去。这个过程如果进行太多次，就非常浪费时间和内存。所以编程语言常常会提供一个**组装字符串的工具类**。这个工具类可以理解成是一个**可变**的字符串，你可以直接在这个_字符串_的后面增加新的字符串，而不需要每次操作都创建一个全新的字符串对象。而这个`Writer`接口，就是gorm定义的一个这样的能够**组装字符串的工具类**所需要实现的接口。这个`Writer`接口定义如下：

```go
// https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/clause/clause.go#L13
type Writer interface {
	WriteByte(byte) error
	WriteString(string) (int, error)
}
```

很简单，很直白：`WriteByte`：在后面增加一个字符；`WriteString`，在后面增加一个字符串。

熟悉Go的同学可能会说了：啊，这个接口看上去非常熟悉，原生的`strings.Builder`就是用来做这个事情的，而且也有这两个方法！是不是可以直接用一个`strings.Builder`来作为这个`clause.Writer`？

正确！所以我们可以直接创建一个`*strings.Builder`来作为`clause.Writer`（用指针的原因是这个`strings.Builder`的这两个成员方法是使用的指针接收者而不是值接收者，所以只有对应的指针类型才算实现了这个接口。具体关于指针接收者和值接收者的区别我们就不在这里介绍了，有兴趣的可以学习一下Go语言），并在调用后获取这个`builder`最终的字符串，这样就直接调用了`dialector`中实现了加引号逻辑。

```go
func QuoteDbIdentifier(db *gorm.DB, identifier string) string {
	builder := &strings.Builder{}
	db.Dialector.QuoteTo(builder, identifier)
	return builder.String()
}
```

然后，我们将此函数用在所有需要在SQL片段中使用自定义的名字的地方，这样，我们就重用了dialector的逻辑，用同一套代码兼容了所有的数据库。

```go {2}
r.db.Model(&models.User{}).Select(
  fmt.Sprintf("users.id as %s, max(time) as time"), utils.QuoteDbIndentifier(r.db, "user")
)
```

## 重写不支持的功能

而在进一步查找并修改原生SQL的语句中，我找到了一段如下的原生SQL语句，直接让我眼前一黑。

```sql
with projects as (
			select project, user_id, min(time) as first, max(time) as last, count(*) as cnt
			from heartbeats
			where user_id = ? and project != ''
			and time between ? and ?
			and language is not null and language != '' and project != ''
			group by project, user_id
			order by last desc
			limit ? offset ? )
select distinct project, min(first) as first, min(last) as last, min(cnt) as count, first_value(language) over (partition by project order by count(*) desc) as top_language
			from heartbeats
			inner join projects using (project, user_id)
			group by project, language
			order by last desc
```

这段SQL语句就这样赤裸裸地写在代码里。经过以上几个例子，是不是以为这个SQL在MSSQL中必定问题巨大，不重新写一份根本跑不起来？

我一开始也是这么想的。而我自己对SQL Server并没有那么熟悉，所以聪明的我，在给一些名字叫上引号后，直接把这段代码扔给了GitHub Copilot，让它帮我改成SQL Server能用的。反直觉的是，这段代码实际上问题没那么大：

![copilot的结果](./copilot.png)

具体来说，除了第三点去掉了不需要的引号后，有两个问题：

1. 不支持`join using`，需要使用常规的`join on`代替
2. 不支持`limit offset`。查找了一下，mssql可以使用`offset ? ROWS fetch next ? rows only`来代替，当然`limit`和`offset`的参数顺序是反过来的

啊，原来这么简单！由于需要修改的地方并不多，于是我就简单的通过if判断，将其中SQL Server不兼容的部分修改为SQL Server兼容的SQL语句，这段SQL语句也就完成了。

## 把同一个go类型在不同的数据库中映射为不同的列类型

修改了这些SQL语句后，程序仍然运行不起来，仔细一看，报错如下：

```
mssql: A table can only have one timestamp. Because table 'users' already has one, the column 'last_logged_in_at' cannot be added.
```

简单翻译，一个表只能有一个类型为`timestamp`的列，而`users`中有多个列都是`timestamp`的类型，所以SQL Server报错了。

去代码中一看，`users`表对应的`User`struct确实有好几个字段都通过[gorm的field tag功能](https://gorm.io/docs/models.html#Fields-Tags)`type:timestamp`，确定了在数据库中这些列需要映射为`timestamp`类型。

```go /timestamp/
// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/user.go#L17
type User struct {
  // ...
  CreatedAt           CustomTime  `gorm:"type:timestamp; default:CURRENT_TIMESTAMP" swaggertype:"string" format:"date" example:"2006-01-02 15:04:05.000"`
	LastLoggedInAt      CustomTime  `gorm:"type:timestamp; default:CURRENT_TIMESTAMP" swaggertype:"string" format:"date" example:"2006-01-02 15:04:05.000"`
  // ...
  SubscribedUntil     *CustomTime `json:"-" gorm:"type:timestamp" swaggertype:"string" format:"date" example:"2006-01-02 15:04:05.000"`
	SubscriptionRenewal *CustomTime `json:"-" gorm:"type:timestamp" swaggertype:"string" format:"date" example:"2006-01-02 15:04:05.000"`
}
```

`timestamp`有什么问题呢？MySQL不都是使用`timestamp`来代表时间类型吗？去查找`sql server timestamp`，我才发现，SQL Server里的`timestamp`的含义和别的数据库中的含义不一样。在别的数据库中，`timestamp`就是一个表示时间戳/时间点的类型，而根据[这个stackoverflow回答](https://stackoverflow.com/a/12063938)，`sql server`中的`timestamp`主要用于乐观锁的情况（具体不在这里阐述），只是用来标记本行上一次被修改的时间，所以每个表只能存在一个`timestamp`的列。而在SQL Server中如果要表示一个时间戳，需要使用`datetimeoffset`。

所以现在问题就变成了：**如何将一个类型在不同的数据库中映射为不同的列的类型**。

`type:timestamp`这个tag肯定是不能用了，于是我们就需要查找有没有其他更动态的方法，可以自定义一个go字段映射到数据库中的类型。经过一番查找，我们找到了[Customize Data Type](https://gorm.io/docs/data_types.html#GormDataTypeInterface)功能。gorm允许定义一个自定义的`struct`，并给这个`struct`实现`GormDBDataTypeInterface`接口，来返回这个类型的字段所真正对应的数据库类型。

```go
type GormDBDataTypeInterface interface {
  GormDBDataType(*gorm.DB, *schema.Field) string
}
```
这个函数的第一个参数就是`gorm.DB`对象，指向当前操作的数据库对象，可以获取到当前正在使用什么类型的`Dialector`，我们就可以根据`Dialector`类型，来输出对应的数据库列类型。另外，这个`CustomTime`正好是代码中所定义的一个新的`struct`，我们可以直接在`CustomTime`上实现这个接口。

看来比较简单，但是为了以防万一，我们再全局搜索一下`type:timestamp`，看看有没有什么其他的用法。果然被我找到了！

```go /timestamp(3)/
// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/heartbeat.go#L27
type Heartbeat struct {
  // ...
  Time            CustomTime `json:"time" gorm:"type:timestamp(3); index:idx_time; index:idx_time_user" swaggertype:"primitive,number"`
  // ...
}
```

这里用到了`timestamp(3)`。根据[mysql的文档](https://dev.mysql.com/doc/refman/8.0/en/fractional-seconds.html)，`timestamp(n)`中的`n`是代表精确到秒后面的第几位浮点位，`3`代表精确到毫秒，而`6`代表精确到微秒。而SQL Server的`datetimeoffset`也支持类似的标记（[文档](https://learn.microsoft.com/en-us/sql/t-sql/data-types/datetimeoffset-transact-sql?view=sql-server-ver16)），`datetimeoffset(n)`中的`n`也同样表示精确到秒后面的第几位浮点位。由于我们不能直接使用`type`tag，但是我们还需要一个tag用来表示这个精确的位数（根据sql server的文档，将这个位数称为`scale`），所以，我们可以定义一个全新的`timeScale`的tag，其值就是`scale`的值。而一个字段上具体有哪些tag，正好可以通过`GormDBDataType`的第二个参数获取。

于是根据这个思路，我们实现了`CustomTime`的`GormDBDataType`方法：

```go
// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/shared.go#L44
func (j CustomTime) GormDBDataType(db *gorm.DB, field *schema.Field) string {

	t := "timestamp"

  // 如果使用的是SQL Server Dialector，则将其类型设置为datetimeoffset
	if db.Config.Dialector.Name() == (sqlserver.Dialector{}).Name() {
		t = "datetimeoffset"
	}

  // 如果一个属性有TIMESCALE的tag，那么给类型后面增加(n)参数
  // gorm将所有gorm下的tag的key转换成了全大写
  // 参考：https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/schema/utils.go#L35
	if scale, ok := field.TagSettings["TIMESCALE"]; ok {
		t += fmt.Sprintf("(%s)", scale)
	}

	return t
}
```

同时，我们将所有的`timestamp`都直接去掉，将`type:timestamp(n)`修改为了`timeScale:n`：

```go /timeScale:3/
// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/user.go#L17
type User struct {
  // ...
  CreatedAt           CustomTime  `gorm:"default:CURRENT_TIMESTAMP" swaggertype:"string" format:"date" example:"2006-01-02 15:04:05.000"`
  LastLoggedInAt      CustomTime  `gorm:"default:CURRENT_TIMESTAMP" swaggertype:"string" format:"date" example:"2006-01-02 15:04:05.000"`
  // ...
  SubscribedUntil     *CustomTime `json:"-" swaggertype:"string" format:"date" example:"2006-01-02 15:04:05.000"`
  SubscriptionRenewal *CustomTime `json:"-" swaggertype:"string" format:"date" example:"2006-01-02 15:04:05.000"`
}

// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/heartbeat.go#L12
type Heartbeat struct {
  // ...
  Time            CustomTime `json:"time" gorm:"timeScale:3; index:idx_time; index:idx_time_user" swaggertype:"primitive,number"`
  // ...
}
```

这样就解决了这个问题。

## 避免创建递归的级联修改外键约束

没想到的是，到这里仍然无法启动程序。报错如下：

``` {3}
[2.938ms] [rows:0] CREATE TABLE "summary_items" ("id" bigint IDENTITY(1,1),"summary_id" bigint,"type" smallint,"key" nvarchar(255),"total" bigint,PRIMARY KEY ("id"),CONSTRAINT "fk_summaries_editors" FOREIGN KEY ("summary_id") REFERENCES "summaries"("id") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT "fk_summaries_operating_systems" FOREIGN KEY ("summary_id") REFERENCES "summaries"("id") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT "fk_summaries_machines" FOREIGN KEY ("summary_id") REFERENCES "summaries"("id") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT "fk_summaries_projects" FOREIGN KEY ("summary_id") REFERENCES "summaries"("id") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT "fk_summaries_languages" FOREIGN KEY ("summary_id") REFERENCES "summaries"("id") ON DELETE CASCADE ON UPDATE CASCADE)
2024-01-19T19:29:35.607826413+08:00 [ERROR] mssql: Could not create constraint or index. See previous errors.
panic: mssql: Could not create constraint or index. See previous errors.
```

`Could not create constraint or index. See previous errors.`这个等于什么都没说嘛，只知道创建一个外键约束或者索引的时候失败了，而其他的错误信息被gorm或者gorm的sqlserver dialector忽略了。还

还好我能看到具体执行的SQL语句，所以我们可以把这段SQL语句手动输入到Azure Data Studio中，看看数据库引擎到底报了什么错误。

![通过Azure Data Studio查看具体的错误信息](./foreign-keys.png)

> Introducing FOREIGN KEY constraint 'fk_summaries_operating_systems' on table 'summary_items' may cause cycles or multiple cascade paths. Specify ON DELETE NO ACTION or ON UPDATE NO ACTION, or modify other FOREIGN KEY constraints.

看起来，是因为`fk_summaries_operating_systems`这个级联的外键索引会造成级联递归（cycles）。和外键约束有关，而外键约束是通过gorm定义，所以我们先去看看代码里涉及这个外键约束的两个表的定义。

```go /constraint:OnUpdate:CASCADE,OnDelete:CASCADE/
// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/summary.go#L29
type Summary struct {
  // ...
	Projects         SummaryItems `json:"projects" gorm:"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"`
	Languages        SummaryItems `json:"languages" gorm:"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"`
	Editors          SummaryItems `json:"editors" gorm:"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"`
	OperatingSystems SummaryItems `json:"operating_systems" gorm:"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"`
	Machines         SummaryItems `json:"machines" gorm:"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"`
}

type SummaryItems []*SummaryItem

type SummaryItem struct {
  // ...
	Summary   *Summary      `json:"-" gorm:"not null; constraint:OnUpdate:CASCADE,OnDelete:CASCADE"`
	SummaryID uint          `json:"-" gorm:"size:32"`
}
```

也就是说，`Summary`和`SummaryItem`两个表是1:m的关系，这个关系映射到数据库中，也就是`SummaryItem`表中有到`Summary`的ID的外键`summary_id`，而这个外键的约束则是通过`Summary`表中的tag定义的。

转回头去看生成的SQL，生成的SQL里有**5**个完全相同的外键（`fk_summaries_editors`, `fk_summaries_operating_systems`，`fk_summaries_machines`，`fk_summaries_projects`和`fk_summaries_languages`）。由于这五个外键都是级联删除（`ON DELETE CASCADE`）和级联更新（`ON UPDATE CASCADE`），实际上确实是会存在一个级联递归：当一个`SummaryItem`被删除，会造成其对应的`Summary`被删除，而`Summary`被删除可能会造成这个`SummaryItem`也被删除。

那问题又来了，那为什么之前在MySQL、PostgresSQL等数据库里均正常呢？通过[这篇Stack Overflow](https://stackoverflow.com/a/852047)的回答，我们知道了这种问题在其他数据库中并不是问题：其他数据库会尝试解出一条级联路径出来。而SQL Server不会去尝试解，发现了这种循环，就会直接报错。

那如何解决这个问题呢？根据外键名和`Summary`中的属性的对应关系，我们可以推测，这五个外键是`Summary`中五个引用一一对应过来的。由于这五个外键实际上是一模一样的，只需要保留一个就可以了。所以，最终的解决方案是，只保留一个字段的外键tag，其他字段全部给一个`-`的tag，让gorm不要为这些字段生成外键。

```go {5-8}
// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/summary.go#L30
type Summary struct {
	Projects SummaryItems `json:"projects" gorm:"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"`

	Languages        SummaryItems `json:"languages" gorm:"-"`
	Editors          SummaryItems `json:"editors" gorm:"-"`
	OperatingSystems SummaryItems `json:"operating_systems" gorm:"-"`
	Machines         SummaryItems `json:"machines" gorm:"-"`
}
```

## 规避gorm sqlserver的bug

至此，系统终于能启动起来了，并且大多数功能已经可以正常使用了。而在代码审核过程中，作者还[发现了一个问题](https://github.com/muety/wakapi/pull/592#issuecomment-1892627154)：代码中有一个`Heartbeat`表，它就是wakatime的客户端插件定期给服务器端发送的数据，其中包含了正在工作的项目、使用的编程语言等信息。而这个表中有一个字段为`Hash`，这个字段的值根据其他信息算出来，并且有一个`unique index`，通过这个字段，就避免给`Heartbeat`表插入多个重复的数据。

```go {4}
// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/heartbeat.go#L13
type Heartbeat struct {
  // ...
	Hash            string     `json:"-" gorm:"type:varchar(17); uniqueIndex"`
  // ...
}
```

在插入的时候，作者使用了`ON CONFLICT DO NOTHING`的语句，这个语句的作用就是，如果当插入一行的时候，发现有些行违反了某个`unique index`的要求，则**忽略**这个问题，不插入这一行，也不报错。这刚好非常适合插入有可能有重复的`Heartbeat`的场景。

```go
// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/repositories/heartbeat.go#L52
// 下述代码将会被映射为ON CONFLICT DO NOTHING
if err := r.db.
  Clauses(clause.OnConflict{
    DoNothing: true,
  }).
  Create(&heartbeats).Error; err != nil {
  return err
}
return nil
```

这种行为被称为**插入或者更新**，又被称为**Upsert**（Update/Insert），其行为是一个简单的判断：如果一行已经存在，则更新这一行的内容；如果不存在，则插入这一行。而如何判断**一行是否存在**呢？则是通过`unique index`来判断。

可是遗憾的是，SQL Server不支持`ON CONFLICT DO NOTHING`。要想在SQL Server中模拟upsert的行为，[有很多方式](https://michaeljswart.com/2017/07/sql-server-upsert-patterns-and-antipatterns/)，一个比较常见的方法是使用`merge into`语句。具体如何编写比较复杂，这里就不再具体讲解。

由于这里是使用的gorm的API，并不是使用原生SQL语句，所以理论上来说，gorm是可以知道用户的意图，并根据不同的数据库生成行为相同的、但是兼容对应数据库的SQL语句的。根据[这个issue](https://github.com/go-gorm/sqlserver/issues/47)，gorm的SQL Server库确实在很早之前就尝试通过生成一段的SQL Server兼容的SQL语句来支持这个功能，在gorm的文档里也[提到了](https://gorm.io/docs/create.html#Upsert-x2F-On-Conflict)，`clause.OnConflict`会根据不同的数据库生成不同的语句，而对于SQL Server，其对应生成的正好就是`MERGE INTO`语句。

但是，既然库都支持了，那为什么还会遇到这个错误呢？再次检查所实际执行的SQL，发现这一次`Create`实际上生成的SQL语句仍然是最普通的`INSERT INTO`，并没有不是正确的`MERGE INTO`，。

```SQL /INSERT INTO/
024/01/19 20:10:23 /home/ddadaal/Code/wakapi/repositories/heartbeat.go:54 mssql: Cannot insert duplicate key row in object 'dbo.heartbeats' with unique index 'idx_heartbeats_hash'. The duplicate key value is (d926be93ebcc4b6f).

[10.830ms] [rows:0] INSERT INTO "heartbeats" ("user_id","entity","type","category","project","branch","language","is_write","editor","operating_system","machine","user_agent","time","hash","origin","origin_id","created_at") OUTPUT INSERTED."id" VALUES ('ddadaal','/home/user1/dev/project1/main.go','file','','wakapi','','Go',1,'','','','curl/8.5.0','2024-01-16 02:16:18.954','d926be93ebcc4b6f','','','2024-01-19 20:10:23.378');
```

看来，要想弄明白这个问题，就得进到`gorm`的源码里来查看问题出在哪里了。使用VSCode启动一个调试版本的程序，给上面的代码的位置打上断电，使用`curl`连续插入两次同样的`Heartbeat`，根据断点往内查找，当进入到gorm的sqlserver的适配器的时候的代码的时候，我们发现了一些端倪：

![查找到可能出现bug的位置](./sqlserver-adapter.png)

当前，我们正在图中的`if hasConflict`的位置，且`hasConflict`当前为true。根据下面的一段代码，如果`hasConflict`为`true`的话，将会进入`MergeCreate`函数，而这个函数即是一个在MySQL实现类似行为的SQL的语句的代码。但是，实际在橙色块结束后，`hasConflict`**被改成了`false`**，所以最终并没有进入`MergeCreate`，最终的结果就是一个普通的`INSERT INTO` SQL。那么也就是说，橙色这段代码就是罪魁祸首！

这段代码干了什么事情呢？简单来说，它会检查要插入的行中的各个列中有没有包含主键。如果没有设置主键，则将会把`hasConflict`改为`false`；而如何设置了主键，才会进入`MERGE INTO`流程。回想前面，要想正确生成upsert行为，我们需要判断**一行是否存在**。而很显然，这里的代码将**一行是否存在**的判断标准等价为了主键是否存在，而忽略了其他具有的`unique index`的列。

当然，其他人也发现了这个问题，gorm-sqlserver的仓库中也有[已经半年前打开的issue](https://github.com/go-gorm/sqlserver/issues/100)正好就是关于这个问题。而很遗憾，这个问题过了半年依然没有修复。

要想解决这个问题，有多种方法，而我最终选择了最简单粗暴的方法：不管！这个函数的目的是同时插入多个`Heartbeatt`，那我们就手动一个一个插入，如果一个行插入失败了，我们简单判断一下，如果这个错误是因为hash重复造成了，那我们就不管了！检查了一下代码中调用这个方法的场景，其实大多数情况下都是只插入一行，所以这样写对性能造成的影响是可以接受的。

```go
// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/repositories/heartbeat.go#L34
if r.db.Dialector.Name() == (sqlserver.Dialector{}).Name() {
  for _, h := range heartbeats {
    err := r.db.Create(h).Error
    if err != nil {
      if strings.Contains(err.Error(), "Cannot insert duplicate key row in object 'dbo.heartbeats' with unique index 'idx_heartbeats_hash'") {
        // ignored
      } else {
        return err
      }
    }
  }
  return nil
}
```

# 总算还是完成了

终于，经过了一周的时间，本来以为只是一个简单的调库，结果却发现了这么多的问题。经过这个过程，之前连SQL Server用都没用过的我也知道了很多SQL Server的细节；之前没有接触过gorm，现在却连源代码都好好翻了一通。

而关于go，虽然我一直不喜欢go的语法，觉得它太简单，类型系统太弱，很多代码都花在固定的模板代码上（比如`if err := nil`），但是不得不承认的一点是，go确实非常的**explicit**。没那么多乱七八糟的反射、运行时黑魔法，控制流非常清晰，想知道什么代码调用了一个方法，直接`Shift+F12`就完事了，出来的结果不会多不会少；要想某个错误是在哪里处理的，跟着繁琐的错误处理代码总能找到。它确实缺少一些特性，但是它非常地工业化。

解决这些问题后，PR顺利合并进了主分支，成就感满满，这可能也是我第一个没那么简单的开源项目的贡献了。

![https://github.com/muety/wakapi/pull/592](./pr-merged.png)

对我来说，设定一个目标是学习的最好的途径，在这次实践里再次得到了印证。
0:{"buildId":"xzi-d4iahKgijIV6NUeZU","rsc":["$","$1","c",{"children":[["$","article",null,{"children":[["$","div",null,{"className":"bg-neutral px-4 py-8","children":["$","div",null,{"className":"max-w-7xl mx-auto min-h-[256px] flex justify-center text-center text-neutral-content","children":["$","div",null,{"className":"flex flex-col justify-center animate-slide-up","children":[["$","h1",null,{"className":"text-4xl my-2","children":"从调库到翻源代码：给wakapi增加SQL Server支持"}],["$","$L2",null,{"className":"justify-center","articleId":"support-sqlserver-in-wakapi","info":{"content":"$3","title":"从调库到翻源代码：给wakapi增加SQL Server支持","date":"2024-01-17 22:58","id":"support-sqlserver-in-wakapi","lang":"cn","tags":["project","problem-investigation"],"wordCount":6636,"readingTime":33.18,"filePath":"contents/20240117-support-sqlserver-in-wakapi/cn.md","summary":{"articleId":"support-sqlserver-in-wakapi","lang":"cn","hash":"2894ee61840e2353f94fdd29fb81283beca5354b54bd7435b9453fdffcf7c88e","summaries":[{"metadata":{"summarizer":"azure-ai","model":"DeepSeek-R1"},"summaries":["作者在尝试将Wakapi项目迁移至SQL Server时，遇到一系列数据库适配问题。包括SQL语法差异、ORM框架配置、外键约束冲突及GORM库的Upsert功能缺陷。通过修改原生SQL语句、动态调整时间字段类型映射、重构外键关系、手动处理唯一索引冲突，最终解决兼容性问题并成功合并代码。此次实践深入了解了SQL Server特性与GORM内部机制，验证了通过实际项目攻坚学习技术的有效性。"],"startTime":"2025-02-14T13:43:38.671Z","endTime":"2025-02-14T13:44:02.939Z"},{"metadata":{"summarizer":"ollama","model":"deepseek-r1:8b"},"summaries":["在解决这个问题时，我逐步发现了许多关于 SQL Server 和 GORM 的细节，并通过手动处理重复插入的问题，最终完成了任务。尽管遇到了一些挑战，但过程让我对 Go 语言和开源项目贡献有了更深的理解。\n\n**主要步骤：**\n\n1. **问题识别**：在尝试使用 GORM 插入数据时，遇到了重复主键错误。\n2. **调试与分析**：通过调试工具追踪到 GORM 的 SQL Server 适配器，发现了可能的 bug。\n3. **手动处理**：在没有修复适配器的情况下，选择手动逐个插入数据，跳过重复的记录。\n4. **学习与反思**：深入了解了 Go 语言的明确性和错误处理机制，同时也认识到 SQL Server 的特性。\n\n通过这次经历，我不仅解决了问题，还提升了对开发工具和开源项目贡献的理解。最终，我的Pull Request得到了合并，这让我感到成就感和满足。\n\n**结果：**\n\n- **问题解决**：成功将数据插入 SQL Server，无重复记录错误。\n- **技能提升**：加深了对 Go 语言和 GORM 的理解，掌握了调试技巧。\n- **贡献体验**：第一次在大型开源项目中参与问题解决，增强了解决问题的信心。\n\n这次经历让我更加明确地认识到学习的重要性，不管是技术上的还是工具使用方面，都需要持续探索和实践。"]}]}},"langVersions":["cn"]}]]}]}]}],"$L4"]}],["$L5","$L6","$L7","$L8","$L9","$La"],"$Lb"]}],"loading":null,"isPartial":false}
e:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z4:["$","div",null,{"className":"animate-slide-up","children":[["$","div",null,{"className":"max-w-7xl mx-auto p-4","children":["$","div",null,{"className":"flex flex-row space-x-4","children":[["$","div",null,{"className":"prose max-w-full lg:w-[75%]","children":[["$","$Lc",null,{"summaries":[{"metadata":{"summarizer":"azure-ai","model":"DeepSeek-R1"},"children":[["$","p","p-0",{"children":"作者在尝试将Wakapi项目迁移至SQL Server时，遇到一系列数据库适配问题。包括SQL语法差异、ORM框架配置、外键约束冲突及GORM库的Upsert功能缺陷。通过修改原生SQL语句、动态调整时间字段类型映射、重构外键关系、手动处理唯一索引冲突，最终解决兼容性问题并成功合并代码。此次实践深入了解了SQL Server特性与GORM内部机制，验证了通过实际项目攻坚学习技术的有效性。"}]]},{"metadata":{"summarizer":"ollama","model":"deepseek-r1:8b"},"children":[["$","p","p-0",{"children":"在解决这个问题时，我逐步发现了许多关于 SQL Server 和 GORM 的细节，并通过手动处理重复插入的问题，最终完成了任务。尽管遇到了一些挑战，但过程让我对 Go 语言和开源项目贡献有了更深的理解。"}],"\n",["$","p","p-1",{"children":["$","strong","strong-0",{"children":"主要步骤："}]}],"\n",["$","ol","ol-0",{"children":["\n",["$","li","li-0",{"children":[["$","strong","strong-0",{"children":"问题识别"}],"：在尝试使用 GORM 插入数据时，遇到了重复主键错误。"]}],"\n",["$","li","li-1",{"children":[["$","strong","strong-0",{"children":"调试与分析"}],"：通过调试工具追踪到 GORM 的 SQL Server 适配器，发现了可能的 bug。"]}],"\n",["$","li","li-2",{"children":[["$","strong","strong-0",{"children":"手动处理"}],"：在没有修复适配器的情况下，选择手动逐个插入数据，跳过重复的记录。"]}],"\n",["$","li","li-3",{"children":[["$","strong","strong-0",{"children":"学习与反思"}],"：深入了解了 Go 语言的明确性和错误处理机制，同时也认识到 SQL Server 的特性。"]}],"\n"]}],"\n",["$","p","p-2",{"children":"通过这次经历，我不仅解决了问题，还提升了对开发工具和开源项目贡献的理解。最终，我的Pull Request得到了合并，这让我感到成就感和满足。"}],"\n",["$","p","p-3",{"children":["$","strong","strong-0",{"children":"结果："}]}],"\n",["$","ul","ul-0",{"children":["\n",["$","li","li-0",{"children":[["$","strong","strong-0",{"children":"问题解决"}],"：成功将数据插入 SQL Server，无重复记录错误。"]}],"\n",["$","li","li-1",{"children":[["$","strong","strong-0",{"children":"技能提升"}],"：加深了对 Go 语言和 GORM 的理解，掌握了调试技巧。"]}],"\n",["$","li","li-2",{"children":[["$","strong","strong-0",{"children":"贡献体验"}],"：第一次在大型开源项目中参与问题解决，增强了解决问题的信心。"]}],"\n"]}],"\n",["$","p","p-4",{"children":"这次经历让我更加明确地认识到学习的重要性，不管是技术上的还是工具使用方面，都需要持续探索和实践。"}]]}]}],["$","$Ld",null,{"withCaption":true,"id":"support-sqlserver-in-wakapi","children":[["$","h1","h1-0",{"id":"不就是调库嘛","children":[["$","a","不就是调库嘛",{"href":"#不就是调库嘛","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$e","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"不就是调库嘛……"]}],"\n",["$","p","p-0",{"children":["在",["$","a","a-0",{"href":"/articles/added-blog-page-click-monitoring","children":"上一篇文章"}],"中，我给博客增加了点击量监测，并将这个服务部署到了Azure，数据库采用了使用SQL Server的Azure的SQL服务。由于SQL Server有免费的订阅，微软的Azure Data Studio也还算好用，于是我觉得可以重用一下刚才学习的这个技能，将其他的服务也使用SQL Server部署。"]}],"\n","$Lf","\n","$L10","\n","$L11","\n","$L12","\n","$L13","\n","$L14","\n","$L15","\n","$L16","\n","$L17","\n","$L18","\n","$L19","\n","$L1a","\n","$L1b","\n","$L1c","\n","$L1d","\n","$L1e","\n","$L1f","\n","$L20","\n","$L21","\n","$L22","\n","$L23","\n","$L24","\n","$L25","\n","$L26","\n","$L27","\n","$L28","\n","$L29","\n","$L2a","\n","$L2b","\n","$L2c","\n","$L2d","\n","$L2e","\n","$L2f","\n","$L30","\n","$L31","\n","$L32","\n","$L33","\n","$L34","\n","$L35","\n","$L36","\n","$L37","\n","$L38","\n","$L39","\n","$L3a","\n","$L3b","\n","$L3c","\n","$L3d","\n","$L3e","\n","$L3f","\n","$L40","\n","$L41","\n","$L42","\n","$L43","\n","$L44","\n","$L45","\n","$L46","\n","$L47","\n","$L48","\n","$L49","\n","$L4a","\n","$L4b","\n","$L4c","\n","$L4d","\n","$L4e","\n","$L4f","\n","$L50","\n","$L51","\n","$L52","\n","$L53","\n","$L54","\n","$L55","\n","$L56","\n","$L57","\n","$L58","\n","$L59","\n","$L5a","\n","$L5b","\n","$L5c","\n","$L5d","\n","$L5e","\n","$L5f","\n","$L60","\n","$L61","\n","$L62","\n","$L63","\n","$L64","\n","$L65","\n","$L66","\n","$L67","\n","$L68","\n","$L69","\n","$L6a","\n","$L6b","\n","$L6c","\n","$L6d","\n","$L6e","\n","$L6f","\n","$L70","\n","$L71","\n","$L72","\n","$L73","\n","$L74","\n","$L75","\n","$L76","\n","$L77","\n","$L78","\n","$L79","\n","$L7a"]}]]}],"$L7b"]}]}],"$L7c","$L7d"]}]
5:["$","link","0",{"rel":"stylesheet","href":"/_next/static/chunks/44d2e091595b3eca.css","precedence":"next"}]
6:["$","link","1",{"rel":"stylesheet","href":"/_next/static/chunks/5e55d74f3211c796.css","precedence":"next"}]
7:["$","link","2",{"rel":"stylesheet","href":"/_next/static/chunks/b59bad6ea4f112f2.css","precedence":"next"}]
8:["$","script","script-0",{"src":"/_next/static/chunks/0a1497ca0a1721ad.js","async":true}]
9:["$","script","script-1",{"src":"/_next/static/chunks/4ec1bf7a32b70f87.js","async":true}]
a:["$","script","script-2",{"src":"/_next/static/chunks/276b22541034e0ea.js","async":true}]
b:["$","$L7e",null,{"children":["$","$7f",null,{"name":"Next.MetadataOutlet","children":"$@80"}]}]
f:["$","p","p-1",{"children":["我之前在用",["$","a","a-0",{"href":"https://wakatime.com/","children":"wakatime"}],"来记录我的编程的数据（例如每天的编程时间、所使用的编程语言等），但是wakatime免费用户只能保存14天的数据，而且wakatime没有提供官方的可自己部署的后端，所以我也一直在寻找wakatime的替代品。之前尝试使用了一段时间的",["$","a","a-1",{"href":"https://codetime.dev/","children":"codetime"}],"。这个软件的功能和wakatime类似，但是它当前只支持VSCode客户端，虽然免费保存数据，但是仍然没有提供可自己部署的后端。我在很早之前也尝试找过wakatime的后端替代品，但是当时并没有找到一个能用的。但前不久，同学给我推荐了",["$","a","a-2",{"href":"https://www.wakapi.com/","children":"wakapi"}],"项目，这个项目重新实现了wakatime的后端API，这样wakatime的丰富的客户端插件可以直接使用，并且完全可以自己部署，不用担心数据并存放在别人的服务器上。"]}]
10:["$","p","p-2",{"children":"它就是我一直寻找的wakatime替代品！"}]
11:["$","p","p-3",{"children":["很激动地浏览了一下项目，看到wakapi当时并没有原生支持SQL Server，但是在README中提到，wakatime使用了",["$","a","a-0",{"href":"https://gorm.io","children":"gorm"}],"作为数据库访问框架，而gorm本身是",["$","a","a-1",{"href":"https://github.com/go-gorm/sqlserver","children":"支持SQL Server"}],"的。"]}]
12:["$","p","p-4",{"children":["我想，既然库都支持了，SQL Server支持有什么难的？引入",["$","code","code-0",{"children":"gorm.io/sqlserver"}],"包，引入创建一个",["$","code","code-1",{"children":"Dialector"}],"，用gorm的API编写的绝大多数数据库操作就完成了。"]}]
13:["$","figure","figure-0",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"sqlserver"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#61AFEF"},"children":"Open"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":"mssqlConnectionString"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-6",{"style":{"color":"#E06C75"},"children":"c"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":"))"}]]}]}]}]}]
14:["$","p","p-5",{"children":"这有什么难的，开跑！结果遇到了一大堆报错。"}]
81:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z15:["$","h1","h1-1",{"id":"遇到并解决一个一个一个的问题","children":[["$","a","遇到并解决一个一个一个的问题",{"href":"#遇到并解决一个一个一个的问题","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$81","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"遇到并解决一个一个一个的问题"]}]
82:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z16:["$","h2","h2-0",{"id":"sql语句","children":[["$","a","sql语句",{"href":"#sql语句","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$82","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"SQL语句"]}]
17:["$","p","p-6",{"children":"仔细一看，这些报错主要是来自于数据库migration中的原生SQL语句和片段。"}]
18:["$","p","p-7",{"children":"程序启动的时候，会运行数据库migration脚本。随着软件开发更多的新功能，其使用的数据库的结构总会发生变化，而migration是指一些代码，这些代码的作用是修改数据库schema、让schema满足当前版本的要求。当软件功能越来越多，对数据库的变化也就越来越多，所以在一个成熟的软件中，你常常会看到有很多的数据库migration的代码。在程序启动的时候，这些migration将会被一个一个地执行，使得程序正式开始时，数据库的schema也更新到最新。"}]
19:["$","figure","figure-1",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"bash","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"bash","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"> tree migrations"}]}],"\n",["$","span","span-1",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"migrations"}]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"├──"}],["$","span","span-1",{"style":{"color":"#98C379"},"children":" 20201103_rename_language_mappings_table.go"}]]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"├──"}],["$","span","span-1",{"style":{"color":"#98C379"},"children":" 20201106_migration_cascade_constraints.go"}]]}],"\n",["$","span","span-4",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"├──"}],["$","span","span-1",{"style":{"color":"#98C379"},"children":" 20210202_fix_cascade_for_alias_user_constraint.go"}]]}],"\n",["$","span","span-5",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"├──"}],["$","span","span-1",{"style":{"color":"#98C379"},"children":" 20210206_drop_badges_column_add_sharing_flags.go"}]]}],"\n",["$","span","span-6",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"├──"}],["$","span","span-1",{"style":{"color":"#98C379"},"children":" 20210213_add_has_data_field.go"}]]}],"\n",["$","span","span-7",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"├──"}],["$","span","span-1",{"style":{"color":"#98C379"},"children":" 20210221_add_created_date_column.go"}]]}],"\n",["$","span","span-8",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"├──"}],["$","span","span-1",{"style":{"color":"#98C379"},"children":" 20210411_add_imprint_content.go"}]]}],"\n",["$","span","span-9",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"├──"}],["$","span","span-1",{"style":{"color":"#98C379"},"children":" 20210411_drop_migrations_table.go"}]]}],"\n",["$","span","span-10",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"├──"}],["$","span","span-1",{"style":{"color":"#98C379"},"children":" 20210806_remove_persisted_project_labels.go"}]]}],"\n",["$","span","span-11",{"data-line":"","children":" "}]]}]}]}]
1a:["$","p","p-8",{"children":"而有的migration（尤其是自动生成的migration）很可能包含了一些原生SQL。同时，由于ORM是对数据库操作的抽象，而再强大的抽象也不如原生的SQL来得强大和方便，所以很多时候，开发者仍然会选择在一些地方使用原生SQL语句的片段或者语句来实现一些功能。虽然SQL本身是有标准的，但是各个数据库厂商实际上自己实现了很多新功能，很多时候我们本以为理所当然的功能，实际上并不在标准中，而是数据库厂商自己实现的，一旦手写SQL而没有意识到有的SQL实际上只在部分数据库中兼容，就可能会在不兼容的数据库中遇到问题。"}]
1b:["$","p","p-9",{"children":["举个例子，wakapi的某个版本需要在数据库的",["$","code","code-0",{"children":"users"}],"表中新增一个",["$","code","code-1",{"children":"has_data"}],"列，而对于已经存在的",["$","code","code-2",{"children":"users"}],"表中的数据，这个列需要被设置为",["$","code","code-3",{"children":"TRUE"}],"。代码中用于执行此次migration的代码使用如下SQL语句实现了这个功能："]}]
1c:["$","figure","figure-2",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"sql","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"sql","data-theme":"one-dark-pro","style":{"display":"grid"},"children":["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"UPDATE"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" users "}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"SET"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" has_data "}],["$","span","span-4",{"style":{"color":"#56B6C2"},"children":"="}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":" TRUE "}],["$","span","span-6",{"style":{"color":"#C678DD"},"children":"WHERE"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":" TRUE;"}]]}]}]}]}]
1d:["$","p","p-10",{"children":["看上去是个很简单的人畜无害的SQL语句，对吧？但是这个SQL语句在mssql中中是非法的，因为mssql中并没有",["$","code","code-0",{"children":"TRUE"}],", ",["$","code","code-1",{"children":"FALSE"}],"常量！sqlserver中没有",["$","code","code-2",{"children":"boolean"}],"类型，所有这些类型都是使用一个字节的",["$","code","code-3",{"children":"tinyint"}],"来表示的，而",["$","code","code-4",{"children":"TRUE"}],"和",["$","code","code-5",{"children":"FALSE"}],"就对应使用",["$","code","code-6",{"children":"1"}],"和",["$","code","code-7",{"children":"0"}],"来表示。但是，",["$","code","code-8",{"children":"1"}],"和",["$","code","code-9",{"children":"0"}],"在sql server中并不是一个合法的",["$","code","code-10",{"children":"boolean"}],"表达式，所以它们并不能直接用在",["$","code","code-11",{"children":"WHERE"}],"中。所以，在MSSQL中，以上SQL语句就必须重新成以下的样子："]}]
1e:["$","figure","figure-3",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"sql","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"sql","data-theme":"one-dark-pro","style":{"display":"grid"},"children":["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"UPDATE"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" users "}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"SET"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" has_data "}],["$","span","span-4",{"style":{"color":"#56B6C2"},"children":"="}],["$","span","span-5",{"style":{"color":"#D19A66"},"children":" 1"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":";"}]]}]}]}]}]
83:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z1f:["$","h2","h2-1",{"id":"sql语句片段","children":[["$","a","sql语句片段",{"href":"#sql语句片段","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$83","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"SQL语句片段"]}]
20:["$","p","p-11",{"children":["另一个情况是",["$","strong","strong-0",{"children":"SQL语句片段"}],"。虽然ORM的一大作用就是将软件代码映射为SQL语句，减少我们手写SQL可能带来的错误，但是为了实现的灵活性，ORM常常同样也允许在自己的API中编写一些SQL的片段，而ORM会尝试将这些SQL片段嵌入进去。但是这些SQL片段可能也会有不兼容的情况！例如，下面的代码"]}]
21:["$","figure","figure-4",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"result"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" :="}],["$","span","span-2",{"style":{"color":"#E06C75"},"children":" db"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":"Table"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-6",{"style":{"color":"#98C379"},"children":"\"summaries AS s1\""}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":")."}]]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\t\t\tWhere"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#98C379"},"children":"\"s1.id IN ?\""}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-4",{"style":{"color":"#E06C75"},"children":"faultyIds"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":")."}]]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\t\t\tUpdate"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#98C379"},"children":"\"num_heartbeats\""}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-4",{"style":{"color":"#98C379"},"children":"\"3\""}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":")"}]]}]]}]}]}]
22:["$","p","p-12",{"children":["上述gorm数据库仓库将会被映射为类型以下的SQL语句。注意",["$","code","code-0",{"children":"Table"}],"和",["$","code","code-1",{"children":"Where"}],"方法的参数与下列SQL语句中对应的语句的对应关系。"]}]
23:["$","figure","figure-5",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"sql","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"sql","data-theme":"one-dark-pro","style":{"display":"grid"},"children":["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"update"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" summaries "}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"AS"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" s1 "}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":"set"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":" num_heartbeats "}],["$","span","span-6",{"style":{"color":"#56B6C2"},"children":"="}],["$","span","span-7",{"style":{"color":"#D19A66"},"children":" 3"}],["$","span","span-8",{"style":{"color":"#C678DD"},"children":" where"}],["$","span","span-9",{"style":{"color":"#D19A66"},"children":" s1"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-11",{"style":{"color":"#D19A66"},"children":"id"}],["$","span","span-12",{"style":{"color":"#C678DD"},"children":" IN"}],["$","span","span-13",{"style":{"color":"#ABB2BF"},"children":" ?"}]]}]}]}]}]
24:["$","p","p-13",{"children":["是不是感觉很简单？但是MSSQL仍然不支持！MSSQL不支持在",["$","code","code-0",{"children":"update"}],"持语句中给表新增一个别名，所以以上SQL语句中的",["$","code","code-1",{"children":"AS s1"}],"必须被去掉。"]}]
84:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z25:["$","h2","h2-2",{"id":"重用dialector的逻辑为关键词加上引号","children":[["$","a","重用dialector的逻辑为关键词加上引号",{"href":"#重用dialector的逻辑为关键词加上引号","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$84","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"重用Dialector的逻辑，为关键词加上引号"]}]
26:["$","p","p-14",{"children":"再看一个SQL语句片段："}]
27:["$","figure","figure-6",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"r"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#E06C75"},"children":"db"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":"Model"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-6",{"style":{"color":"#C678DD"},"children":"&"}],["$","span","span-7",{"style":{"color":"#E5C07B"},"children":"models"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-9",{"style":{"color":"#E5C07B"},"children":"User"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":"{})."}],["$","span","span-11",{"style":{"color":"#61AFEF"},"children":"Select"}],["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-13",{"style":{"color":"#98C379"},"children":"\"users.id as user, max(time) as time\""}],["$","span","span-14",{"style":{"color":"#ABB2BF"},"children":")."}]]}]}]}]}]
28:["$","p","p-15",{"children":"这段SQL语句一般会被映射为："}]
29:["$","figure","figure-7",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"sql","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"sql","data-theme":"one-dark-pro","style":{"display":"grid"},"children":["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"select"}],["$","span","span-1",{"style":{"color":"#D19A66"},"children":" users"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-3",{"style":{"color":"#D19A66"},"children":"id"}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":" as"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":" user, "}],["$","span","span-6",{"style":{"color":"#56B6C2"},"children":"max"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-8",{"style":{"color":"#C678DD"},"children":"time"}],["$","span","span-9",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-10",{"style":{"color":"#C678DD"},"children":"as"}],["$","span","span-11",{"style":{"color":"#C678DD"},"children":" time"}],["$","span","span-12",{"style":{"color":"#C678DD"},"children":" from"}],["$","span","span-13",{"style":{"color":"#ABB2BF"},"children":" users;"}]]}]}]}]}]
2a:["$","p","p-16",{"children":["有问题吗？有！",["$","code","code-0",{"children":"user"}],"在MSSQL中是关键词，要作为标识符使用必须使用",["$","code","code-1",{"children":"\"\""}],"或者",["$","code","code-2",{"children":"[]"}],"将它包裹起来！而",["$","code","code-3",{"children":"user"}],"在mysql等数据库引擎中都不是关键词，因此可以随意直接使用。"]}]
2b:["$","p","p-17",{"children":["这个将关键词作为字符串使用的过程实际上编程中很常见，被称为",["$","code","code-0",{"children":"escape"}],"，或者更简单的叫",["$","code","code-1",{"children":"quote"}],"，加引号。但是更坑的是，不同的SQL引擎所使用的加引号的方法不一样。MSSQL使用的是",["$","code","code-2",{"children":"\"\""}],"或者",["$","code","code-3",{"children":"[]"}],"，但是mysql使用的是`。如何通过一段代码来为不同的数据库加上正确的引号呢？"]}]
2c:["$","p","p-18",{"children":["其实，这个加引号的过程实在是非常常见，只要ORM需要将程序员所写的名字（表名、列名等）映射到SQL，那么就需要考虑给这些名字叫上引号，防止这些名字和SQL自己的关键词冲突。如果你写一个名字叫",["$","code","code-0",{"children":"select"}],"的表，没有这段逻辑，那么这个表就没法通过ORM来映射成SQL了！"]}]
2d:["$","p","p-19",{"children":"因此，根据Don't Repeat Yourself原则，ORM为数据库系统的适配器中肯定会有对应的逻辑。而我们与其自己编写这个处理逻辑，最好的方法当然是调用适配器中已经写好的逻辑了。"}]
2e:["$","p","p-20",{"children":["gorm使用",["$","code","code-0",{"children":"Dialector"}],"接口作为ORM支持不同数据库系统的适配器的接口，所有gorm支持的数据库都有一个对应的实现了",["$","code","code-1",{"children":"Dialector"}],"接口的",["$","code","code-2",{"children":"Dialector"}],"。所以，第一步就是去看看gorm的",["$","code","code-3",{"children":"Dialector"}],"里定义了哪些接口。"]}]
2f:["$","figure","figure-8",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/interfaces.go#L12C1-L21C2"}]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" Dialector"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" interface"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\tName"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"() "}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"string"}]]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\tInitialize"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"*"}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":"DB"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-5",{"style":{"color":"#C678DD"},"children":"error"}]]}],"\n",["$","span","span-4",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\tMigrator"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"db"}],["$","span","span-3",{"style":{"color":"#C678DD"},"children":" *"}],["$","span","span-4",{"style":{"color":"#E5C07B"},"children":"DB"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-6",{"style":{"color":"#E5C07B"},"children":"Migrator"}]]}],"\n",["$","span","span-5",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\tDataTypeOf"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"*"}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":"schema"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-5",{"style":{"color":"#E5C07B"},"children":"Field"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-7",{"style":{"color":"#C678DD"},"children":"string"}]]}],"\n",["$","span","span-6",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\tDefaultValueOf"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"*"}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":"schema"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-5",{"style":{"color":"#E5C07B"},"children":"Field"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-7",{"style":{"color":"#E5C07B"},"children":"clause"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-9",{"style":{"color":"#E5C07B"},"children":"Expression"}]]}],"\n",["$","span","span-7",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\tBindVarTo"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"writer"}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":" clause"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-5",{"style":{"color":"#E5C07B"},"children":"Writer"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-7",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"stmt"}],["$","span","span-8",{"style":{"color":"#C678DD"},"children":" *"}],["$","span","span-9",{"style":{"color":"#E5C07B"},"children":"Statement"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-11",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"v"}],["$","span","span-12",{"style":{"color":"#C678DD"},"children":" interface"}],["$","span","span-13",{"style":{"color":"#ABB2BF"},"children":"{})"}]]}],"\n",["$","span","span-8",{"data-line":"","data-highlighted-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\tQuoteTo"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":"clause"}],"$L85","$L86","$L87","$L88","$L89"]}],"\n","$L8a","\n","$L8b"]}]}]}]
30:["$","p","p-21",{"children":["从名字判断，这个",["$","code","code-0",{"children":"QuoteTo"}],"方法似乎就是我们要的接口。再随便点开一个dialector实现的代码浏览一下，就能确定，",["$","code","code-1",{"children":"QuoteTo"}],"就是加引号的方法。"]}]
31:["$","p","p-22",{"children":["可是这个方法看上去和我们想象中的不太一样：我们预期这个功能是一个",["$","code","code-0",{"children":"(string) => string"}],"的函数，这里怎么是一个",["$","code","code-1",{"children":"(clause.Writer, string) => void"}],"的函数，这个",["$","code","code-2",{"children":"clause.Writer"}],"是什么玩意？"]}]
32:["$","p","p-23",{"children":["由于拼接SQL说到底，就是要生成各个SQL的片段，然后将这些片段的字符串拼接起来。在绝大多数编程语言里，",["$","code","code-0",{"children":"string"}],"都是不可变的，所以拼接字符串实际上是创建了第三个字符串，然后把两个字符串的内容复制进去。这个过程如果进行太多次，就非常浪费时间和内存。所以编程语言常常会提供一个",["$","strong","strong-0",{"children":"组装字符串的工具类"}],"。这个工具类可以理解成是一个",["$","strong","strong-1",{"children":"可变"}],"的字符串，你可以直接在这个_字符串_的后面增加新的字符串，而不需要每次操作都创建一个全新的字符串对象。而这个",["$","code","code-1",{"children":"Writer"}],"接口，就是gorm定义的一个这样的能够",["$","strong","strong-2",{"children":"组装字符串的工具类"}],"所需要实现的接口。这个",["$","code","code-2",{"children":"Writer"}],"接口定义如下："]}]
33:["$","figure","figure-9",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/clause/clause.go#L13"}]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" Writer"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" interface"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\tWriteByte"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"byte"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":"error"}]]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\tWriteString"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"string"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":") ("}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":"int"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-6",{"style":{"color":"#C678DD"},"children":"error"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":")"}]]}],"\n",["$","span","span-4",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]]}]}]}]
34:["$","p","p-24",{"children":["很简单，很直白：",["$","code","code-0",{"children":"WriteByte"}],"：在后面增加一个字符；",["$","code","code-1",{"children":"WriteString"}],"，在后面增加一个字符串。"]}]
35:["$","p","p-25",{"children":["熟悉Go的同学可能会说了：啊，这个接口看上去非常熟悉，原生的",["$","code","code-0",{"children":"strings.Builder"}],"就是用来做这个事情的，而且也有这两个方法！是不是可以直接用一个",["$","code","code-1",{"children":"strings.Builder"}],"来作为这个",["$","code","code-2",{"children":"clause.Writer"}],"？"]}]
36:["$","p","p-26",{"children":["正确！所以我们可以直接创建一个",["$","code","code-0",{"children":"*strings.Builder"}],"来作为",["$","code","code-1",{"children":"clause.Writer"}],"（用指针的原因是这个",["$","code","code-2",{"children":"strings.Builder"}],"的这两个成员方法是使用的指针接收者而不是值接收者，所以只有对应的指针类型才算实现了这个接口。具体关于指针接收者和值接收者的区别我们就不在这里介绍了，有兴趣的可以学习一下Go语言），并在调用后获取这个",["$","code","code-3",{"children":"builder"}],"最终的字符串，这样就直接调用了",["$","code","code-4",{"children":"dialector"}],"中实现了加引号逻辑。"]}]
37:["$","figure","figure-10",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"func"}],["$","span","span-1",{"style":{"color":"#61AFEF"},"children":" QuoteDbIdentifier"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-3",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"db"}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":" *"}],["$","span","span-5",{"style":{"color":"#E5C07B"},"children":"gorm"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-7",{"style":{"color":"#E5C07B"},"children":"DB"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-9",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"identifier"}],["$","span","span-10",{"style":{"color":"#C678DD"},"children":" string"}],["$","span","span-11",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-12",{"style":{"color":"#C678DD"},"children":"string"}],["$","span","span-13",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tbuilder"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" :="}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" &"}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":"strings"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-5",{"style":{"color":"#E5C07B"},"children":"Builder"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"{}"}]]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tdb"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#E06C75"},"children":"Dialector"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":"QuoteTo"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-6",{"style":{"color":"#E06C75"},"children":"builder"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-8",{"style":{"color":"#E06C75"},"children":"identifier"}],["$","span","span-9",{"style":{"color":"#ABB2BF"},"children":")"}]]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\treturn"}],["$","span","span-1",{"style":{"color":"#E06C75"},"children":" builder"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-3",{"style":{"color":"#61AFEF"},"children":"String"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"()"}]]}],"\n",["$","span","span-4",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]]}]}]}]
38:["$","p","p-27",{"children":"然后，我们将此函数用在所有需要在SQL片段中使用自定义的名字的地方，这样，我们就重用了dialector的逻辑，用同一套代码兼容了所有的数据库。"}]
39:["$","figure","figure-11",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"r"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#E06C75"},"children":"db"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":"Model"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-6",{"style":{"color":"#C678DD"},"children":"&"}],["$","span","span-7",{"style":{"color":"#E5C07B"},"children":"models"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-9",{"style":{"color":"#E5C07B"},"children":"User"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":"{})."}],["$","span","span-11",{"style":{"color":"#61AFEF"},"children":"Select"}],["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":"("}]]}],"\n",["$","span","span-1",{"data-line":"","data-highlighted-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"  fmt"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#61AFEF"},"children":"Sprintf"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-4",{"style":{"color":"#98C379"},"children":"\"users.id as "}],["$","span","span-5",{"style":{"color":"#D19A66"},"children":"%s"}],["$","span","span-6",{"style":{"color":"#98C379"},"children":", max(time) as time\""}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":"), "}],["$","span","span-8",{"style":{"color":"#E06C75"},"children":"utils"}],["$","span","span-9",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-10",{"style":{"color":"#61AFEF"},"children":"QuoteDbIndentifier"}],["$","span","span-11",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-12",{"style":{"color":"#E06C75"},"children":"r"}],["$","span","span-13",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-14",{"style":{"color":"#E06C75"},"children":"db"}],["$","span","span-15",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-16",{"style":{"color":"#98C379"},"children":"\"user\""}],["$","span","span-17",{"style":{"color":"#ABB2BF"},"children":")"}]]}],"\n",["$","span","span-2",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":")"}]}]]}]}]}]
8c:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z3a:["$","h2","h2-3",{"id":"重写不支持的功能","children":[["$","a","重写不支持的功能",{"href":"#重写不支持的功能","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$8c","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"重写不支持的功能"]}]
3b:["$","p","p-28",{"children":"而在进一步查找并修改原生SQL的语句中，我找到了一段如下的原生SQL语句，直接让我眼前一黑。"}]
3c:["$","figure","figure-12",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"sql","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"sql","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"with"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" projects "}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"as"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" ("}]]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\tselect"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" project, user_id, "}],["$","span","span-2",{"style":{"color":"#56B6C2"},"children":"min"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":"time"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-6",{"style":{"color":"#C678DD"},"children":"as"}],["$","span","span-7",{"style":{"color":"#C678DD"},"children":" first"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-9",{"style":{"color":"#56B6C2"},"children":"max"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-11",{"style":{"color":"#C678DD"},"children":"time"}],["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-13",{"style":{"color":"#C678DD"},"children":"as"}],["$","span","span-14",{"style":{"color":"#C678DD"},"children":" last"}],["$","span","span-15",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-16",{"style":{"color":"#56B6C2"},"children":"count"}],["$","span","span-17",{"style":{"color":"#ABB2BF"},"children":"(*) "}],["$","span","span-18",{"style":{"color":"#C678DD"},"children":"as"}],["$","span","span-19",{"style":{"color":"#ABB2BF"},"children":" cnt"}]]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\tfrom"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" heartbeats"}]]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\twhere"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" user_id "}],["$","span","span-2",{"style":{"color":"#56B6C2"},"children":"="}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" ? "}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":"and"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":" project "}],["$","span","span-6",{"style":{"color":"#56B6C2"},"children":"!="}],["$","span","span-7",{"style":{"color":"#98C379"},"children":" ''"}]]}],"\n",["$","span","span-4",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\tand"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":" time"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" between"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" ? "}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":"and"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":" ?"}]]}],"\n",["$","span","span-5",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\tand"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":" language"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" is not null"}],["$","span","span-3",{"style":{"color":"#C678DD"},"children":" and"}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":" language"}],["$","span","span-5",{"style":{"color":"#56B6C2"},"children":" !="}],["$","span","span-6",{"style":{"color":"#98C379"},"children":" ''"}],["$","span","span-7",{"style":{"color":"#C678DD"},"children":" and"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":" project "}],["$","span","span-9",{"style":{"color":"#56B6C2"},"children":"!="}],["$","span","span-10",{"style":{"color":"#98C379"},"children":" ''"}]]}],"\n",["$","span","span-6",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\tgroup by"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" project, user_id"}]]}],"\n",["$","span","span-7",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\torder by"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":" last"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" desc"}]]}],"\n",["$","span","span-8",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\tlimit"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" ? offset ? )"}]]}],"\n","$L8d","\n","$L8e","\n","$L8f","\n","$L90","\n","$L91"]}]}]}]
3d:["$","p","p-29",{"children":"这段SQL语句就这样赤裸裸地写在代码里。经过以上几个例子，是不是以为这个SQL在MSSQL中必定问题巨大，不重新写一份根本跑不起来？"}]
3e:["$","p","p-30",{"children":"我一开始也是这么想的。而我自己对SQL Server并没有那么熟悉，所以聪明的我，在给一些名字叫上引号后，直接把这段代码扔给了GitHub Copilot，让它帮我改成SQL Server能用的。反直觉的是，这段代码实际上问题没那么大："}]
3f:["$","p","p-31",{"children":["$","$L92","img-0",{"src":"/articles/asset/contents/20240117-support-sqlserver-in-wakapi/copilot.png","imageSize":{"height":1540,"width":1056},"imageProps":{"src":"./copilot.png","alt":"copilot的结果"}}]}]
40:["$","p","p-32",{"children":"具体来说，除了第三点去掉了不需要的引号后，有两个问题："}]
41:["$","ol","ol-0",{"children":["\n",["$","li","li-0",{"children":["不支持",["$","code","code-0",{"children":"join using"}],"，需要使用常规的",["$","code","code-1",{"children":"join on"}],"代替"]}],"\n",["$","li","li-1",{"children":["不支持",["$","code","code-0",{"children":"limit offset"}],"。查找了一下，mssql可以使用",["$","code","code-1",{"children":"offset ? ROWS fetch next ? rows only"}],"来代替，当然",["$","code","code-2",{"children":"limit"}],"和",["$","code","code-3",{"children":"offset"}],"的参数顺序是反过来的"]}],"\n"]}]
42:["$","p","p-33",{"children":"啊，原来这么简单！由于需要修改的地方并不多，于是我就简单的通过if判断，将其中SQL Server不兼容的部分修改为SQL Server兼容的SQL语句，这段SQL语句也就完成了。"}]
93:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z43:["$","h2","h2-4",{"id":"把同一个go类型在不同的数据库中映射为不同的列类型","children":[["$","a","把同一个go类型在不同的数据库中映射为不同的列类型",{"href":"#把同一个go类型在不同的数据库中映射为不同的列类型","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$93","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"把同一个go类型在不同的数据库中映射为不同的列类型"]}]
44:["$","p","p-34",{"children":"修改了这些SQL语句后，程序仍然运行不起来，仔细一看，报错如下："}]
45:["$","pre","pre-0",{"children":["$","code","code-0",{"children":"mssql: A table can only have one timestamp. Because table 'users' already has one, the column 'last_logged_in_at' cannot be added.\n"}]}]
46:["$","p","p-35",{"children":["简单翻译，一个表只能有一个类型为",["$","code","code-0",{"children":"timestamp"}],"的列，而",["$","code","code-1",{"children":"users"}],"中有多个列都是",["$","code","code-2",{"children":"timestamp"}],"的类型，所以SQL Server报错了。"]}]
47:["$","p","p-36",{"children":["去代码中一看，",["$","code","code-0",{"children":"users"}],"表对应的",["$","code","code-1",{"children":"User"}],"struct确实有好几个字段都通过",["$","a","a-0",{"href":"https://gorm.io/docs/models.html#Fields-Tags","children":"gorm的field tag功能"}],["$","code","code-2",{"children":"type:timestamp"}],"，确定了在数据库中这些列需要映射为",["$","code","code-3",{"children":"timestamp"}],"类型。"]}]
48:["$","figure","figure-13",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/user.go#L17"}]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" User"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" struct"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-2",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"  CreatedAt"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"           CustomTime"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":"  `gorm:\"type:"}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"timestamp"}]}],["$","span","span-3",{"style":{"color":"#98C379"},"children":"; default:CURRENT_TIMESTAMP\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`"}]]}],"\n",["$","span","span-4",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tLastLoggedInAt"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"      CustomTime"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":"  `gorm:\"type:"}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"timestamp"}]}],["$","span","span-3",{"style":{"color":"#98C379"},"children":"; default:CURRENT_TIMESTAMP\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`"}]]}],"\n",["$","span","span-5",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-6",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"  SubscribedUntil"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":"     *"}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":"CustomTime"}],["$","span","span-3",{"style":{"color":"#98C379"},"children":" `json:\"-\" gorm:\"type:"}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"timestamp"}]}],["$","span","span-4",{"style":{"color":"#98C379"},"children":"\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`"}]]}],"\n",["$","span","span-7",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tSubscriptionRenewal"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":" *"}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":"CustomTime"}],["$","span","span-3",{"style":{"color":"#98C379"},"children":" `json:\"-\" gorm:\"type:"}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"timestamp"}]}],["$","span","span-4",{"style":{"color":"#98C379"},"children":"\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`"}]]}],"\n",["$","span","span-8",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]]}]}]}]
49:["$","p","p-37",{"children":[["$","code","code-0",{"children":"timestamp"}],"有什么问题呢？MySQL不都是使用",["$","code","code-1",{"children":"timestamp"}],"来代表时间类型吗？去查找",["$","code","code-2",{"children":"sql server timestamp"}],"，我才发现，SQL Server里的",["$","code","code-3",{"children":"timestamp"}],"的含义和别的数据库中的含义不一样。在别的数据库中，",["$","code","code-4",{"children":"timestamp"}],"就是一个表示时间戳/时间点的类型，而根据",["$","a","a-0",{"href":"https://stackoverflow.com/a/12063938","children":"这个stackoverflow回答"}],"，",["$","code","code-5",{"children":"sql server"}],"中的",["$","code","code-6",{"children":"timestamp"}],"主要用于乐观锁的情况（具体不在这里阐述），只是用来标记本行上一次被修改的时间，所以每个表只能存在一个",["$","code","code-7",{"children":"timestamp"}],"的列。而在SQL Server中如果要表示一个时间戳，需要使用",["$","code","code-8",{"children":"datetimeoffset"}],"。"]}]
4a:["$","p","p-38",{"children":["所以现在问题就变成了：",["$","strong","strong-0",{"children":"如何将一个类型在不同的数据库中映射为不同的列的类型"}],"。"]}]
4b:["$","p","p-39",{"children":[["$","code","code-0",{"children":"type:timestamp"}],"这个tag肯定是不能用了，于是我们就需要查找有没有其他更动态的方法，可以自定义一个go字段映射到数据库中的类型。经过一番查找，我们找到了",["$","a","a-0",{"href":"https://gorm.io/docs/data_types.html#GormDataTypeInterface","children":"Customize Data Type"}],"功能。gorm允许定义一个自定义的",["$","code","code-1",{"children":"struct"}],"，并给这个",["$","code","code-2",{"children":"struct"}],"实现",["$","code","code-3",{"children":"GormDBDataTypeInterface"}],"接口，来返回这个类型的字段所真正对应的数据库类型。"]}]
4c:["$","figure","figure-14",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" GormDBDataTypeInterface"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" interface"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"  GormDBDataType"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"*"}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":"gorm"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-5",{"style":{"color":"#E5C07B"},"children":"DB"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-7",{"style":{"color":"#C678DD"},"children":"*"}],["$","span","span-8",{"style":{"color":"#E5C07B"},"children":"schema"}],["$","span","span-9",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-10",{"style":{"color":"#E5C07B"},"children":"Field"}],["$","span","span-11",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-12",{"style":{"color":"#C678DD"},"children":"string"}]]}],"\n",["$","span","span-2",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]]}]}]}]
4d:["$","p","p-40",{"children":["这个函数的第一个参数就是",["$","code","code-0",{"children":"gorm.DB"}],"对象，指向当前操作的数据库对象，可以获取到当前正在使用什么类型的",["$","code","code-1",{"children":"Dialector"}],"，我们就可以根据",["$","code","code-2",{"children":"Dialector"}],"类型，来输出对应的数据库列类型。另外，这个",["$","code","code-3",{"children":"CustomTime"}],"正好是代码中所定义的一个新的",["$","code","code-4",{"children":"struct"}],"，我们可以直接在",["$","code","code-5",{"children":"CustomTime"}],"上实现这个接口。"]}]
4e:["$","p","p-41",{"children":["看来比较简单，但是为了以防万一，我们再全局搜索一下",["$","code","code-0",{"children":"type:timestamp"}],"，看看有没有什么其他的用法。果然被我找到了！"]}]
4f:["$","figure","figure-15",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/heartbeat.go#L27"}]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" Heartbeat"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" struct"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-2",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"  Time"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"            CustomTime"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"time\" gorm:\"type:"}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"timestamp(3)"}]}],["$","span","span-3",{"style":{"color":"#98C379"},"children":"; index:idx_time; index:idx_time_user\" swaggertype:\"primitive,number\"`"}]]}],"\n",["$","span","span-4",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-5",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]]}]}]}]
50:["$","p","p-42",{"children":["这里用到了",["$","code","code-0",{"children":"timestamp(3)"}],"。根据",["$","a","a-0",{"href":"https://dev.mysql.com/doc/refman/8.0/en/fractional-seconds.html","children":"mysql的文档"}],"，",["$","code","code-1",{"children":"timestamp(n)"}],"中的",["$","code","code-2",{"children":"n"}],"是代表精确到秒后面的第几位浮点位，",["$","code","code-3",{"children":"3"}],"代表精确到毫秒，而",["$","code","code-4",{"children":"6"}],"代表精确到微秒。而SQL Server的",["$","code","code-5",{"children":"datetimeoffset"}],"也支持类似的标记（",["$","a","a-1",{"href":"https://learn.microsoft.com/en-us/sql/t-sql/data-types/datetimeoffset-transact-sql?view=sql-server-ver16","children":"文档"}],"），",["$","code","code-6",{"children":"datetimeoffset(n)"}],"中的",["$","code","code-7",{"children":"n"}],"也同样表示精确到秒后面的第几位浮点位。由于我们不能直接使用",["$","code","code-8",{"children":"type"}],"tag，但是我们还需要一个tag用来表示这个精确的位数（根据sql server的文档，将这个位数称为",["$","code","code-9",{"children":"scale"}],"），所以，我们可以定义一个全新的",["$","code","code-10",{"children":"timeScale"}],"的tag，其值就是",["$","code","code-11",{"children":"scale"}],"的值。而一个字段上具体有哪些tag，正好可以通过",["$","code","code-12",{"children":"GormDBDataType"}],"的第二个参数获取。"]}]
51:["$","p","p-43",{"children":["于是根据这个思路，我们实现了",["$","code","code-0",{"children":"CustomTime"}],"的",["$","code","code-1",{"children":"GormDBDataType"}],"方法："]}]
52:["$","figure","figure-16",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/shared.go#L44"}]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"func"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" ("}],["$","span","span-2",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"j "}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":"CustomTime"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-5",{"style":{"color":"#61AFEF"},"children":"GormDBDataType"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-7",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"db"}],["$","span","span-8",{"style":{"color":"#C678DD"},"children":" *"}],["$","span","span-9",{"style":{"color":"#E5C07B"},"children":"gorm"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-11",{"style":{"color":"#E5C07B"},"children":"DB"}],["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-13",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"field"}],["$","span","span-14",{"style":{"color":"#C678DD"},"children":" *"}],["$","span","span-15",{"style":{"color":"#E5C07B"},"children":"schema"}],["$","span","span-16",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-17",{"style":{"color":"#E5C07B"},"children":"Field"}],["$","span","span-18",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-19",{"style":{"color":"#C678DD"},"children":"string"}],["$","span","span-20",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-2",{"data-line":"","children":" "}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tt"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" :="}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" \"timestamp\""}]]}],"\n",["$","span","span-4",{"data-line":"","children":" "}],"\n",["$","span","span-5",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // 如果使用的是SQL Server Dialector，则将其类型设置为datetimeoffset"}]}],"\n",["$","span","span-6",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\tif"}],["$","span","span-1",{"style":{"color":"#E06C75"},"children":" db"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-3",{"style":{"color":"#E06C75"},"children":"Config"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-5",{"style":{"color":"#E06C75"},"children":"Dialector"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-7",{"style":{"color":"#61AFEF"},"children":"Name"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":"() "}],["$","span","span-9",{"style":{"color":"#56B6C2"},"children":"=="}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":" ("}],["$","span","span-11",{"style":{"color":"#E5C07B"},"children":"sqlserver"}],["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-13",{"style":{"color":"#E5C07B"},"children":"Dialector"}],["$","span","span-14",{"style":{"color":"#ABB2BF"},"children":"{})."}],["$","span","span-15",{"style":{"color":"#61AFEF"},"children":"Name"}],["$","span","span-16",{"style":{"color":"#ABB2BF"},"children":"() {"}]]}],"\n",["$","span","span-7",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\t\tt"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" ="}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" \"datetimeoffset\""}]]}],"\n",["$","span","span-8",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"\t}"}]}],"\n",["$","span","span-9",{"data-line":"","children":" "}],"\n",["$","span","span-10",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // 如果一个属性有TIMESCALE的tag，那么给类型后面增加(n)参数"}]}],"\n",["$","span","span-11",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // gorm将所有gorm下的tag的key转换成了全大写"}]}],"\n",["$","span","span-12",{"data-line":"","children":"$L94"}],"\n","$L95","\n","$L96","\n","$L97","\n","$L98","\n","$L99","\n","$L9a"]}]}]}]
53:["$","p","p-44",{"children":["同时，我们将所有的",["$","code","code-0",{"children":"timestamp"}],"都直接去掉，将",["$","code","code-1",{"children":"type:timestamp(n)"}],"修改为了",["$","code","code-2",{"children":"timeScale:n"}],"："]}]
54:["$","figure","figure-17",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/user.go#L17"}]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" User"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" struct"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-2",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"  CreatedAt"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"           CustomTime"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":"  `gorm:\"default:CURRENT_TIMESTAMP\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`"}]]}],"\n",["$","span","span-4",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"  LastLoggedInAt"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"      CustomTime"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":"  `gorm:\"default:CURRENT_TIMESTAMP\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`"}]]}],"\n",["$","span","span-5",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-6",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"  SubscribedUntil"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":"     *"}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":"CustomTime"}],["$","span","span-3",{"style":{"color":"#98C379"},"children":" `json:\"-\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`"}]]}],"\n",["$","span","span-7",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"  SubscriptionRenewal"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":" *"}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":"CustomTime"}],["$","span","span-3",{"style":{"color":"#98C379"},"children":" `json:\"-\" swaggertype:\"string\" format:\"date\" example:\"2006-01-02 15:04:05.000\"`"}]]}],"\n",["$","span","span-8",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}],"\n",["$","span","span-9",{"data-line":"","children":" "}],"\n",["$","span","span-10",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/heartbeat.go#L12"}]}],"\n",["$","span","span-11",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" Heartbeat"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" struct"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-12",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-13",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"  Time"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"            CustomTime"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"time\" gorm:\""}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"timeScale:3"}]}],["$","span","span-3",{"style":{"color":"#98C379"},"children":"; index:idx_time; index:idx_time_user\" swaggertype:\"primitive,number\"`"}]]}],"\n",["$","span","span-14",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-15",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]]}]}]}]
55:["$","p","p-45",{"children":"这样就解决了这个问题。"}]
9b:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z56:["$","h2","h2-5",{"id":"避免创建递归的级联修改外键约束","children":[["$","a","避免创建递归的级联修改外键约束",{"href":"#避免创建递归的级联修改外键约束","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$9b","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"避免创建递归的级联修改外键约束"]}]
57:["$","p","p-46",{"children":"没想到的是，到这里仍然无法启动程序。报错如下："}]
58:["$","figure","figure-18",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"{3}","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"{3}","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"children":"[2.938ms] [rows:0] CREATE TABLE \"summary_items\" (\"id\" bigint IDENTITY(1,1),\"summary_id\" bigint,\"type\" smallint,\"key\" nvarchar(255),\"total\" bigint,PRIMARY KEY (\"id\"),CONSTRAINT \"fk_summaries_editors\" FOREIGN KEY (\"summary_id\") REFERENCES \"summaries\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \"fk_summaries_operating_systems\" FOREIGN KEY (\"summary_id\") REFERENCES \"summaries\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \"fk_summaries_machines\" FOREIGN KEY (\"summary_id\") REFERENCES \"summaries\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \"fk_summaries_projects\" FOREIGN KEY (\"summary_id\") REFERENCES \"summaries\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE,CONSTRAINT \"fk_summaries_languages\" FOREIGN KEY (\"summary_id\") REFERENCES \"summaries\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE)"}]}],"\n",["$","span","span-1",{"data-line":"","children":["$","span","span-0",{"children":"2024-01-19T19:29:35.607826413+08:00 [ERROR] mssql: Could not create constraint or index. See previous errors."}]}],"\n",["$","span","span-2",{"data-line":"","children":["$","span","span-0",{"children":"panic: mssql: Could not create constraint or index. See previous errors."}]}]]}]}]}]
59:["$","p","p-47",{"children":[["$","code","code-0",{"children":"Could not create constraint or index. See previous errors."}],"这个等于什么都没说嘛，只知道创建一个外键约束或者索引的时候失败了，而其他的错误信息被gorm或者gorm的sqlserver dialector忽略了。还"]}]
5a:["$","p","p-48",{"children":"还好我能看到具体执行的SQL语句，所以我们可以把这段SQL语句手动输入到Azure Data Studio中，看看数据库引擎到底报了什么错误。"}]
5b:["$","p","p-49",{"children":["$","$L92","img-0",{"src":"/articles/asset/contents/20240117-support-sqlserver-in-wakapi/foreign-keys.png","imageSize":{"height":637,"width":1499},"imageProps":{"src":"./foreign-keys.png","alt":"通过Azure Data Studio查看具体的错误信息"}}]}]
5c:["$","blockquote","blockquote-0",{"children":["\n",["$","p","p-0",{"children":"Introducing FOREIGN KEY constraint 'fk_summaries_operating_systems' on table 'summary_items' may cause cycles or multiple cascade paths. Specify ON DELETE NO ACTION or ON UPDATE NO ACTION, or modify other FOREIGN KEY constraints."}],"\n"]}]
5d:["$","p","p-50",{"children":["看起来，是因为",["$","code","code-0",{"children":"fk_summaries_operating_systems"}],"这个级联的外键索引会造成级联递归（cycles）。和外键约束有关，而外键约束是通过gorm定义，所以我们先去看看代码里涉及这个外键约束的两个表的定义。"]}]
5e:["$","figure","figure-19",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/muety/wakapi/blob/fc483cc35cb06313da8231424d1d85b291655881/models/summary.go#L29"}]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" Summary"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" struct"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-2",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tProjects"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"         SummaryItems"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"projects\" gorm:\""}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"}]}],["$","span","span-3",{"style":{"color":"#98C379"},"children":"\"`"}]]}],"\n",["$","span","span-4",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tLanguages"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"        SummaryItems"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"languages\" gorm:\""}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"}]}],["$","span","span-3",{"style":{"color":"#98C379"},"children":"\"`"}]]}],"\n",["$","span","span-5",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tEditors"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"          SummaryItems"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"editors\" gorm:\""}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"}]}],["$","span","span-3",{"style":{"color":"#98C379"},"children":"\"`"}]]}],"\n",["$","span","span-6",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tOperatingSystems"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" SummaryItems"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"operating_systems\" gorm:\""}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"}]}],["$","span","span-3",{"style":{"color":"#98C379"},"children":"\"`"}]]}],"\n",["$","span","span-7",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tMachines"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"         SummaryItems"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"machines\" gorm:\""}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"}]}],["$","span","span-3",{"style":{"color":"#98C379"},"children":"\"`"}]]}],"\n",["$","span","span-8",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}],"\n",["$","span","span-9",{"data-line":"","children":" "}],"\n",["$","span","span-10",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" SummaryItems"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":" []"}],["$","span","span-3",{"style":{"color":"#C678DD"},"children":"*"}],["$","span","span-4",{"style":{"color":"#E5C07B"},"children":"SummaryItem"}]]}],"\n",["$","span","span-11",{"data-line":"","children":" "}],"\n",["$","span","span-12",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" SummaryItem"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" struct"}],"$L9c"]}],"\n","$L9d","\n","$L9e","\n","$L9f","\n","$La0"]}]}]}]
5f:["$","p","p-51",{"children":["也就是说，",["$","code","code-0",{"children":"Summary"}],"和",["$","code","code-1",{"children":"SummaryItem"}],"两个表是1:m的关系，这个关系映射到数据库中，也就是",["$","code","code-2",{"children":"SummaryItem"}],"表中有到",["$","code","code-3",{"children":"Summary"}],"的ID的外键",["$","code","code-4",{"children":"summary_id"}],"，而这个外键的约束则是通过",["$","code","code-5",{"children":"Summary"}],"表中的tag定义的。"]}]
60:["$","p","p-52",{"children":["转回头去看生成的SQL，生成的SQL里有",["$","strong","strong-0",{"children":"5"}],"个完全相同的外键（",["$","code","code-0",{"children":"fk_summaries_editors"}],", ",["$","code","code-1",{"children":"fk_summaries_operating_systems"}],"，",["$","code","code-2",{"children":"fk_summaries_machines"}],"，",["$","code","code-3",{"children":"fk_summaries_projects"}],"和",["$","code","code-4",{"children":"fk_summaries_languages"}],"）。由于这五个外键都是级联删除（",["$","code","code-5",{"children":"ON DELETE CASCADE"}],"）和级联更新（",["$","code","code-6",{"children":"ON UPDATE CASCADE"}],"），实际上确实是会存在一个级联递归：当一个",["$","code","code-7",{"children":"SummaryItem"}],"被删除，会造成其对应的",["$","code","code-8",{"children":"Summary"}],"被删除，而",["$","code","code-9",{"children":"Summary"}],"被删除可能会造成这个",["$","code","code-10",{"children":"SummaryItem"}],"也被删除。"]}]
61:["$","p","p-53",{"children":["那问题又来了，那为什么之前在MySQL、PostgresSQL等数据库里均正常呢？通过",["$","a","a-0",{"href":"https://stackoverflow.com/a/852047","children":"这篇Stack Overflow"}],"的回答，我们知道了这种问题在其他数据库中并不是问题：其他数据库会尝试解出一条级联路径出来。而SQL Server不会去尝试解，发现了这种循环，就会直接报错。"]}]
62:["$","p","p-54",{"children":["那如何解决这个问题呢？根据外键名和",["$","code","code-0",{"children":"Summary"}],"中的属性的对应关系，我们可以推测，这五个外键是",["$","code","code-1",{"children":"Summary"}],"中五个引用一一对应过来的。由于这五个外键实际上是一模一样的，只需要保留一个就可以了。所以，最终的解决方案是，只保留一个字段的外键tag，其他字段全部给一个",["$","code","code-2",{"children":"-"}],"的tag，让gorm不要为这些字段生成外键。"]}]
63:["$","figure","figure-20",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/summary.go#L30"}]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" Summary"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" struct"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tProjects"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" SummaryItems"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"projects\" gorm:\"constraint:OnUpdate:CASCADE,OnDelete:CASCADE\"`"}]]}],"\n",["$","span","span-3",{"data-line":"","children":" "}],"\n",["$","span","span-4",{"data-line":"","data-highlighted-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tLanguages"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"        SummaryItems"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"languages\" gorm:\"-\"`"}]]}],"\n",["$","span","span-5",{"data-line":"","data-highlighted-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tEditors"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"          SummaryItems"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"editors\" gorm:\"-\"`"}]]}],"\n",["$","span","span-6",{"data-line":"","data-highlighted-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tOperatingSystems"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" SummaryItems"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"operating_systems\" gorm:\"-\"`"}]]}],"\n",["$","span","span-7",{"data-line":"","data-highlighted-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tMachines"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"         SummaryItems"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":" `json:\"machines\" gorm:\"-\"`"}]]}],"\n",["$","span","span-8",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]]}]}]}]
a1:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z64:["$","h2","h2-6",{"id":"规避gorm-sqlserver的bug","children":[["$","a","规避gorm-sqlserver的bug",{"href":"#规避gorm-sqlserver的bug","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$a1","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"规避gorm sqlserver的bug"]}]
65:["$","p","p-55",{"children":["至此，系统终于能启动起来了，并且大多数功能已经可以正常使用了。而在代码审核过程中，作者还",["$","a","a-0",{"href":"https://github.com/muety/wakapi/pull/592#issuecomment-1892627154","children":"发现了一个问题"}],"：代码中有一个",["$","code","code-0",{"children":"Heartbeat"}],"表，它就是wakatime的客户端插件定期给服务器端发送的数据，其中包含了正在工作的项目、使用的编程语言等信息。而这个表中有一个字段为",["$","code","code-1",{"children":"Hash"}],"，这个字段的值根据其他信息算出来，并且有一个",["$","code","code-2",{"children":"unique index"}],"，通过这个字段，就避免给",["$","code","code-3",{"children":"Heartbeat"}],"表插入多个重复的数据。"]}]
66:["$","figure","figure-21",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/models/heartbeat.go#L13"}]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"type"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" Heartbeat"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" struct"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-2",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-3",{"data-line":"","data-highlighted-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tHash"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":"            string"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":"     `json:\"-\" gorm:\"type:varchar(17); uniqueIndex\"`"}]]}],"\n",["$","span","span-4",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-5",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]]}]}]}]
67:["$","p","p-56",{"children":["在插入的时候，作者使用了",["$","code","code-0",{"children":"ON CONFLICT DO NOTHING"}],"的语句，这个语句的作用就是，如果当插入一行的时候，发现有些行违反了某个",["$","code","code-1",{"children":"unique index"}],"的要求，则",["$","strong","strong-0",{"children":"忽略"}],"这个问题，不插入这一行，也不报错。这刚好非常适合插入有可能有重复的",["$","code","code-2",{"children":"Heartbeat"}],"的场景。"]}]
68:["$","figure","figure-22",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/repositories/heartbeat.go#L52"}]}],"\n",["$","span","span-1",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// 下述代码将会被映射为ON CONFLICT DO NOTHING"}]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"if"}],["$","span","span-1",{"style":{"color":"#E06C75"},"children":" err"}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":" :="}],["$","span","span-3",{"style":{"color":"#E06C75"},"children":" r"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-5",{"style":{"color":"#E06C75"},"children":"db"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"."}]]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"  Clauses"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":"clause"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-4",{"style":{"color":"#E5C07B"},"children":"OnConflict"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"{"}]]}],"\n",["$","span","span-4",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"    DoNothing"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":": "}],["$","span","span-2",{"style":{"color":"#D19A66"},"children":"true"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":","}]]}],"\n",["$","span","span-5",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"  })."}]}],"\n",["$","span","span-6",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"  Create"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"&"}],["$","span","span-3",{"style":{"color":"#E06C75"},"children":"heartbeats"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":")."}],["$","span","span-5",{"style":{"color":"#E06C75"},"children":"Error"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"; "}],["$","span","span-7",{"style":{"color":"#E06C75"},"children":"err"}],["$","span","span-8",{"style":{"color":"#56B6C2"},"children":" !="}],["$","span","span-9",{"style":{"color":"#D19A66"},"children":" nil"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-7",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"  return"}],["$","span","span-1",{"style":{"color":"#E06C75"},"children":" err"}]]}],"\n",["$","span","span-8",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}],"\n",["$","span","span-9",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"return"}],["$","span","span-1",{"style":{"color":"#D19A66"},"children":" nil"}]]}]]}]}]}]
69:["$","p","p-57",{"children":["这种行为被称为",["$","strong","strong-0",{"children":"插入或者更新"}],"，又被称为",["$","strong","strong-1",{"children":"Upsert"}],"（Update/Insert），其行为是一个简单的判断：如果一行已经存在，则更新这一行的内容；如果不存在，则插入这一行。而如何判断",["$","strong","strong-2",{"children":"一行是否存在"}],"呢？则是通过",["$","code","code-0",{"children":"unique index"}],"来判断。"]}]
6a:["$","p","p-58",{"children":["可是遗憾的是，SQL Server不支持",["$","code","code-0",{"children":"ON CONFLICT DO NOTHING"}],"。要想在SQL Server中模拟upsert的行为，",["$","a","a-0",{"href":"https://michaeljswart.com/2017/07/sql-server-upsert-patterns-and-antipatterns/","children":"有很多方式"}],"，一个比较常见的方法是使用",["$","code","code-1",{"children":"merge into"}],"语句。具体如何编写比较复杂，这里就不再具体讲解。"]}]
6b:["$","p","p-59",{"children":["由于这里是使用的gorm的API，并不是使用原生SQL语句，所以理论上来说，gorm是可以知道用户的意图，并根据不同的数据库生成行为相同的、但是兼容对应数据库的SQL语句的。根据",["$","a","a-0",{"href":"https://github.com/go-gorm/sqlserver/issues/47","children":"这个issue"}],"，gorm的SQL Server库确实在很早之前就尝试通过生成一段的SQL Server兼容的SQL语句来支持这个功能，在gorm的文档里也",["$","a","a-1",{"href":"https://gorm.io/docs/create.html#Upsert-x2F-On-Conflict","children":"提到了"}],"，",["$","code","code-0",{"children":"clause.OnConflict"}],"会根据不同的数据库生成不同的语句，而对于SQL Server，其对应生成的正好就是",["$","code","code-1",{"children":"MERGE INTO"}],"语句。"]}]
6c:["$","p","p-60",{"children":["但是，既然库都支持了，那为什么还会遇到这个错误呢？再次检查所实际执行的SQL，发现这一次",["$","code","code-0",{"children":"Create"}],"实际上生成的SQL语句仍然是最普通的",["$","code","code-1",{"children":"INSERT INTO"}],"，并没有不是正确的",["$","code","code-2",{"children":"MERGE INTO"}],"，。"]}]
6d:["$","figure","figure-23",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"SQL","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"SQL","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"children":"024/01/19 20:10:23 /home/ddadaal/Code/wakapi/repositories/heartbeat.go:54 mssql: Cannot insert duplicate key row in object 'dbo.heartbeats' with unique index 'idx_heartbeats_hash'. The duplicate key value is (d926be93ebcc4b6f)."}]}],"\n",["$","span","span-1",{"data-line":"","children":" "}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"children":"[10.830ms] [rows:0] "}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"children":"INSERT INTO"}]}],["$","span","span-1",{"children":" \"heartbeats\" (\"user_id\",\"entity\",\"type\",\"category\",\"project\",\"branch\",\"language\",\"is_write\",\"editor\",\"operating_system\",\"machine\",\"user_agent\",\"time\",\"hash\",\"origin\",\"origin_id\",\"created_at\") OUTPUT INSERTED.\"id\" VALUES ('ddadaal','/home/user1/dev/project1/main.go','file','','wakapi','','Go',1,'','','','curl/8.5.0','2024-01-16 02:16:18.954','d926be93ebcc4b6f','','','2024-01-19 20:10:23.378');"}]]}]]}]}]}]
6e:["$","p","p-61",{"children":["看来，要想弄明白这个问题，就得进到",["$","code","code-0",{"children":"gorm"}],"的源码里来查看问题出在哪里了。使用VSCode启动一个调试版本的程序，给上面的代码的位置打上断电，使用",["$","code","code-1",{"children":"curl"}],"连续插入两次同样的",["$","code","code-2",{"children":"Heartbeat"}],"，根据断点往内查找，当进入到gorm的sqlserver的适配器的时候的代码的时候，我们发现了一些端倪："]}]
6f:["$","p","p-62",{"children":["$","$L92","img-0",{"src":"/articles/asset/contents/20240117-support-sqlserver-in-wakapi/sqlserver-adapter.png","imageSize":{"height":1025,"width":2252},"imageProps":{"src":"./sqlserver-adapter.png","alt":"查找到可能出现bug的位置"}}]}]
70:["$","p","p-63",{"children":["当前，我们正在图中的",["$","code","code-0",{"children":"if hasConflict"}],"的位置，且",["$","code","code-1",{"children":"hasConflict"}],"当前为true。根据下面的一段代码，如果",["$","code","code-2",{"children":"hasConflict"}],"为",["$","code","code-3",{"children":"true"}],"的话，将会进入",["$","code","code-4",{"children":"MergeCreate"}],"函数，而这个函数即是一个在MySQL实现类似行为的SQL的语句的代码。但是，实际在橙色块结束后，",["$","code","code-5",{"children":"hasConflict"}],["$","strong","strong-0",{"children":["被改成了",["$","code","code-0",{"children":"false"}]]}],"，所以最终并没有进入",["$","code","code-6",{"children":"MergeCreate"}],"，最终的结果就是一个普通的",["$","code","code-7",{"children":"INSERT INTO"}]," SQL。那么也就是说，橙色这段代码就是罪魁祸首！"]}]
71:["$","p","p-64",{"children":["这段代码干了什么事情呢？简单来说，它会检查要插入的行中的各个列中有没有包含主键。如果没有设置主键，则将会把",["$","code","code-0",{"children":"hasConflict"}],"改为",["$","code","code-1",{"children":"false"}],"；而如何设置了主键，才会进入",["$","code","code-2",{"children":"MERGE INTO"}],"流程。回想前面，要想正确生成upsert行为，我们需要判断",["$","strong","strong-0",{"children":"一行是否存在"}],"。而很显然，这里的代码将",["$","strong","strong-1",{"children":"一行是否存在"}],"的判断标准等价为了主键是否存在，而忽略了其他具有的",["$","code","code-3",{"children":"unique index"}],"的列。"]}]
72:["$","p","p-65",{"children":["当然，其他人也发现了这个问题，gorm-sqlserver的仓库中也有",["$","a","a-0",{"href":"https://github.com/go-gorm/sqlserver/issues/100","children":"已经半年前打开的issue"}],"正好就是关于这个问题。而很遗憾，这个问题过了半年依然没有修复。"]}]
73:["$","p","p-66",{"children":["要想解决这个问题，有多种方法，而我最终选择了最简单粗暴的方法：不管！这个函数的目的是同时插入多个",["$","code","code-0",{"children":"Heartbeatt"}],"，那我们就手动一个一个插入，如果一个行插入失败了，我们简单判断一下，如果这个错误是因为hash重复造成了，那我们就不管了！检查了一下代码中调用这个方法的场景，其实大多数情况下都是只插入一行，所以这样写对性能造成的影响是可以接受的。"]}]
74:["$","figure","figure-24",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"go","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"go","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// https://github.com/muety/wakapi/blob/1ea64f0397e5ee109777b367e9bd907cfdd59bdb/repositories/heartbeat.go#L34"}]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"if"}],["$","span","span-1",{"style":{"color":"#E06C75"},"children":" r"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-3",{"style":{"color":"#E06C75"},"children":"db"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-5",{"style":{"color":"#E06C75"},"children":"Dialector"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-7",{"style":{"color":"#61AFEF"},"children":"Name"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":"() "}],["$","span","span-9",{"style":{"color":"#56B6C2"},"children":"=="}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":" ("}],["$","span","span-11",{"style":{"color":"#E5C07B"},"children":"sqlserver"}],["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-13",{"style":{"color":"#E5C07B"},"children":"Dialector"}],["$","span","span-14",{"style":{"color":"#ABB2BF"},"children":"{})."}],["$","span","span-15",{"style":{"color":"#61AFEF"},"children":"Name"}],["$","span","span-16",{"style":{"color":"#ABB2BF"},"children":"() {"}]]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"  for"}],["$","span","span-1",{"style":{"color":"#E06C75"},"children":" _"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-3",{"style":{"color":"#E06C75"},"children":"h"}],["$","span","span-4",{"style":{"color":"#E5C07B"},"children":" :="}],["$","span","span-5",{"style":{"color":"#C678DD"},"children":" range"}],["$","span","span-6",{"style":{"color":"#E06C75"},"children":" heartbeats"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"    err"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" :="}],["$","span","span-2",{"style":{"color":"#E06C75"},"children":" r"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-4",{"style":{"color":"#E06C75"},"children":"db"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-6",{"style":{"color":"#61AFEF"},"children":"Create"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-8",{"style":{"color":"#E06C75"},"children":"h"}],["$","span","span-9",{"style":{"color":"#ABB2BF"},"children":")."}],["$","span","span-10",{"style":{"color":"#E06C75"},"children":"Error"}]]}],"\n",["$","span","span-4",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"    if"}],["$","span","span-1",{"style":{"color":"#E06C75"},"children":" err"}],["$","span","span-2",{"style":{"color":"#56B6C2"},"children":" !="}],["$","span","span-3",{"style":{"color":"#D19A66"},"children":" nil"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-5",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"      if"}],["$","span","span-1",{"style":{"color":"#E06C75"},"children":" strings"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-3",{"style":{"color":"#61AFEF"},"children":"Contains"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-5",{"style":{"color":"#E06C75"},"children":"err"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-7",{"style":{"color":"#61AFEF"},"children":"Error"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":"(), "}],["$","span","span-9",{"style":{"color":"#98C379"},"children":"\"Cannot insert duplicate key row in object 'dbo.heartbeats' with unique index 'idx_heartbeats_hash'\""}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":") {"}]]}],"\n",["$","span","span-6",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"        // ignored"}]}],"\n",["$","span","span-7",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"      } "}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":"else"}],"$La2"]}],"\n","$La3","\n","$La4","\n","$La5","\n","$La6","\n","$La7","\n","$La8"]}]}]}]
a9:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z75:["$","h1","h1-2",{"id":"总算还是完成了","children":[["$","a","总算还是完成了",{"href":"#总算还是完成了","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$a9","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"总算还是完成了"]}]
76:["$","p","p-67",{"children":"终于，经过了一周的时间，本来以为只是一个简单的调库，结果却发现了这么多的问题。经过这个过程，之前连SQL Server用都没用过的我也知道了很多SQL Server的细节；之前没有接触过gorm，现在却连源代码都好好翻了一通。"}]
77:["$","p","p-68",{"children":["而关于go，虽然我一直不喜欢go的语法，觉得它太简单，类型系统太弱，很多代码都花在固定的模板代码上（比如",["$","code","code-0",{"children":"if err := nil"}],"），但是不得不承认的一点是，go确实非常的",["$","strong","strong-0",{"children":"explicit"}],"。没那么多乱七八糟的反射、运行时黑魔法，控制流非常清晰，想知道什么代码调用了一个方法，直接",["$","code","code-1",{"children":"Shift+F12"}],"就完事了，出来的结果不会多不会少；要想某个错误是在哪里处理的，跟着繁琐的错误处理代码总能找到。它确实缺少一些特性，但是它非常地工业化。"]}]
78:["$","p","p-69",{"children":"解决这些问题后，PR顺利合并进了主分支，成就感满满，这可能也是我第一个没那么简单的开源项目的贡献了。"}]
79:["$","p","p-70",{"children":["$","$L92","img-0",{"src":"/articles/asset/contents/20240117-support-sqlserver-in-wakapi/pr-merged.png","imageSize":{"height":1882,"width":2429},"imageProps":{"src":"./pr-merged.png","alt":"https://github.com/muety/wakapi/pull/592"}}]}]
7a:["$","p","p-71",{"children":"对我来说，设定一个目标是学习的最好的途径，在这次实践里再次得到了印证。"}]
7b:["$","div",null,{"className":"hidden lg:block lg:w-[25%]","children":["$","$Laa",null,{"toc":[{"depth":1,"value":"不就是调库嘛……","id":"不就是调库嘛"},{"depth":1,"value":"遇到并解决一个一个一个的问题","id":"遇到并解决一个一个一个的问题","children":[{"depth":2,"value":"SQL语句","id":"sql语句"},{"depth":2,"value":"SQL语句片段","id":"sql语句片段"},{"depth":2,"value":"重用Dialector的逻辑，为关键词加上引号","id":"重用dialector的逻辑为关键词加上引号"},{"depth":2,"value":"重写不支持的功能","id":"重写不支持的功能"},{"depth":2,"value":"把同一个go类型在不同的数据库中映射为不同的列类型","id":"把同一个go类型在不同的数据库中映射为不同的列类型"},{"depth":2,"value":"避免创建递归的级联修改外键约束","id":"避免创建递归的级联修改外键约束"},{"depth":2,"value":"规避gorm sqlserver的bug","id":"规避gorm-sqlserver的bug"}]},{"depth":1,"value":"总算还是完成了","id":"总算还是完成了"}],"hasSummary":true}]}]
7c:["$","div",null,{"className":"max-w-7xl mx-auto p-4","children":["$","$Lab",null,{"relatedArticles":[]}]}]
7d:["$","div",null,{"className":"max-w-7xl mx-auto p-4","children":["$","$Lac",null,{"articleId":"support-sqlserver-in-wakapi","articleTitle":"从调库到翻源代码：给wakapi增加SQL Server支持"}]}]
80:null
85:["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}]
86:["$","span","span-4",{"style":{"color":"#E5C07B"},"children":"Writer"}]
87:["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":", "}]
88:["$","span","span-6",{"style":{"color":"#C678DD"},"children":"string"}]
89:["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":")"}]
8a:["$","span","span-9",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"\tExplain"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"sql"}],["$","span","span-3",{"style":{"color":"#C678DD"},"children":" string"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-5",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"vars"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":" ..."}],["$","span","span-7",{"style":{"color":"#C678DD"},"children":"interface"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":"{}) "}],["$","span","span-9",{"style":{"color":"#C678DD"},"children":"string"}]]}]
8b:["$","span","span-10",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]
8d:["$","span","span-9",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"select distinct"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" project, "}],["$","span","span-2",{"style":{"color":"#56B6C2"},"children":"min"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":"first"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-6",{"style":{"color":"#C678DD"},"children":"as"}],["$","span","span-7",{"style":{"color":"#C678DD"},"children":" first"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-9",{"style":{"color":"#56B6C2"},"children":"min"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-11",{"style":{"color":"#C678DD"},"children":"last"}],["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-13",{"style":{"color":"#C678DD"},"children":"as"}],["$","span","span-14",{"style":{"color":"#C678DD"},"children":" last"}],["$","span","span-15",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-16",{"style":{"color":"#56B6C2"},"children":"min"}],["$","span","span-17",{"style":{"color":"#ABB2BF"},"children":"(cnt) "}],["$","span","span-18",{"style":{"color":"#C678DD"},"children":"as"}],["$","span","span-19",{"style":{"color":"#ABB2BF"},"children":" count, "}],["$","span","span-20",{"style":{"color":"#56B6C2"},"children":"first_value"}],["$","span","span-21",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-22",{"style":{"color":"#C678DD"},"children":"language"}],["$","span","span-23",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-24",{"style":{"color":"#C678DD"},"children":"over"}],["$","span","span-25",{"style":{"color":"#ABB2BF"},"children":" ("}],["$","span","span-26",{"style":{"color":"#C678DD"},"children":"partition"}],["$","span","span-27",{"style":{"color":"#C678DD"},"children":" by"}],["$","span","span-28",{"style":{"color":"#ABB2BF"},"children":" project "}],["$","span","span-29",{"style":{"color":"#C678DD"},"children":"order by"}],["$","span","span-30",{"style":{"color":"#56B6C2"},"children":" count"}],["$","span","span-31",{"style":{"color":"#ABB2BF"},"children":"(*) "}],["$","span","span-32",{"style":{"color":"#C678DD"},"children":"desc"}],["$","span","span-33",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-34",{"style":{"color":"#C678DD"},"children":"as"}],["$","span","span-35",{"style":{"color":"#ABB2BF"},"children":" top_language"}]]}]
8e:["$","span","span-10",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\tfrom"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" heartbeats"}]]}]
8f:["$","span","span-11",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\tinner join"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" projects "}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"using"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" (project, user_id)"}]]}]
90:["$","span","span-12",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\tgroup by"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" project, "}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":"language"}]]}]
91:["$","span","span-13",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\t\t\torder by"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":" last"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" desc"}]]}]
94:["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // 参考：https://github.com/go-gorm/gorm/blob/0123dd45094295fade41e13550cd305eb5e3a848/schema/utils.go#L35"}]
95:["$","span","span-13",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\tif"}],["$","span","span-1",{"style":{"color":"#E06C75"},"children":" scale"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-3",{"style":{"color":"#E06C75"},"children":"ok"}],["$","span","span-4",{"style":{"color":"#E5C07B"},"children":" :="}],["$","span","span-5",{"style":{"color":"#E06C75"},"children":" field"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-7",{"style":{"color":"#E06C75"},"children":"TagSettings"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":"["}],["$","span","span-9",{"style":{"color":"#98C379"},"children":"\"TIMESCALE\""}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":"]; "}],["$","span","span-11",{"style":{"color":"#E06C75"},"children":"ok"}],["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":" {"}]]}]
96:["$","span","span-14",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\t\tt"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" +="}],["$","span","span-2",{"style":{"color":"#E06C75"},"children":" fmt"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":"Sprintf"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-6",{"style":{"color":"#98C379"},"children":"\"("}],["$","span","span-7",{"style":{"color":"#D19A66"},"children":"%s"}],["$","span","span-8",{"style":{"color":"#98C379"},"children":")\""}],["$","span","span-9",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-10",{"style":{"color":"#E06C75"},"children":"scale"}],["$","span","span-11",{"style":{"color":"#ABB2BF"},"children":")"}]]}]
97:["$","span","span-15",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"\t}"}]}]
98:["$","span","span-16",{"data-line":"","children":" "}]
99:["$","span","span-17",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"\treturn"}],["$","span","span-1",{"style":{"color":"#E06C75"},"children":" t"}]]}]
9a:["$","span","span-18",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]
9c:["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" {"}]
9d:["$","span","span-13",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}]
9e:["$","span","span-14",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tSummary"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":"   *"}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":"Summary"}],["$","span","span-3",{"style":{"color":"#98C379"},"children":"      `json:\"-\" gorm:\"not null; "}],["$","mark","mark-0",{"data-highlighted-chars":"","children":["$","span","span-0",{"style":{"color":"#98C379"},"children":"constraint:OnUpdate:CASCADE,OnDelete:CASCADE"}]}],["$","span","span-4",{"style":{"color":"#98C379"},"children":"\"`"}]]}]
9f:["$","span","span-15",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"\tSummaryID"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":" uint"}],["$","span","span-2",{"style":{"color":"#98C379"},"children":"          `json:\"-\" gorm:\"size:32\"`"}]]}]
a0:["$","span","span-16",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]
a2:["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":" {"}]
a3:["$","span","span-8",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"        return"}],["$","span","span-1",{"style":{"color":"#E06C75"},"children":" err"}]]}]
a4:["$","span","span-9",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"      }"}]}]
a5:["$","span","span-10",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"    }"}]}]
a6:["$","span","span-11",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"  }"}]}]
a7:["$","span","span-12",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"  return"}],["$","span","span-1",{"style":{"color":"#D19A66"},"children":" nil"}]]}]
a8:["$","span","span-13",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]
