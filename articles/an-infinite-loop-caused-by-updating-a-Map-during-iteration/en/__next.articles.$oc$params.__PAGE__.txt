1:"$Sreact.fragment"
2:I[28979,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"ArticleFrontmatter"]
c:I[21753,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"ArticleSummarization"]
d:I[79817,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"Gallery"]
27:I[23491,["/_next/static/chunks/2caa33a942c5f527.js","/_next/static/chunks/59983278a34fd25c.js"],"OutletBoundary"]
28:"$Sreact.suspense"
2a:I[72053,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"ArticleImage"]
56:I[14620,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"ArticleToc"]
57:I[39182,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"RelatedArticles"]
58:I[42449,["/_next/static/chunks/8d29a04bcfe27c24.js","/_next/static/chunks/3dff3d4c63cf346e.js","/_next/static/chunks/b3af52d5d180873a.js","/_next/static/chunks/86b442c1397f7351.js","/_next/static/chunks/0a1497ca0a1721ad.js","/_next/static/chunks/4ec1bf7a32b70f87.js","/_next/static/chunks/276b22541034e0ea.js"],"CommentPanelWithCurrentLanguage"]
:HL["/_next/static/chunks/44d2e091595b3eca.css","style"]
:HL["/_next/static/chunks/5e55d74f3211c796.css","style"]
:HL["/_next/static/chunks/b59bad6ea4f112f2.css","style"]
3:T119f,
# The Problem

I accidently encountered a problem during the development of the 2.0 version of [simstate](/articles/simstate-and-why): During an iteration of a set of `observers` stored in a ES6 Map, which contained only one element, an infinite loop occurred.

![Loop that never ends](./loop-that-never-ends.png)

# Investigation

This problem confused me quite a lot. It had been confirmed that this Map had only one element and the element remained unchanged between and inside loops, and the all elements in `promises` array were the same.

![Only one element in the map](./only-one-element.png)

My first thought was **data race**. It might be true for other languages with real multi-threading capability, but this is JavaScript: it is single thread only, and so there would be no such concurrent related problems.

Using a function as the key of Map seemed weird for other programming languages, since most Map-like data structure (like `HashMap` in Java, `Dictionary` in C# and `unordered_map` in C++) requires the key to be hashable, and functions are not, at least in the surface. However, MDN clearly states that [any value (both objects and primitive values) may be used as a key](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map). The following code works well, which proves that functions, too, can be used as keys in a Map.

```js
const data = [];
const map = new Map();
function a() { console.log("a"); }
map.set(a, "123");
map.forEach((value, key) => key()); // a
```

# The Root of the Problem

After some investigation, **the call to observer** caught my eyes.

`observer()` will trigger the re-render of observer component and make the updated state available for end-user. To simplify implementation, every time the component is re-rendered, the component will **unsubscribe (delete an entry from a Map) to the stores it subscribes to**, and **re-subscribe (set an entry in a Map) during the render**.

StoreConsumer.tsx omitting some unrelated code

```tsx
export default class StoreConsumer extends React.Component<Props, State> {
  // ...
  instances = new Set<Store<any>>();

  // ...
  private unsubscribeAll() {
    this.instances.forEach((store) => {
      // highlight-next-line
      store.unsubscribe(this.update);
    });
  }

  useStore = <ST extends StoreType<any>>(storeType: ST, dep?: Dependency<ST>): InstanceType<ST> => {
    // ...
    // highlight-next-line
    store.subscribe(this.update, dep);
    // ...
  }

  render() {
    return (
      <SimstateContext.Consumer>
        {(map) => {
          // ...
          // highlight-next-line
          this.unsubscribeAll();
          this.instances.clear();
          return this.props.children({ useStore: this.useStore });
        }}
      </SimstateContext.Consumer>
    );
  }
}
```

Store.ts omitting unrelated code

```ts
subscribe(observer: Observer, dep?: Dependency) {
  // highlight-next-line
  this.observers.set(observer, { dep, shouldUpdate: getChecker(dep) });
}

unsubscribe(observer: Observer) {
  // highlight-next-line
  this.observers.delete(observer);
}
```

**The call to observer (`observer()`), happened during the iteration of the Map, alters the Map itself!**

This is a dangerous action. It has become a common sense not to do so in most programming languages, since it might cause unexpected behaviors, which is exactly what happened here.

In this case, when deleting an entry and re-add an entry during the iteration, even if they are the equal, the item will be **considered as a new item**, which results in an infinite loop.

You may reproduce the case with the following code snippet. Note that since it runs indefinitely, consider running the script in a CLI environment (instead of browser) where you can kill the process to end the execution with ease.

```js
const map = new Map();
function obs() { map.delete(obs); map.set(obs, 1); console.log("obs called"); }
map.set(obs, 1);
map.forEach((value, key) => key());
// endless "obs called"
```

# Conclusion

This is quite a simple problem, and the cause is also easy to understand for most programmers. However, it still confused me for quite a while. After it, I realized that some *bugs* might seem strange and difficult to debug, but it doesn't mean the cause is complicated: sometimes it is the **indirections** on top of all the root that adds to the difficulty. During debugging, it is a good way to track down the code execution flow, and in this process the cause may just reveal itself.
0:{"buildId":"ESk97D31DA-I63AA80yMz","rsc":["$","$1","c",{"children":[["$","article",null,{"children":[["$","div",null,{"className":"bg-neutral px-4 py-8","children":["$","div",null,{"className":"max-w-7xl mx-auto min-h-[256px] flex justify-center text-center text-neutral-content","children":["$","div",null,{"className":"flex flex-col justify-center animate-slide-up","children":[["$","h1",null,{"className":"text-4xl my-2","children":"An Infinite Loop Caused by Updating a Map during Iteration"}],["$","$L2",null,{"className":"justify-center","articleId":"an-infinite-loop-caused-by-updating-a-Map-during-iteration","info":{"content":"$3","title":"An Infinite Loop Caused by Updating a Map during Iteration","date":"2019-02-25 15:30","id":"an-infinite-loop-caused-by-updating-a-Map-during-iteration","lang":"en","tags":["JavaScript","web-frontend","problem-investigation"],"related":["simstate-and-why"],"wordCount":639,"readingTime":3.195,"filePath":"contents/20190225-an-infinite-loop-caused-by-updating-a-Map-during-iteration/en.md","summary":{"articleId":"an-infinite-loop-caused-by-updating-a-Map-during-iteration","lang":"en","hash":"e79ef8687b5ba5291871116771ecd622d0e734075bd69714cda200405486decf","summaries":[{"metadata":{"summarizer":"azure-ai","model":"DeepSeek-R1"},"summaries":["The author encountered an infinite loop in a Map iteration during Simstate 2.0 development. The loop occurred when iterating a Map storing React component observers. The root cause was modifying the Map during iteration: calling an observer triggered component re-renders, which unsubscribed (deleted) and resubscribed (re-added) the same function key within the loop. Though the key (function) remained identical, reinsertion during iteration caused the Map to treat it as new, perpetuating the loop. This behavior, dangerous in most languages, arises in JavaScript when altering a Map mid-iteration. The solution involved recognizing indirection-induced complexity and avoiding such mutations during iteration."],"startTime":"2025-02-14T13:27:35.546Z","endTime":"2025-02-14T13:28:00.337Z"},{"metadata":{"summarizer":"ollama","model":"deepseek-r1:8b"},"summaries":["In JavaScript, using a function as a key in a Map can lead to unexpected behavior. During iteration, if the observer modifies the Map (by deleting and re-adding itself), it creates an infinite loop even when only one element is present. This highlights the risks of modifying data structures during iteration."]}]}},"langVersions":["en"]}]]}]}]}],"$L4"]}],["$L5","$L6","$L7","$L8","$L9","$La"],"$Lb"]}],"loading":null,"isPartial":false}
e:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z4:["$","div",null,{"className":"animate-slide-up","children":[["$","div",null,{"className":"max-w-7xl mx-auto p-4","children":["$","div",null,{"className":"flex flex-row space-x-4","children":[["$","div",null,{"className":"prose max-w-full lg:w-[75%]","children":[["$","$Lc",null,{"summaries":[{"metadata":{"summarizer":"azure-ai","model":"DeepSeek-R1"},"children":[["$","p","p-0",{"children":"The author encountered an infinite loop in a Map iteration during Simstate 2.0 development. The loop occurred when iterating a Map storing React component observers. The root cause was modifying the Map during iteration: calling an observer triggered component re-renders, which unsubscribed (deleted) and resubscribed (re-added) the same function key within the loop. Though the key (function) remained identical, reinsertion during iteration caused the Map to treat it as new, perpetuating the loop. This behavior, dangerous in most languages, arises in JavaScript when altering a Map mid-iteration. The solution involved recognizing indirection-induced complexity and avoiding such mutations during iteration."}]]},{"metadata":{"summarizer":"ollama","model":"deepseek-r1:8b"},"children":[["$","p","p-0",{"children":"In JavaScript, using a function as a key in a Map can lead to unexpected behavior. During iteration, if the observer modifies the Map (by deleting and re-adding itself), it creates an infinite loop even when only one element is present. This highlights the risks of modifying data structures during iteration."}]]}]}],["$","$Ld",null,{"withCaption":true,"id":"an-infinite-loop-caused-by-updating-a-Map-during-iteration","children":[["$","h1","h1-0",{"id":"the-problem","children":[["$","a","the-problem",{"href":"#the-problem","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$e","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"The Problem"]}],"\n",["$","p","p-0",{"children":["I accidently encountered a problem during the development of the 2.0 version of ",["$","a","a-0",{"href":"/articles/simstate-and-why","children":"simstate"}],": During an iteration of a set of ",["$","code","code-0",{"children":"observers"}]," stored in a ES6 Map, which contained only one element, an infinite loop occurred."]}],"\n","$Lf","\n","$L10","\n","$L11","\n","$L12","\n","$L13","\n","$L14","\n","$L15","\n","$L16","\n","$L17","\n","$L18","\n","$L19","\n","$L1a","\n","$L1b","\n","$L1c","\n","$L1d","\n","$L1e","\n","$L1f","\n","$L20","\n","$L21","\n","$L22","\n","$L23"]}]]}],"$L24"]}]}],"$L25","$L26"]}]
5:["$","link","0",{"rel":"stylesheet","href":"/_next/static/chunks/44d2e091595b3eca.css","precedence":"next"}]
6:["$","link","1",{"rel":"stylesheet","href":"/_next/static/chunks/5e55d74f3211c796.css","precedence":"next"}]
7:["$","link","2",{"rel":"stylesheet","href":"/_next/static/chunks/b59bad6ea4f112f2.css","precedence":"next"}]
8:["$","script","script-0",{"src":"/_next/static/chunks/0a1497ca0a1721ad.js","async":true}]
9:["$","script","script-1",{"src":"/_next/static/chunks/4ec1bf7a32b70f87.js","async":true}]
a:["$","script","script-2",{"src":"/_next/static/chunks/276b22541034e0ea.js","async":true}]
b:["$","$L27",null,{"children":["$","$28",null,{"name":"Next.MetadataOutlet","children":"$@29"}]}]
f:["$","p","p-1",{"children":["$","$L2a","img-0",{"src":"/articles/asset/contents/20190225-an-infinite-loop-caused-by-updating-a-Map-during-iteration/loop-that-never-ends.png","imageSize":{"height":203,"width":823},"imageProps":{"src":"./loop-that-never-ends.png","alt":"Loop that never ends"}}]}]
2b:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z10:["$","h1","h1-1",{"id":"investigation","children":[["$","a","investigation",{"href":"#investigation","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$2b","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"Investigation"]}]
11:["$","p","p-2",{"children":["This problem confused me quite a lot. It had been confirmed that this Map had only one element and the element remained unchanged between and inside loops, and the all elements in ",["$","code","code-0",{"children":"promises"}]," array were the same."]}]
12:["$","p","p-3",{"children":["$","$L2a","img-0",{"src":"/articles/asset/contents/20190225-an-infinite-loop-caused-by-updating-a-Map-during-iteration/only-one-element.png","imageSize":{"height":70,"width":287},"imageProps":{"src":"./only-one-element.png","alt":"Only one element in the map"}}]}]
13:["$","p","p-4",{"children":["My first thought was ",["$","strong","strong-0",{"children":"data race"}],". It might be true for other languages with real multi-threading capability, but this is JavaScript: it is single thread only, and so there would be no such concurrent related problems."]}]
14:["$","p","p-5",{"children":["Using a function as the key of Map seemed weird for other programming languages, since most Map-like data structure (like ",["$","code","code-0",{"children":"HashMap"}]," in Java, ",["$","code","code-1",{"children":"Dictionary"}]," in C# and ",["$","code","code-2",{"children":"unordered_map"}]," in C++) requires the key to be hashable, and functions are not, at least in the surface. However, MDN clearly states that ",["$","a","a-0",{"href":"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map","children":"any value (both objects and primitive values) may be used as a key"}],". The following code works well, which proves that functions, too, can be used as keys in a Map."]}]
15:["$","figure","figure-0",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"js","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"js","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"const"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" data"}],["$","span","span-2",{"style":{"color":"#56B6C2"},"children":" ="}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":" [];"}]]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"const"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" map"}],["$","span","span-2",{"style":{"color":"#56B6C2"},"children":" ="}],["$","span","span-3",{"style":{"color":"#C678DD"},"children":" new"}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":" Map"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"();"}]]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"function"}],["$","span","span-1",{"style":{"color":"#61AFEF"},"children":" a"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":"() { "}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":"console"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-5",{"style":{"color":"#61AFEF"},"children":"log"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-7",{"style":{"color":"#98C379"},"children":"\"a\""}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":"); }"}]]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E5C07B"},"children":"map"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#61AFEF"},"children":"set"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-4",{"style":{"color":"#E06C75"},"children":"a"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-6",{"style":{"color":"#98C379"},"children":"\"123\""}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":");"}]]}],"\n",["$","span","span-4",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E5C07B"},"children":"map"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#61AFEF"},"children":"forEach"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"(("}],["$","span","span-4",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"value"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-6",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"key"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-8",{"style":{"color":"#C678DD"},"children":"=>"}],["$","span","span-9",{"style":{"color":"#61AFEF"},"children":" key"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":"()); "}],["$","span","span-11",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// a"}]]}]]}]}]}]
2c:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z16:["$","h1","h1-2",{"id":"the-root-of-the-problem","children":[["$","a","the-root-of-the-problem",{"href":"#the-root-of-the-problem","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$2c","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"The Root of the Problem"]}]
17:["$","p","p-6",{"children":["After some investigation, ",["$","strong","strong-0",{"children":"the call to observer"}]," caught my eyes."]}]
18:["$","p","p-7",{"children":[["$","code","code-0",{"children":"observer()"}]," will trigger the re-render of observer component and make the updated state available for end-user. To simplify implementation, every time the component is re-rendered, the component will ",["$","strong","strong-0",{"children":"unsubscribe (delete an entry from a Map) to the stores it subscribes to"}],", and ",["$","strong","strong-1",{"children":"re-subscribe (set an entry in a Map) during the render"}],"."]}]
19:["$","p","p-8",{"children":"StoreConsumer.tsx omitting some unrelated code"}]
1a:["$","figure","figure-1",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"tsx","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"tsx","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"export"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":" default"}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" class"}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":" StoreConsumer"}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":" extends"}],["$","span","span-5",{"style":{"color":"#E5C07B"},"children":" React"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-7",{"style":{"color":"#E5C07B"},"children":"Component"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":"<"}],["$","span","span-9",{"style":{"color":"#E5C07B"},"children":"Props"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-11",{"style":{"color":"#E5C07B"},"children":"State"}],["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":"> {"}]]}],"\n",["$","span","span-1",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E06C75"},"children":"  instances"}],["$","span","span-1",{"style":{"color":"#56B6C2"},"children":" ="}],["$","span","span-2",{"style":{"color":"#C678DD"},"children":" new"}],["$","span","span-3",{"style":{"color":"#61AFEF"},"children":" Set"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"<"}],["$","span","span-5",{"style":{"color":"#E5C07B"},"children":"Store"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"<"}],["$","span","span-7",{"style":{"color":"#E5C07B"},"children":"any"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":">>();"}]]}],"\n",["$","span","span-3",{"data-line":"","children":" "}],"\n",["$","span","span-4",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // ..."}]}],"\n",["$","span","span-5",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"  private"}],["$","span","span-1",{"style":{"color":"#61AFEF"},"children":" unsubscribeAll"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":"() {"}]]}],"\n",["$","span","span-6",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E5C07B"},"children":"    this"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":"instances"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":"forEach"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"(("}],["$","span","span-6",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"store"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-8",{"style":{"color":"#C678DD"},"children":"=>"}],["$","span","span-9",{"style":{"color":"#ABB2BF"},"children":" {"}]]}],"\n",["$","span","span-7",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"      // highlight-next-line"}]}],"\n",["$","span","span-8",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E5C07B"},"children":"      store"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#61AFEF"},"children":"unsubscribe"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-4",{"style":{"color":"#E5C07B"},"children":"this"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-6",{"style":{"color":"#E06C75"},"children":"update"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":");"}]]}],"\n",["$","span","span-9",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"    });"}]}],"\n",["$","span","span-10",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"  }"}]}],"\n",["$","span","span-11",{"data-line":"","children":" "}],"\n",["$","span","span-12",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"  useStore"}],["$","span","span-1",{"style":{"color":"#56B6C2"},"children":" ="}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":" <"}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":"ST"}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":" extends"}],["$","span","span-5",{"style":{"color":"#E5C07B"},"children":" StoreType"}],"$L2d","$L2e","$L2f","$L30","$L31","$L32","$L33","$L34","$L35","$L36","$L37","$L38","$L39","$L3a","$L3b","$L3c","$L3d","$L3e","$L3f","$L40"]}],"\n","$L41","\n","$L42","\n","$L43","\n","$L44","\n","$L45","\n","$L46","\n","$L47","\n","$L48","\n","$L49","\n","$L4a","\n","$L4b","\n","$L4c","\n","$L4d","\n","$L4e","\n","$L4f","\n","$L50","\n","$L51","\n","$L52","\n","$L53","\n","$L54"]}]}]}]
1b:["$","p","p-9",{"children":"Store.ts omitting unrelated code"}]
1c:["$","figure","figure-2",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"ts","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"ts","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"subscribe"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#E06C75"},"children":"observer"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":": "}],["$","span","span-4",{"style":{"color":"#E06C75"},"children":"Observer"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-6",{"style":{"color":"#E06C75"},"children":"dep"}],["$","span","span-7",{"style":{"color":"#C678DD"},"children":"?:"}],["$","span","span-8",{"style":{"color":"#E06C75"},"children":" Dependency"}],["$","span","span-9",{"style":{"color":"#ABB2BF"},"children":") {"}]]}],"\n",["$","span","span-1",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // highlight-next-line"}]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E5C07B"},"children":"  this"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":"observers"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":"set"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-6",{"style":{"color":"#E06C75"},"children":"observer"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":", { "}],["$","span","span-8",{"style":{"color":"#E06C75"},"children":"dep"}],["$","span","span-9",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-10",{"style":{"color":"#E06C75"},"children":"shouldUpdate"}],["$","span","span-11",{"style":{"color":"#ABB2BF"},"children":": "}],["$","span","span-12",{"style":{"color":"#61AFEF"},"children":"getChecker"}],["$","span","span-13",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-14",{"style":{"color":"#E06C75"},"children":"dep"}],["$","span","span-15",{"style":{"color":"#ABB2BF"},"children":") });"}]]}],"\n",["$","span","span-3",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}],"\n",["$","span","span-4",{"data-line":"","children":" "}],"\n",["$","span","span-5",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"unsubscribe"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#E06C75"},"children":"observer"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":": "}],["$","span","span-4",{"style":{"color":"#E06C75"},"children":"Observer"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":") {"}]]}],"\n",["$","span","span-6",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"  // highlight-next-line"}]}],"\n",["$","span","span-7",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E5C07B"},"children":"  this"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":"observers"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":"delete"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-6",{"style":{"color":"#E06C75"},"children":"observer"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":");"}]]}],"\n",["$","span","span-8",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]]}]}]}]
1d:["$","p","p-10",{"children":["$","strong","strong-0",{"children":["The call to observer (",["$","code","code-0",{"children":"observer()"}],"), happened during the iteration of the Map, alters the Map itself!"]}]}]
1e:["$","p","p-11",{"children":"This is a dangerous action. It has become a common sense not to do so in most programming languages, since it might cause unexpected behaviors, which is exactly what happened here."}]
1f:["$","p","p-12",{"children":["In this case, when deleting an entry and re-add an entry during the iteration, even if they are the equal, the item will be ",["$","strong","strong-0",{"children":"considered as a new item"}],", which results in an infinite loop."]}]
20:["$","p","p-13",{"children":"You may reproduce the case with the following code snippet. Note that since it runs indefinitely, consider running the script in a CLI environment (instead of browser) where you can kill the process to end the execution with ease."}]
21:["$","figure","figure-3",{"data-rehype-pretty-code-figure":"","children":["$","pre","pre-0",{"style":{"backgroundColor":"#282c34","color":"#abb2bf"},"tabIndex":0,"data-language":"js","data-theme":"one-dark-pro","children":["$","code","code-0",{"data-language":"js","data-theme":"one-dark-pro","style":{"display":"grid"},"children":[["$","span","span-0",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"const"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" map"}],["$","span","span-2",{"style":{"color":"#56B6C2"},"children":" ="}],["$","span","span-3",{"style":{"color":"#C678DD"},"children":" new"}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":" Map"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"();"}]]}],"\n",["$","span","span-1",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"function"}],["$","span","span-1",{"style":{"color":"#61AFEF"},"children":" obs"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":"() { "}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":"map"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-5",{"style":{"color":"#61AFEF"},"children":"delete"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-7",{"style":{"color":"#E06C75"},"children":"obs"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":"); "}],["$","span","span-9",{"style":{"color":"#E5C07B"},"children":"map"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-11",{"style":{"color":"#61AFEF"},"children":"set"}],["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-13",{"style":{"color":"#E06C75"},"children":"obs"}],["$","span","span-14",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-15",{"style":{"color":"#D19A66"},"children":"1"}],["$","span","span-16",{"style":{"color":"#ABB2BF"},"children":"); "}],["$","span","span-17",{"style":{"color":"#E5C07B"},"children":"console"}],["$","span","span-18",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-19",{"style":{"color":"#61AFEF"},"children":"log"}],["$","span","span-20",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-21",{"style":{"color":"#98C379"},"children":"\"obs called\""}],["$","span","span-22",{"style":{"color":"#ABB2BF"},"children":"); }"}]]}],"\n",["$","span","span-2",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E5C07B"},"children":"map"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#61AFEF"},"children":"set"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-4",{"style":{"color":"#E06C75"},"children":"obs"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-6",{"style":{"color":"#D19A66"},"children":"1"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":");"}]]}],"\n",["$","span","span-3",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E5C07B"},"children":"map"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#61AFEF"},"children":"forEach"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"(("}],["$","span","span-4",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"value"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-6",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"key"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-8",{"style":{"color":"#C678DD"},"children":"=>"}],["$","span","span-9",{"style":{"color":"#61AFEF"},"children":" key"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":"());"}]]}],"\n",["$","span","span-4",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"// endless \"obs called\""}]}]]}]}]}]
55:T4df,M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z22:["$","h1","h1-3",{"id":"conclusion","children":[["$","a","conclusion",{"href":"#conclusion","className":"mr-1","children":["$","svg",null,{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","viewBox":"0 0 512 512","className":"inline-block opacity-20 hover:opacity-60","children":["$undefined",[["$","path","0",{"d":"$55","children":[]}]]],"style":{},"height":16,"width":16,"xmlns":"http://www.w3.org/2000/svg"}]}],"Conclusion"]}]
23:["$","p","p-14",{"children":["This is quite a simple problem, and the cause is also easy to understand for most programmers. However, it still confused me for quite a while. After it, I realized that some ",["$","em","em-0",{"children":"bugs"}]," might seem strange and difficult to debug, but it doesn't mean the cause is complicated: sometimes it is the ",["$","strong","strong-0",{"children":"indirections"}]," on top of all the root that adds to the difficulty. During debugging, it is a good way to track down the code execution flow, and in this process the cause may just reveal itself."]}]
24:["$","div",null,{"className":"hidden lg:block lg:w-[25%]","children":["$","$L56",null,{"toc":[{"depth":1,"value":"The Problem","id":"the-problem"},{"depth":1,"value":"Investigation","id":"investigation"},{"depth":1,"value":"The Root of the Problem","id":"the-root-of-the-problem"},{"depth":1,"value":"Conclusion","id":"conclusion"}],"hasSummary":true}]}]
25:["$","div",null,{"className":"max-w-7xl mx-auto p-4","children":["$","$L57",null,{"relatedArticles":[{"id":"simstate-and-why","langVersions":[{"excerpt":"\n# What is it?\n\n[![npm](https://img.shields.io/npm/v/simstate.svg?style=flat-square)](https://www.np","lang":"en","time":"2019-02-14 23:50:00 UTC+8","title":"Simstate and Why"}]}]}]}]
26:["$","div",null,{"className":"max-w-7xl mx-auto p-4","children":["$","$L58",null,{"articleId":"an-infinite-loop-caused-by-updating-a-Map-during-iteration","articleTitle":"An Infinite Loop Caused by Updating a Map during Iteration"}]}]
29:null
2d:["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"<"}]
2e:["$","span","span-7",{"style":{"color":"#E5C07B"},"children":"any"}]
2f:["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":">>("}]
30:["$","span","span-9",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"storeType"}]
31:["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":": "}]
32:["$","span","span-11",{"style":{"color":"#E5C07B"},"children":"ST"}]
33:["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":", "}]
34:["$","span","span-13",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"dep"}]
35:["$","span","span-14",{"style":{"color":"#C678DD"},"children":"?"}]
36:["$","span","span-15",{"style":{"color":"#ABB2BF"},"children":": "}]
37:["$","span","span-16",{"style":{"color":"#E5C07B"},"children":"Dependency"}]
38:["$","span","span-17",{"style":{"color":"#ABB2BF"},"children":"<"}]
39:["$","span","span-18",{"style":{"color":"#E5C07B"},"children":"ST"}]
3a:["$","span","span-19",{"style":{"color":"#ABB2BF"},"children":">): "}]
3b:["$","span","span-20",{"style":{"color":"#E5C07B"},"children":"InstanceType"}]
3c:["$","span","span-21",{"style":{"color":"#ABB2BF"},"children":"<"}]
3d:["$","span","span-22",{"style":{"color":"#E5C07B"},"children":"ST"}]
3e:["$","span","span-23",{"style":{"color":"#ABB2BF"},"children":"> "}]
3f:["$","span","span-24",{"style":{"color":"#C678DD"},"children":"=>"}]
40:["$","span","span-25",{"style":{"color":"#ABB2BF"},"children":" {"}]
41:["$","span","span-13",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"    // ..."}]}]
42:["$","span","span-14",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"    // highlight-next-line"}]}]
43:["$","span","span-15",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E5C07B"},"children":"    store"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#61AFEF"},"children":"subscribe"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-4",{"style":{"color":"#E5C07B"},"children":"this"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-6",{"style":{"color":"#E06C75"},"children":"update"}],["$","span","span-7",{"style":{"color":"#ABB2BF"},"children":", "}],["$","span","span-8",{"style":{"color":"#E06C75"},"children":"dep"}],["$","span","span-9",{"style":{"color":"#ABB2BF"},"children":");"}]]}]
44:["$","span","span-16",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"    // ..."}]}]
45:["$","span","span-17",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"  }"}]}]
46:["$","span","span-18",{"data-line":"","children":" "}]
47:["$","span","span-19",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#61AFEF"},"children":"  render"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"() {"}]]}]
48:["$","span","span-20",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"    return"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":" ("}]]}]
49:["$","span","span-21",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"      <"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"SimstateContext.Consumer"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":">"}]]}]
4a:["$","span","span-22",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"        {"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"("}],["$","span","span-2",{"style":{"color":"#E06C75","fontStyle":"italic"},"children":"map"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":") "}],["$","span","span-4",{"style":{"color":"#C678DD"},"children":"=>"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":" {"}]]}]
4b:["$","span","span-23",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"          // ..."}]}]
4c:["$","span","span-24",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#7F848E","fontStyle":"italic"},"children":"          // highlight-next-line"}]}]
4d:["$","span","span-25",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E5C07B"},"children":"          this"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#61AFEF"},"children":"unsubscribeAll"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"();"}]]}]
4e:["$","span","span-26",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#E5C07B"},"children":"          this"}],["$","span","span-1",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-2",{"style":{"color":"#E5C07B"},"children":"instances"}],["$","span","span-3",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-4",{"style":{"color":"#61AFEF"},"children":"clear"}],["$","span","span-5",{"style":{"color":"#ABB2BF"},"children":"();"}]]}]
4f:["$","span","span-27",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#C678DD"},"children":"          return"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":" this"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-3",{"style":{"color":"#E5C07B"},"children":"props"}],["$","span","span-4",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-5",{"style":{"color":"#61AFEF"},"children":"children"}],["$","span","span-6",{"style":{"color":"#ABB2BF"},"children":"({ "}],["$","span","span-7",{"style":{"color":"#E06C75"},"children":"useStore"}],["$","span","span-8",{"style":{"color":"#ABB2BF"},"children":": "}],["$","span","span-9",{"style":{"color":"#E5C07B"},"children":"this"}],["$","span","span-10",{"style":{"color":"#ABB2BF"},"children":"."}],["$","span","span-11",{"style":{"color":"#E06C75"},"children":"useStore"}],["$","span","span-12",{"style":{"color":"#ABB2BF"},"children":" });"}]]}]
50:["$","span","span-28",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"        }"}],["$","span","span-1",{"style":{"color":"#C678DD"},"children":"}"}]]}]
51:["$","span","span-29",{"data-line":"","children":[["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"      </"}],["$","span","span-1",{"style":{"color":"#E5C07B"},"children":"SimstateContext.Consumer"}],["$","span","span-2",{"style":{"color":"#ABB2BF"},"children":">"}]]}]
52:["$","span","span-30",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"    );"}]}]
53:["$","span","span-31",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"  }"}]}]
54:["$","span","span-32",{"data-line":"","children":["$","span","span-0",{"style":{"color":"#ABB2BF"},"children":"}"}]}]
